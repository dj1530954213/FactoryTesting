# Rust 后端目录重构 & Mock 清理实施方案

> 本文档记录 2025-07-01 对 `src-tauri/src` 目录进行重构（DDD 分层落位）以及彻底移除 **Mock / 调试脚本** 的完整步骤、注意事项与回滚方案。**所有操作均在当前工作分支进行，不触碰其他分支！**

---
## 目标
1. 彻底消除 `services/` 目录的"多层混杂"问题，使代码严格落在 `domain/、application/、infrastructure/、interfaces/` 四层。
2. 删除所有 *Mock* 实现及调试用脚本，后续将重新编写测试。
3. 迁移 `bin/` 调试脚本至 `tools/`（归档保留），确保运行时代码路径纯净。

---
## 步骤总览
| 步骤 | 操作 | 说明 |
| ---- | ---- | ---- |
| 0 | `git switch -c refactor/ddd_restructure` | **已由用户完成**，后续所有 commit 均在该分支执行。 |
| 1 | 建立目标目录树 | `domain/ application/ infrastructure/ interfaces/tauri` |
| 2 | `git mv` 迁移源码文件 | `services/domain/* → domain/`，`services/application/* → application/`，`services/infrastructure/* → infrastructure/`，`commands/* → interfaces/tauri/`，`bin/* → tools/` |
| 3 | 删除 Mock & 测试代码 | `domain/services/mocks/`、`services/infrastructure/mock_*`、`src-tauri/src/tests/` 全部 `git rm` |
| 4 | 建立临时 **兼容层** `src-tauri/src/services.rs` | 使用 `pub mod` re-export 旧路径，保障现有 import 编译通过；后续可逐步移除。 |
| 5 | 修改 `lib.rs` 与各层 `mod.rs` | 重新 `pub mod` 指向四层；删除旧 `pub mod services;` |
| 6 | 更新 `infrastructure/di_container.rs` | 替换 `Mock*` 返回值 → 真实实现（SqliteOrmPersistenceService、ChannelStateManager 等）。 |
| 7 | `cargo check` 循环修正 | 每完成一批迁移立即编译，若因 import 失败则添加 re-export 或调整 use 路径。 |
| 8 | 提交 PR / Push | commit message: `refactor: restructure DDD layers; remove mocks` |

> ⚠️ **临时兼容层 (`services.rs`) 仅用于过渡，全部 import 最终必须替换为新路径后删除该文件。**

---
## 注意事项
1. **只操作当前分支**：任何 `git mv`, `git rm`, 或 commit 均不得离开 `refactor/ddd_restructure`。
2. **功能零改动原则**：本轮只动"文件路径 + import + DI 注入"，禁止修改业务逻辑实现。
3. **Mock 删除**：删除前请确保无生产代码依赖；若出现依赖，需引入真实实现或重构代码。
4. **DI 容器**：
   - `get_channel_state_manager` → `ChannelStateManager::new()`
   - `get_test_execution_engine` → `TestExecutionEngine::new()`
   - `get_event_publisher`     → `infrastructure::event_publisher::SimpleEventPublisher`
   - `get_batch_allocation_service` → `application::services::batch_allocation_service::BatchAllocationService`
5. **bin → tools**：迁移后脚本仍可能 import 旧路径，依赖兼容层可编过；若报错再单独修。
6. **前端不受影响**：Tauri command 模块名保持不变（路径在 Rust 侧移动，JS 侧无变动作）。

---
## 回滚方案
1. `git switch STEP_TWO`（或备份分支）即可回到重构前状态。
2. 如需在本分支撤销：`git reset --hard <起点 commit>`。

---
## 后续待办（非本轮范围）
- 全局替换 `crate::services::` → 新路径，删除 `services.rs` 兼容层。
- 在 `tests/` 重新编写 **单元测试 + 集成测试**（使用真实 Persistence / PLC mock by trait）。
- 前端 Angular 适配：若未来新增 REST/CLI 接口，请放置 `interfaces/rest` 或 `interfaces/cli`。
