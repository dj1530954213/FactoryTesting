# FAT_TEST项目第二阶段重构方案分析

## 📊 现状分析总结

基于对代码库的深入分析，FAT_TEST项目已经完成了从C# WPF到Rust + Angular + Tauri的基础架构迁移，但仍存在一些关键的技术债务和架构缺陷需要在第二阶段重构中解决。

### 🎯 项目成熟度现状

**✅ 已完成的核心功能 (约75%)**
- 完整的数据模型定义和sqlx实体映射
- 基础的PLC通信框架（主要是Modbus TCP）
- Angular前端组件架构和Tauri集成
- SQLite数据持久化和基础CRUD操作
- 测试批次管理和通道定义管理

**⚠️ 存在的技术债务和架构缺陷**
- 测试执行引擎的并发控制和错误恢复机制不完善
- PLC通信协议支持不全面（缺少Siemens S7和OPC UA）
- 状态管理器的事务性和一致性保证不足
- 前端实时状态更新和事件处理机制需要优化
- 缺少完整的测试报告生成和数据导出功能

### 🔍 关键技术难点识别

1. **并发测试管理复杂性**：当前的信号量控制机制过于简单，缺少任务优先级、资源分配和故障恢复
2. **状态一致性保证**：多个测试实例的状态变更缺少事务性保证，可能导致数据不一致
3. **PLC通信稳定性**：网络中断、超时重试、连接池管理等问题需要系统性解决
4. **前端性能优化**：大批量测试时的UI响应性和内存管理需要优化

## 🚀 第二阶段重构方向

### 核心重构目标
1. **增强系统稳定性**：完善错误处理、重试机制和故障恢复
2. **提升并发性能**：优化测试任务调度和资源管理
3. **完善业务功能**：补齐缺失的核心功能模块
4. **改善用户体验**：优化前端交互和实时反馈

### 重构优先级矩阵
- **P0 (关键)**: 测试执行引擎稳定性、状态管理一致性
- **P1 (重要)**: PLC通信协议扩展、并发控制优化
- **P2 (一般)**: 报告生成、前端性能优化
- **P3 (可选)**: 高级配置管理、监控告警

---

## ❓ 第二阶段重构决策问题清单

### 📋 A. 业务需求确认类问题

#### A1. 测试执行策略
**问题**: 在测试执行过程中，如果某个通道的硬点测试失败，系统应该如何处理该通道的后续报警测试？

**背景说明**: 当前代码中存在硬点测试失败后中止后续步骤的逻辑，但这可能不符合实际业务需求。

**选项**:
- **选项A**: 立即跳过所有后续测试，标记为失败
- **选项B**: 继续执行报警测试，但标记硬点测试失败
- **选项C**: 提供用户选择，支持两种模式

**您的选择**: [ ]

**补充说明**:

---

#### A2. 并发测试限制
**问题**: 系统的最大并发测试数量应该如何确定？

**背景说明**: 当前使用固定的信号量控制并发数，但实际生产环境中可能需要更灵活的策略。

**选项**:
- **选项A**: 固定配置（如最大20个并发）
- **选项B**: 根据PLC连接数动态调整
- **选项C**: 根据系统资源（CPU/内存）自适应调整

**您的选择**: [ ]

**补充说明**:

---

#### A3. 测试数据保留策略
**问题**: 测试历史数据的保留和清理策略是什么？

**背景说明**: 长期运行会产生大量测试数据，需要明确数据管理策略。

**具体问题**:
1. 需要保留多长时间的测试记录？
2. 是否需要自动归档和压缩功能？
3. 数据导出的格式要求（Excel、PDF、JSON等）？

**您的回答**:

---

#### A4. 故障恢复行为
**问题**: 当PLC通信中断后恢复时，正在执行的测试应该如何处理？

**背景说明**: 网络不稳定或PLC重启可能导致通信中断，需要定义恢复策略。

**选项**:
- **选项A**: 从中断点继续执行
- **选项B**: 重新开始整个测试序列
- **选项C**: 提供用户选择恢复方式

**您的选择**: [ ]

**补充说明**:

---

### 🔧 B. 技术选型决策类问题

#### B1. PLC通信协议实现
**问题**: 对于Siemens S7和OPC UA协议的支持，您倾向于哪种实现方式？

**背景说明**: 当前只实现了Modbus TCP，需要扩展其他协议支持。

**选项**:
- **选项A**: 使用现有的Rust crate（如s7comm、opcua）
- **选项B**: 通过FFI调用C/C++库
- **选项C**: 实现简化版本，仅支持基本功能

**您的选择**: [ ]

**补充说明**:

---

#### B2. 状态管理事务性
**问题**: 对于测试状态的事务性保证，您希望采用哪种方案？

**背景说明**: 当前状态管理缺少事务性保证，可能导致数据不一致。

**选项**:
- **选项A**: 使用SQLite事务包装所有状态变更
- **选项B**: 实现内存中的事务日志，定期持久化
- **选项C**: 使用消息队列确保状态变更的顺序性

**您的选择**: [ ]

**补充说明**:

---

#### B3. 前端状态同步机制
**问题**: 前端实时状态更新应该采用哪种技术方案？

**背景说明**: 当前前端状态更新可能存在延迟，影响用户体验。

**选项**:
- **选项A**: Tauri的事件系统（emit/listen）
- **选项B**: WebSocket长连接
- **选项C**: 定时轮询后端API

**您的选择**: [ ]

**补充说明**:

---

#### B4. 错误处理和日志记录
**问题**: 系统的错误处理和日志记录策略偏好是什么？

**背景说明**: 当前日志记录不够完善，需要建立统一的错误处理和日志策略。

**具体问题**:
1. 日志级别的详细程度（Debug/Info/Warn/Error）？
2. 是否需要结构化日志（JSON格式）？
3. 错误信息是否需要国际化支持？

**您的回答**:

---

### 🏗️ C. 架构设计细节类问题

#### C1. 测试任务调度器设计
**问题**: 测试任务调度器的架构设计偏好是什么？

**背景说明**: 当前的测试执行引擎缺少复杂的调度逻辑，需要增强任务管理能力。

**具体问题**:
1. 是否需要支持任务优先级？
2. 如何处理任务依赖关系（如某些测试必须按顺序执行）？
3. 是否需要支持任务暂停/恢复功能？

**您的回答**:

---

#### C2. 数据缓存策略
**问题**: 对于频繁访问的数据（如通道定义、测试配置），缓存策略是什么？

**背景说明**: 当前每次都从数据库查询，可能影响性能。

**选项**:
- **选项A**: 内存缓存 + 定期刷新
- **选项B**: Redis等外部缓存
- **选项C**: 数据库查询优化，不使用缓存

**您的选择**: [ ]

**补充说明**:

---

#### C3. 模块间通信方式
**问题**: 各个服务模块之间的通信方式偏好是什么？

**背景说明**: 当前使用直接的trait调用，但可能需要更灵活的通信机制。

**选项**:
- **选项A**: 直接的trait调用
- **选项B**: 消息传递（channel/actor模式）
- **选项C**: 事件驱动架构

**您的选择**: [ ]

**补充说明**:

---

#### C4. 配置管理架构
**问题**: 系统配置管理的架构设计要求是什么？

**背景说明**: 当前配置管理比较简单，需要增强配置的灵活性和可维护性。

**具体问题**:
1. 配置文件格式偏好（JSON/TOML/YAML）？
2. 是否需要支持运行时配置热更新？
3. 配置验证和默认值处理策略？

**您的回答**:

---

### ⏱️ D. 实施策略和优先级类问题

#### D1. 重构实施顺序
**问题**: 以下重构任务的优先级排序是什么？

**背景说明**: 需要确定重构的先后顺序，避免依赖冲突。

**任务列表**:
1. 完善测试执行引擎的错误处理
2. 扩展PLC通信协议支持
3. 优化前端性能和用户体验
4. 实现测试报告生成功能
5. 增强系统监控和告警

**您的优先级排序**:


---

#### D2. 向后兼容性要求
**问题**: 重构过程中的向后兼容性要求是什么？

**背景说明**: 需要确定重构对现有功能的影响程度。

**具体问题**:
1. 是否需要保持现有API接口不变？
2. 数据库schema变更的兼容性要求？
3. 配置文件格式的迁移策略？

**您的回答**:

---

#### D3. 测试策略
**问题**: 重构过程中的测试策略是什么？

**背景说明**: 需要确保重构质量和系统稳定性。

**具体问题**:
1. 单元测试覆盖率目标？
2. 是否需要集成测试和端到端测试？
3. 性能测试的基准和目标？

**您的回答**:


---

#### D4. 发布策略
**问题**: 重构完成后的发布和部署策略是什么？

**背景说明**: 需要确定发布方式和风险控制措施。

**具体问题**:
1. 是否需要支持灰度发布？
2. 回滚机制的要求？
3. 用户培训和文档更新的计划？

**您的回答**:

---

### 🔍 E. 性能和扩展性类问题

#### E1. 性能基准
**问题**: 系统性能的具体要求和基准是什么？

**背景说明**: 需要明确性能目标，指导优化方向。

**具体问题**:
1. 单个测试的平均执行时间目标？
2. 系统支持的最大通道数量？
3. 内存使用的限制？

**您的回答**:

---

#### E2. 扩展性设计
**问题**: 未来扩展性的考虑因素有哪些？

**背景说明**: 需要为未来的功能扩展预留设计空间。

**具体问题**:
1. 是否需要支持分布式部署？
2. 插件化架构的需求？
3. 多租户支持的可能性？

**您的回答**:

---

#### E3. 监控和诊断
**问题**: 系统监控和诊断功能的需求是什么？

**背景说明**: 需要建立完善的系统监控和问题诊断机制。

**具体问题**:
1. 需要监控哪些关键指标？
2. 是否需要性能分析和瓶颈诊断工具？
3. 健康检查和自动恢复机制的要求？

**您的回答**:

---

## 📝 后续步骤

请您按照上述问题清单提供具体的回答和偏好，我将基于您的回答制定详细的第二阶段重构实施方案，包括：

1. **详细的技术架构设计**
2. **分阶段的实施计划和时间表**
3. **风险评估和缓解策略**
4. **具体的代码重构指导**

您可以选择回答所有问题，或者先回答您认为最重要的几个类别，我们可以分批次进行讨论和规划。

---

## 📋 问题回答记录

### A. 业务需求确认类问题回答

**A1. 测试执行策略**:
关于测试执行策略我的详细解释如下：
测试总共分为硬点通道自动测试和上位机手动测试两部分，其中硬点通道自动测试需要自动开始当前选择批次的所有点位，且不论成功和失败都需要将整个测试流程自动跑完。当通道自动测试跑完之后显示结果。对于部分硬点通道测试失败的情况需要提供单硬点通道复测的功能。对于上位机手动测试部分是对于每个测试点位来说的，当这个点位的硬点通道测试通过之后才能开始进行手动测试环节否则必须将硬点通道测试通过之后才能进行。

**A2. 并发测试限制**:
关于系统的最大并发测试数量应该如何确定：
这个可以在PLC的通讯配置和测试PLC的通道配置的界面中增加一个系统配置清单，这个清单中主要就是配置：系统的最大并发数量、硬点通道自动测试中步骤与步骤的间隔时间等这些数据。并且这些配置也需要像PLC的通讯配置一样存入数据库中。具体的你可以参考重构项目中D:\GIT\Git\codeFactoryTesting\FactoryTesting的实现。

**A3. 测试数据保留策略**:
测试历史数据的保留和清理策略是什么：
我将从测试的全部过程来解释。首先用户导入点表(xlxs),系统解析并调用后台的批次分配逻辑(批次分配的核心逻辑需要参考D:\GIT\Git\codeFactoryTesting\FactoryTesting\src-tauri\src\services\channel_allocation_service.rs)。到这个阶段测试数据的实例集合就应该已经在D:\GIT\Git\codeFactoryTesting\FactoryTesting\src-tauri\src\services\domain\channel_state_manager.rs这个状态管理器中进行管理了。由状态管理器来维护实例的状态直到整个测试结束并关闭软件其生命周期才结束(对外暴露出操作状态的接口)。下一步开始硬点通道测试。当硬点通道测试结束时将整个集合的状态全部持久化到数据库中。并且每次硬点通道复测都需要更新这个点的状态到数据库中。下一步手动测试中当单点的手动测试状态更新为整体通过后也需要将这个点的状态更新到数据库中。

**A4. 故障恢复行为**:
关于当PLC通信中断后恢复时，正在执行的测试应该如何处理：
当PLC的通讯中断的时候就直接将当前正在进行硬点通道测试的批次中的点位全部重置，从而当通讯恢复的时候重新开始进行测试

### B. 技术选型决策类问题回答

**B1. PLC通信协议实现**:
关于对于Siemens S7和OPC UA协议的支持，您倾向于哪种实现方式：
目前为止只考虑ModbusTcp,并且我之前也写了一个简易的通讯库，并在重构的项目中进行了移植，只是还没有测试。通讯库的目录为  D:\GIT\Git\codeFactoryTesting\modbus通讯示例代码   在重构的项目中你也可以看到对应的实现。至于其他的协议只要规定好trait中的接口，后续再进行扩展就行。

**B2. 状态管理事务性**:
关于对于测试状态的事务性保证：
我觉得使用orm框架的事务即可，这个测试软件没有太多的数据一致性的问题。我需要特别提示一下。ORM框架我们使用的时sqlx

**B3. 前端状态同步机制**:
关于前端实时状态更新应该采用哪种技术方案：
我觉使用事件系统比较合适

**B4. 错误处理和日志记录**:
关于当前日志记录不够完善，需要建立统一的错误处理和日志策略：
1. 日志级别的详细程度（Debug/Info/Warn/Error）：需要满足Debug/Info/Warn/Error这几种类型
2. 是否需要结构化日志（JSON格式）：需要将日志存储在txt文件中
3. 错误信息是否需要国际化支持：不需要

### C. 架构设计细节类问题回答

**C1. 测试任务调度器设计**:
关于测试任务调度器的架构设计偏好是什么：
任务的调度器是按照并发数量进行并行测试的(只用于硬点通道测试)，不需要考虑顺序的问题。只是需要考虑关于硬点通道测试和单体硬点通道测试的调用接口的设计。并且也不需要考虑关于暂停恢复的问题。因为30秒内就测试完当前批次了

**C2. 数据缓存策略**:
关于对于频繁访问的数据（如通道定义、测试配置），缓存策略是什么：
由于之前我们说了测试数据的实例是存储在实例状态管理器中的。数据库中的数据只是用作备份使用。当需要恢复备份的时候才访问数据库取出对应的数据恢复上次的测试状态，所以我觉得不需要再引入其他的缓存技术。

**C3. 模块间通信方式**:
关于各个服务模块之间的通信方式偏好是什么：
这个需要你根据我们的项目整体情况来进行评估，需要考虑架构和解耦的问题，同时权衡实施难度的问题。

**C4. 配置管理架构**:
关于系统配置管理的架构设计要求是什么：
目前系统的配置需要存储在数据库中，对于需不需要热更新的问题。当用户在配置界面修改了数据时除了需要更新数据库也需要更新程序中对应实例的值(只限于系统配置和通讯配置，测试数据只做备份，在恢复的时候会调用特定的服务来做数据的重新实例化)。

### D. 实施策略和优先级类问题回答

**D1. 重构实施顺序**:
按照顺序需要
1. 参考现有的通道自动分配逻辑进行重构
2. 完善测试执行引擎的实现以及错误处理
3. 扩展ModbusTcp通讯协议的实现和测试
4. 完善手动测试环节的实现
5. 优化前端性能和用户体验
6. 实现测试报告生成功能
7. 增强系统监控和告警

**D2. 向后兼容性要求**:
对于影响我们重构的部分在考虑实施步骤的情况下偏重于架构的考虑。有影响的部分可以调整。同时我要说一下关于数据库表格的问题。我将原来的数据库结构与实际的点表都给你你需要参考来设计数据库的结构以及对应的数据模型，现在的数据模型中的字段是非常缺失的。数据库文件：D:\GIT\Git\codeFactoryTesting\Notes\ChannelMappings_202505301041.sql    点表文件转为json格式：D:\GIT\Git\codeFactoryTesting\测试文件\测试IO.csv

**D3. 测试策略**:
关于重构过程中的测试策略我的详细解释如下：
1. 单元测试覆盖率目标：单元测试覆盖率目标是90%，确保每个功能模块都有对应的单元测试用例。
2. 需要集成测试和端到端测试：需要集成测试和端到端测试，确保各个模块之间的集成和系统整体的稳定性。
3. 性能测试的基准和目标：性能测试的基准是当前系统的性能指标，目标是在重构后性能不劣化，最好有一定程度的提升。

**D4. 发布策略**:
这部分我不是特别关心，因为最后是打包成安装包在windows上使用
### E. 性能和扩展性类问题回答


**E1. 性能基准**:
关于系统性能的具体要求和基准是什么：
批次硬点通道测试时间控制在30秒内完成(但是具体的时间还是依赖于用户设置的步骤间隔时间)，但是对于前端的状态展示需要做到看不出延迟。内存方面不需要做太大的限制，合适就行
**E2. 扩展性设计**:
关于未来扩展性的考虑因素有哪些：
主要考虑手动测试部分增加测试项：比如还需要测试PLC中软点的测试项。
以及当前阶段就需要考虑关于模块跳过测试，通道跳过测试等特殊情况下的功能。
最后就是工控协议的支持
**E3. 监控和诊断**:
关于系统监控和诊断功能的需求是什么：
最主要的就是监控测试PLC和被测PLC的通讯状态。这个状态直接影响到测试的可靠性和连续性

---










## 🔍 针对回答的澄清问题

基于您的详细回答，我需要对以下几个关键点进行澄清，以确保实施方案的准确性：

### 📋 F. 业务流程澄清类问题

#### F1. 测试流程细节澄清
**问题**: 关于硬点通道自动测试和手动测试的具体流程，我需要确认以下细节：

1. **硬点通道自动测试**：
   - 您提到"不论成功和失败都需要将整个测试流程自动跑完"，这是指对于单个通道的所有子测试项（如硬点、低低报警、低报警等）都要执行完，还是指整个批次的所有通道都要测试完？
   - 单硬点通道复测功能是否只针对失败的通道，还是用户可以选择任意通道进行复测？

2. **手动测试前置条件**：
   - "当这个点位的硬点通道测试通过之后才能开始进行手动测试"，这里的"通过"是指硬点测试项通过，还是该通道的所有自动测试项都通过？

**您的澄清**:
1.关于硬点通道自动测试的相关问题：我说的是通道硬点自动测试的所有测试项都自动跑完。因为当用户点击硬点自动测试按钮后就应该调用测试任务管理器创建当前选中批次中所有点位的测试任务并并行执行。每个任务间互不干扰。对于测试项是指如下测试：
DI点位：测试PLC对应的DO通道输出，被测PLC是否显示已接通。测试PLC对应的DO通道停止输出，被测PLC是否显示已断开。
DO点位：被测PLC对应的DO通道输出，测试PLC是否显示已接通。被测PLC对应的DO通道停止输出，测试PLC是否显示已断开。
AI点位：测试PLC按照顺序输出量程的0%,25%,50%,75%,100%。被测PLC采集数值是否正确(偏差小于设定值)。
AO点位：被测PLC按照顺序输出量程的0%,25%,50%,75%,100%。测试PLC采集数值是否正确(偏差小于设定值)。
而你说的报警上下限、显示值、趋势、报表、维护开关等都属于上位机的手动测试部分。
总结来说当用户点击硬点自动测试按钮后，将启动这批次的所有硬点测试任务并等待完成
2.关于手动测试前置条件：是指通道的硬点通道测试通过后才能进行手动测试，这个是对于单个通道来进行判断的

---

#### F2. 批次分配逻辑澄清
**问题**: 关于批次分配的具体规则，我需要了解：

1. **分配策略**：
   - 批次分配是按照什么规则进行的？是按模块类型、通道数量、还是其他业务规则？
   - 一个批次最多包含多少个通道？最少包含多少个？

2. **分配结果**：
   - 分配完成后，用户是否可以手动调整批次分配结果？
   - 如果用户对分配结果不满意，是否可以重新分配？

**您的澄清**:
1.批次分配是需要从数据库中获取测试PLC的详细通道信息，并且从用户导入的点表中获取被测PLC的通道信息，双方进行匹配。
按照：
测试PLC->被测PLC
AI有源->AO无源
AI无源->AO有源
AO无源->AI有源
AO有源->AI无源
DI有源->DO无源
DI无源->DO有源
DO有源->DI无源
DO无源->DI有源
的规则进行分配
且类似填空一样就行填入比如测试PLC的通道中有16个AI有源，被测PLC有18个AO无源通道，那么前16个AO无源通道将被分配到第一个批次中，剩余的2个AO无源通道将被分配到下一个批次中。

---

#### F3. 状态管理生命周期澄清
**问题**: 关于测试数据实例的状态管理，我需要确认：

1. **状态持久化时机**：
   - 您提到"当硬点通道测试结束时将整个集合的状态全部持久化到数据库中"，这是指单个通道测试结束还是整个批次测试结束？
   - 如果是整个批次结束才持久化，那么测试过程中系统崩溃会丢失所有进度吗？

2. **状态恢复机制**：
   - 当用户重新打开软件时，如何恢复之前的测试状态？
   - 是否需要提供"继续上次测试"的功能？

**您的澄清**:
1."当硬点通道测试结束时将整个集合的状态全部持久化到数据库中"指的是整个批次的硬点通道测试结束时将所有的通道信息都存入数据库中(如果只存入一个批次的那么当用户通过测试记录恢复功能恢复数据的时候则其余部分的数据则无法恢复)。所有从整体的流程来说用户先选择一个批次进行硬点通道测试，当这一批次硬点通道测试结束时将所有批次的信息都持久化到数据库中，后续再进行其他批次的硬点通道测试的时候就是更新数据库中的数据库。对于硬点测试通过的点位在手动测试部分当这个点位的手动测试整体完成时更新这个点位。
2.当用户重新打开软件时，需要提供"继续上次测试"的功能，这个功能需要从数据库中恢复所有的测试数据并显示在界面上。

---

### 🔧 G. 技术实现细节澄清类问题

#### G1. 数据库结构设计澄清
**问题**: 关于数据库结构设计，我需要确认：

1. **ORM框架选择**：
   - 您提到使用sqlx而不是SeaORM，这是否意味着需要将现有的SeaORM代码重构为sqlx？
   - sqlx的使用是否需要手写SQL，还是使用sqlx的查询构建器？

2. **数据模型字段**：
   - 您提到"现在的数据模型中的字段是非常缺失的"，能否具体指出哪些关键字段缺失？
   - 是否需要完全按照原C#项目的数据库结构来设计？

**您的澄清**:
1.我理解错了。我们继续使用SeaORM
2.这个缺失的部分就需要参照原来的C#项目的数据库结构来设计,但是对于表中字段的名称就需要做适应性的调整。但是字段的个数不能缺失

---

#### G2. 并发控制实现澄清
**问题**: 关于并发测试的具体实现，我需要了解：

1. **并发粒度**：
   - 并发是以通道为单位，还是以子测试项为单位？
   - 如果一个通道有多个子测试项（硬点、报警等），这些子测试项是串行执行还是可以并行？

2. **资源竞争**：
   - 多个通道并发测试时，如何避免PLC通信资源的竞争？
   - 测试PLC和被测PLC的通信是否需要排队机制？

**您的澄清**:
1.并发是以通道为单位，对于通道中的子测试项是串行执行的。
2.多个通道并发测试时，需要避免PLC通信资源的竞争。测试PLC和被测PLC的通信不需要排队机制。

---

#### G3. 前端状态更新机制澄清
**问题**: 关于前端实时状态更新，我需要确认：

1. **更新频率**：
   - 测试状态更新的频率是多少？每秒几次？
   - 是否需要显示测试进度条或百分比？

2. **更新内容**：
   - 前端需要显示哪些实时信息？（测试进度、当前测试的通道、测试结果等）
   - 是否需要显示PLC通信状态的实时监控？

**您的澄清**:
1.测试状态更新应该时实时的，因为后端有状态管理器。当状态改变的时候通过触发式机制来更新前端的状态。需要显示整体的测试进度
2.前端需要显示测试进度、当前测试的通道、测试结果等实时信息。并且需要显示PLC通信状态的实时监控(在整个导航窗口中添加状态显示的区域这样不论用户在那个界面都能看到通讯状态)。

---

### 🏗️ H. 架构设计确认类问题

#### H1. 模块间通信架构确认
**问题**: 基于您的回答"需要考虑架构和解耦的问题，同时权衡实施难度"，我建议以下方案，请确认：

**建议方案**：
- **核心业务层**：使用直接的trait调用（简单、性能好）
- **状态通知层**：使用事件系统（解耦、灵活）
- **PLC通信层**：使用消息队列（避免资源竞争）

**您的确认**:
其他方面我都同意，对于PLC通讯层通讯库应该是支持并发的只要不同时读写一个寄存器就不会触发底层的锁。对于通讯资源的操作。你可以按照你的方式来，只要保证速度和稳定性即可
---

#### H2. 配置管理实现确认
**问题**: 关于配置的热更新机制，我需要确认具体实现：

1. **配置更新范围**：
   - 系统配置（并发数、间隔时间等）需要立即生效吗？
   - PLC通信配置更新后是否需要重新建立连接？

2. **更新通知机制**：
   - 配置更新后如何通知相关的服务模块？
   - 是否需要配置变更的审计日志？

**您的澄清**:
1.配置不太可能存在同时修改的情况。但是修改完应该立即生效。配置更新后需要重新建立连接(但是修改配置只允许在PLC断开连接的情况下才能修改，且建立PLC连接的触发点是确认接线按钮点击时才建立连接)
2.需要相关的服务模块提供修改配置的接口，不需要审计日志。

---

### ⚠️ I. 风险和约束确认类问题

#### I1. 性能约束确认
**问题**: 关于"30秒内完成批次测试"的性能要求：

1. **测试时间构成**：
   - 30秒是指纯测试时间，还是包括PLC通信、数据处理等所有时间？
   - 如果一个批次有100个通道，每个通道的平均测试时间是多少？

2. **性能瓶颈**：
   - 您认为当前系统的主要性能瓶颈在哪里？PLC通信、数据处理、还是UI更新？

**您的澄清**:
1.30秒是指整个当前选择的批次完成硬点通道测试的时间，这个需要依赖于用户设置的并发数。目前我们使用的测试PLC的通道数是88个。所以将并发数也设置为默认88个。这样能够保证整个批次都在30秒内完成。也就是整个批次同时进行也是30秒完成。如果一个批次100个通道但是测试PLC的通道数是88个那么按照通道分配的逻辑就不可能把100个通道分到第一批次。而是后12个在第二批次。还有一种情况是一个批次88个通道，用户设置的并发数是44个那么相当于测试时间就是60秒了。
2.性能瓶颈主要还是数据处理和UI更新会影响用户的体验。对于PLC通讯来说Rust本身以及底层的通讯库应该不会是瓶颈。


---

#### I2. 扩展性约束确认
**问题**: 关于未来扩展性，我需要确认设计边界：

1. **软点测试扩展**：
   - 软点测试与硬点测试的主要区别是什么？
   - 软点测试是否需要不同的PLC通信方式？

2. **跳过测试功能**：
   - 模块跳过和通道跳过的具体业务场景是什么？
   - 跳过的测试项如何在报告中体现？

**您的澄清**:
1.软点测试是指的在PLC中的中间点位，而硬点则对应着PLC的通道硬点。但是他们使用的PLC的通讯方式是相同的
2.模块跳过和通道跳过是指在测试过程中用户可以指定跳过某些模块或者通道的测试。因为在机柜集成的时候有可能某些模块没有到，这个模块的所有通道都不能完成测试。对于跳过的模块在测试结果和测试报告中都要体现，且需要备注详细的跳过原因

---

## 📝 请您回答上述澄清问题

请您针对上述F-I类别的澄清问题提供详细回答，这将帮助我制定更准确和可执行的第二阶段重构实施方案。您可以：

1. **逐个回答**：按照F1、F2...的顺序逐个回答
2. **重点回答**：先回答您认为最关键的几个问题
3. **补充说明**：对任何问题都可以提供额外的背景信息

---
