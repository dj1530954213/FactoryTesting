# 上位机手动测试功能实施步骤

## 📋 项目概述
基于重构前C#项目的手动测试业务逻辑，在当前Rust + Angular + Tauri技术栈中实现上位机手动测试功能。

## 🎯 核心设计原则
- **数据唯一性**：只有状态管理器可以操作数据库，其他组件不能直接访问
- **状态一致性**：所有状态变更通过状态管理器统一管理
- **界面响应性**：实时PLC通信和状态更新

## 📊 功能需求分析

### 1. 界面调整需求
- 调整批次通道详情表格列宽为自适应
- 删除硬点重测右边的三个点按钮
- 新增"上位机手动测试"按钮列
- 实现整行颜色变更（失败=红色，完成=绿色）

### 2. 手动测试窗口需求
- **AI点位**：显示值核对 + 4个报警测试 + 趋势检查 + 报表检查 + 维护功能（8项）
- **AO点位**：显示值核对 + 趋势检查 + 报表检查 + 维护功能（4项）
- **DI点位**：显示值核对（1项）
- **DO点位**：显示值核对（1项）

### 3. 技术实现需求
- 0.5秒间隔定时读取PLC变量
- 状态保存和恢复机制
- 完成检查器逻辑
- 与现有状态管理器集成

## 🚀 详细实施步骤

### 阶段一：前端界面调整（预计2小时）

#### 步骤1.1：调整测试区域表格
**文件**：`FactoryTesting/src/app/components/test-area/test-area.component.html`
- 修改nz-table列定义，设置列宽为自适应
- 删除硬点重测的dropdown菜单按钮
- 新增"上位机手动测试"列，包含按钮

#### 步骤1.2：实现整行颜色变更
**文件**：`FactoryTesting/src/app/components/test-area/test-area.component.ts`
- 添加行样式计算方法`getRowClassName()`
- 根据测试状态返回对应CSS类名
- 硬点失败→红色，测试完成通过→绿色

#### 步骤1.3：添加CSS样式
**文件**：`FactoryTesting/src/app/components/test-area/test-area.component.scss`
- 定义`.row-failed`和`.row-passed`样式类
- 设置对应的背景颜色

### 阶段二：手动测试模态框组件（预计4小时）

#### 步骤2.1：创建通用手动测试组件
**文件**：`FactoryTesting/src/app/components/manual-test/manual-test-modal.component.ts`
- 创建基础模态框组件
- 定义输入属性：通道信息、点位类型
- 实现模态框打开/关闭逻辑

#### 步骤2.2：创建AI点位手动测试组件
**文件**：`FactoryTesting/src/app/components/manual-test/ai-manual-test.component.ts`
- 实现AI点位的8个测试项界面
- 显示值核对、4个报警测试、趋势检查、报表检查、维护功能
- 实时显示PLC读取的报警设定值

#### 步骤2.3：创建AO点位手动测试组件
**文件**：`FactoryTesting/src/app/components/manual-test/ao-manual-test.component.ts`
- 实现AO点位的4个测试项界面
- 显示值核对、趋势检查、报表检查、维护功能
- 实时显示PLC读取的当前输出值

#### 步骤2.4：创建DI/DO点位手动测试组件
**文件**：`FactoryTesting/src/app/components/manual-test/di-manual-test.component.ts`
**文件**：`FactoryTesting/src/app/components/manual-test/do-manual-test.component.ts`
- 实现DI/DO点位的显示值核对界面
- 实时显示PLC读取的当前状态值

### 阶段三：后端Tauri命令扩展（预计3小时）

#### 步骤3.1：扩展手动测试相关命令
**文件**：`FactoryTesting/src-tauri/src/commands/manual_test_commands.rs`
- `start_manual_test_cmd` - 开始手动测试
- `update_manual_test_subitem_cmd` - 更新手动测试子项状态
- `get_manual_test_status_cmd` - 获取手动测试状态
- `start_plc_monitoring_cmd` - 开始PLC变量监控
- `stop_plc_monitoring_cmd` - 停止PLC变量监控

#### 步骤3.2：实现PLC变量监控服务
**文件**：`FactoryTesting/src-tauri/src/services/plc_monitoring_service.rs`
- 实现0.5秒间隔的定时读取逻辑
- 支持AI报警设定值读取
- 支持AO当前值读取
- 支持DI/DO状态读取
- 使用Tauri事件系统推送实时数据

#### 步骤3.3：扩展状态管理器
**文件**：`FactoryTesting/src-tauri/src/domain/services/channel_state_manager.rs`
- 添加`update_manual_test_subitem`方法
- 实现手动测试完成检查器`check_manual_test_completion`
- 更新整体状态判断逻辑
- 确保数据唯一性原则

### 阶段四：前后端集成（预计2小时）

#### 步骤4.1：创建前端服务
**文件**：`FactoryTesting/src/app/services/manual-test.service.ts`
- 封装手动测试相关的Tauri命令调用
- 实现错误处理和状态管理
- 提供统一的API接口

#### 步骤4.2：实现PLC监控服务
**文件**：`FactoryTesting/src/app/services/plc-monitoring.service.ts`
- 监听Tauri事件获取实时PLC数据
- 管理监控的启动和停止
- 提供数据订阅接口

#### 步骤4.3：集成到测试区域组件
**文件**：`FactoryTesting/src/app/components/test-area/test-area.component.ts`
- 添加手动测试按钮点击处理
- 集成模态框组件
- 实现状态刷新逻辑

### 阶段五：数据模型和类型定义（预计1小时）

#### 步骤5.1：扩展前端类型定义
**文件**：`FactoryTesting/src/app/models/manual-test.types.ts`
- 定义手动测试相关的TypeScript接口
- 定义PLC监控数据结构
- 定义测试项状态枚举

#### 步骤5.2：扩展后端数据结构
**文件**：`FactoryTesting/src-tauri/src/models/structs/manual_test.rs`
- 定义手动测试请求/响应结构
- 定义PLC监控数据结构
- 确保与前端类型一致

### 阶段六：测试和优化（预计2小时）

#### 步骤6.1：单元测试
- 测试状态管理器的手动测试逻辑
- 测试PLC监控服务
- 测试完成检查器

#### 步骤6.2：集成测试
- 测试完整的手动测试流程
- 测试状态保存和恢复
- 测试整行颜色变更

#### 步骤6.3：性能优化
- 优化PLC读取频率
- 优化状态更新性能
- 优化界面响应速度

## 📁 涉及的文件清单

### 前端文件（Angular）
```
FactoryTesting/src/app/
├── components/
│   ├── test-area/
│   │   ├── test-area.component.html          # 表格界面调整
│   │   ├── test-area.component.ts            # 逻辑实现
│   │   └── test-area.component.scss          # 样式定义
│   └── manual-test/
│       ├── manual-test-modal.component.ts    # 通用模态框
│       ├── ai-manual-test.component.ts       # AI点位测试
│       ├── ao-manual-test.component.ts       # AO点位测试
│       ├── di-manual-test.component.ts       # DI点位测试
│       └── do-manual-test.component.ts       # DO点位测试
├── services/
│   ├── manual-test.service.ts                # 手动测试服务
│   └── plc-monitoring.service.ts             # PLC监控服务
└── models/
    └── manual-test.types.ts                  # 类型定义
```

### 后端文件（Rust）
```
FactoryTesting/src-tauri/src/
├── commands/
│   └── manual_test_commands.rs               # Tauri命令
├── services/
│   └── plc_monitoring_service.rs             # PLC监控服务
├── domain/services/
│   └── channel_state_manager.rs              # 状态管理器扩展
└── models/structs/
    └── manual_test.rs                        # 数据结构
```

## ⚠️ 关键注意事项

### 数据唯一性原则
- 所有数据库操作必须通过状态管理器
- 前端组件不能直接调用数据库相关命令
- 状态恢复从状态管理器内存获取

### 状态管理流程
1. 用户操作 → 前端组件
2. 前端组件 → 状态管理器API
3. 状态管理器 → 更新内存状态
4. 状态管理器 → 持久化数据库
5. 状态管理器 → 调用完成检查器
6. 状态管理器 → 返回结果给前端

### PLC通信要求
- 0.5秒间隔定时读取
- 窗口打开时启动，关闭时停止
- 使用现有的PLC通信服务
- 错误处理和重试机制

### 界面交互要求
- 模态框形式，一次只能打开一个
- 支持状态保存和恢复
- 实时显示PLC读取值
- 清晰的测试项完成状态指示

## 🎯 验收标准

### 功能验收
- [ ] 表格列宽自适应正常
- [ ] 手动测试按钮启用条件正确
- [ ] 不同点位类型显示对应测试项
- [ ] PLC变量实时读取正常
- [ ] 测试项状态保存恢复正常
- [ ] 整行颜色变更正常
- [ ] 完成检查器逻辑正确

### 性能验收
- [ ] PLC读取延迟 < 1秒
- [ ] 界面响应时间 < 500ms
- [ ] 状态更新实时性良好
- [ ] 内存使用合理

### 稳定性验收
- [ ] 长时间运行无内存泄漏
- [ ] PLC通信异常处理正常
- [ ] 状态一致性保证
- [ ] 数据唯一性不被违背

---

**预计总工时：14小时**
**实施优先级：高**
**风险等级：中等**