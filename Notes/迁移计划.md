# 后端重构迁移计划（最终版）

> 目标：
> 1. **功能零变动** – 对外 API/数据库/业务流程保持完全一致。
> 2. **目录清晰** – 按层划分 Application / Domain / Infrastructure。
> 3. **移除 Mock/Stub/Test** – 生产代码不含任何占位或测试专用实现。
> 4. **编译 0 Error & 最低警告** – `cargo build --release` 成功且警告控制在 5 条以内。

---

## Phase 1 – 功能替换完整化

| Step | 任务 | 说明 |
|------|------|------|
|1.1|RealBatchAllocationService: 实现 `validate_allocation`|代理到应用层 BatchAllocationService.validate|
|1.2|RealBatchAllocationService: 实现 `preview_allocation`|代理到 …preview|
|1.3|RealBatchAllocationService: 实现 `reallocate_batch`|代理到 …reallocate|
|1.4|RealBatchAllocationService: 实现历史/统计查询|`get_allocation_history / statistics`|
|1.5|DI 切换到 RealBatchAllocationService|移除 stub 注入|
|1.6|注释 stub_batch_allocation_service mod|保留文件便于回滚|
|1.7|编译 + 典型业务流程手动验证|create → allocate → start etc.|

## Phase 2 – Stub / Mock 清零

1. 全局检索 `stub_`, `mock_`, `dummy_`, `fake_`, `#![cfg(test)]`, `mod tests`。
2. 若文件无运行时引用 → 删除；有引用 → 先替换后删。
3. 删除项目内 `tests/` 目录或集成测试 crates。
4. `cargo check` 无错误。

## Phase 3 – 目录与接口清洗

1. impl 目录仅保留 Real 实现；按功能移动：
   ```text
   domain/impls/coordination  (RealTestOrchestrationService)
   domain/impls/allocation    (RealBatchAllocationService)
   domain/impls/execution     (TestExecutionEngine etc.)
   ```
2. 更新 `domain::impls::mod.rs` 只 re-export Real 实现。
3. 更新 DI 的 use 路径。

## Phase 4 – 警告 & 死码收敛

1. `cargo fix --workspace`（人工审阅更改）。
2. 手工去除：unused imports、ambiguous re-exports、显式列举 glob。 
3. 处理显著 clippy 提示（clone, &Arc 复制等）。
4. `cargo check --all-targets --all-features` 警告 ≤ 5。

## Phase 5 – 功能对等性验证

1. 手工跑通：
   * 批次创建/分配/启动/暂停/恢复/取消/删除
   * 手动测试三接口
   * Allocation validate/preview/reallocate
2. 对比重构前后：数据库记录 / 事件日志 / 终端输出。
3. 如有差异 → 回溯最近改动。

## Phase 6 – 收尾

1. 删除 README 中“stub/mock”说明，添加迁移结果。
2. `git status`：确认 mock/test 文件已删除。
3. `cargo build --release` 通过。
4. Tag 版本 `v1.0.0-real-services`。

---

### 里程碑预计

| Phase | 预计编译循环 | 预计人时 |
|-------|-------------|----------|
|1|3–4|~2h|
|2|2|~1h|
|3|2|~1h|
|4|1–2|~1h|
|5|1|~0.5h|
|6|1|~0.5h|

**总计 ≈ 10 次 commit / 6–7 小时**（含人工验证）。

> 任何阶段如发现功能偏差或编译异常，立即停止后回滚至最近 tag 处理。
