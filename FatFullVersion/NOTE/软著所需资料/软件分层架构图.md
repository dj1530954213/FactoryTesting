# FatFullVersion 工业自动化测试系统 - 软件分层架构图

## 软件分层架构图

```mermaid
graph TB
    %% 表示层
    subgraph "表示层 (Presentation Layer)"
        direction TB
        subgraph "XAML Views"
            V1[MainWindow.xaml<br/>主窗口]
            V2[ConfigEditView.xaml<br/>配置编辑视图]
            V3[DataEditView.xaml<br/>数据编辑视图]
            V4[ManualTestWindow.xaml<br/>手动测试窗口]
        end
        
        subgraph "ViewModels"
            VM1[MainWindowViewModel<br/>主窗口视图模型]
            VM2[ConfigEditViewModel<br/>配置编辑视图模型]
            VM3[DataEditViewModel<br/>数据编辑视图模型]
            VM4[ManualTestViewModel<br/>手动测试视图模型]
        end
        
        subgraph "Converters & Controls"
            C1[数据转换器<br/>Converters]
            C2[自定义控件<br/>Custom Controls]
        end
    end

    %% 业务逻辑层
    subgraph "业务逻辑层 (Business Logic Layer)"
        direction TB
        subgraph "Core Services"
            BS1[配置管理服务<br/>ConfigurationService]
            BS2[测试任务管理<br/>TestTaskManager]
            BS3[数据验证服务<br/>ValidationService]
            BS4[结果分析服务<br/>AnalysisService]
        end
        
        subgraph "Business Models"
            BM1[ExcelPointData<br/>点表数据模型]
            BM2[ChannelMapping<br/>通道映射模型]
            BM3[TestResult<br/>测试结果模型]
            BM4[PlcConnectionConfig<br/>PLC配置模型]
        end
        
        subgraph "Business Logic"
            BL1[通道分配算法<br/>ChannelAllocation]
            BL2[测试执行逻辑<br/>TestExecution]
            BL3[数据导入逻辑<br/>DataImport]
            BL4[报告生成逻辑<br/>ReportGeneration]
        end
    end

    %% 服务层
    subgraph "服务层 (Service Layer)"
        direction TB
        subgraph "Communication Services"
            CS1[PLC通信服务<br/>IPlcCommunication]
            CS2[Modbus TCP客户端<br/>ModbusTcpClient]
            CS3[通信工厂<br/>CommunicationFactory]
        end
        
        subgraph "Data Services"
            DS1[点表数据服务<br/>IPointDataService]
            DS2[通道映射服务<br/>IChannelMappingService]
            DS3[批次管理服务<br/>IBatchService]
        end
        
        subgraph "Infrastructure Services"
            IS1[日志服务<br/>ILoggingService]
            IS2[配置服务<br/>IConfigService]
            IS3[事件聚合器<br/>IEventAggregator]
        end
    end

    %% 数据访问层
    subgraph "数据访问层 (Data Access Layer)"
        direction TB
        subgraph "Repository Pattern"
            R1[IRepository<br/>数据访问接口]
            R2[Repository<br/>数据访问实现]
            R3[UnitOfWork<br/>工作单元]
        end
        
        subgraph "Entity Framework"
            EF1[ApplicationDbContext<br/>数据库上下文]
            EF2[Entity Configurations<br/>实体配置]
            EF3[Migrations<br/>数据库迁移]
        end
        
        subgraph "Data Models"
            DM1[PlcConnectionConfig<br/>PLC配置实体]
            DM2[ChannelMapping<br/>通道映射实体]
            DM3[ComparisonTable<br/>比较表实体]
        end
    end

    %% 数据存储层
    subgraph "数据存储层 (Data Storage Layer)"
        direction TB
        subgraph "Database"
            DB1[(SQLite Database<br/>fattest.db)]
        end
        
        subgraph "File Storage"
            FS1[配置文件<br/>Config Files]
            FS2[日志文件<br/>Log Files]
            FS3[导出文件<br/>Export Files]
        end
        
        subgraph "External Files"
            EXT1[Excel点表<br/>Point Tables]
            EXT2[测试报告<br/>Test Reports]
        end
    end

    %% 外部接口层
    subgraph "外部接口层 (External Interface Layer)"
        direction TB
        subgraph "Hardware Interface"
            HW1[测试PLC<br/>Test PLC]
            HW2[被测PLC<br/>Target PLC]
        end
        
        subgraph "Network Protocol"
            NP1[Modbus TCP<br/>通信协议]
            NP2[TCP/IP Socket<br/>网络连接]
        end
        
        subgraph "File Interface"
            FI1[Excel导入<br/>Excel Import]
            FI2[报告导出<br/>Report Export]
        end
    end

    %% 连接关系
    V1 -.-> VM1
    V2 -.-> VM2
    V3 -.-> VM3
    V4 -.-> VM4
    
    VM1 --> BS1
    VM2 --> BS1
    VM3 --> BS2
    VM4 --> BS2
    
    BS1 --> BM4
    BS2 --> BM2
    BS3 --> BM1
    BS4 --> BM3
    
    BS1 --> BL1
    BS2 --> BL2
    BS3 --> BL3
    BS4 --> BL4
    
    BL1 --> DS2
    BL2 --> CS1
    BL3 --> DS1
    BL4 --> DS3
    
    CS1 --> CS2
    CS2 --> CS3
    DS1 --> R1
    DS2 --> R1
    DS3 --> R1
    
    R1 --> R2
    R2 --> R3
    R2 --> EF1
    EF1 --> EF2
    EF1 --> EF3
    
    EF1 --> DM1
    EF1 --> DM2
    EF1 --> DM3
    
    DM1 --> DB1
    DM2 --> DB1
    DM3 --> DB1
    
    IS2 --> FS1
    IS1 --> FS2
    BS4 --> FS3
    
    CS2 --> NP1
    NP1 --> NP2
    NP2 --> HW1
    NP2 --> HW2
    
    DS1 --> FI1
    FI1 --> EXT1
    BS4 --> FI2
    FI2 --> EXT2

    %% 样式定义
    classDef presentationClass fill:#e3f2fd,stroke:#0277bd,stroke-width:2px
    classDef businessClass fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    classDef serviceClass fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef dataAccessClass fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef storageClass fill:#f1f8e9,stroke:#558b2f,stroke-width:2px
    classDef externalClass fill:#fff8e1,stroke:#ffa000,stroke-width:2px

    class V1,V2,V3,V4,VM1,VM2,VM3,VM4,C1,C2 presentationClass
    class BS1,BS2,BS3,BS4,BM1,BM2,BM3,BM4,BL1,BL2,BL3,BL4 businessClass
    class CS1,CS2,CS3,DS1,DS2,DS3,IS1,IS2,IS3 serviceClass
    class R1,R2,R3,EF1,EF2,EF3,DM1,DM2,DM3 dataAccessClass
    class DB1,FS1,FS2,FS3,EXT1,EXT2 storageClass
    class HW1,HW2,NP1,NP2,FI1,FI2 externalClass
```

## 分层架构说明

### 1. 表示层 (Presentation Layer)
**职责**: 用户界面展示和用户交互处理
- **XAML Views**: WPF用户界面定义
- **ViewModels**: MVVM模式的视图模型，处理界面逻辑
- **Converters & Controls**: 数据转换器和自定义控件

**技术特点**:
- 采用MVVM架构模式
- 数据绑定和命令模式
- 依赖注入支持

### 2. 业务逻辑层 (Business Logic Layer)
**职责**: 核心业务逻辑处理和业务规则实现
- **Core Services**: 核心业务服务
- **Business Models**: 业务数据模型
- **Business Logic**: 具体业务逻辑实现

**技术特点**:
- 业务规则封装
- 算法实现
- 数据验证

### 3. 服务层 (Service Layer)
**职责**: 提供可重用的服务接口和功能
- **Communication Services**: 通信相关服务
- **Data Services**: 数据处理服务
- **Infrastructure Services**: 基础设施服务

**技术特点**:
- 接口抽象
- 服务注册和发现
- 横切关注点处理

### 4. 数据访问层 (Data Access Layer)
**职责**: 数据持久化和数据库操作
- **Repository Pattern**: 数据访问模式
- **Entity Framework**: ORM框架
- **Data Models**: 数据实体模型

**技术特点**:
- Repository模式
- Entity Framework Core
- 数据库迁移

### 5. 数据存储层 (Data Storage Layer)
**职责**: 数据存储和文件管理
- **Database**: SQLite数据库
- **File Storage**: 文件存储
- **External Files**: 外部文件

**技术特点**:
- SQLite嵌入式数据库
- 文件系统操作
- 数据备份和恢复

### 6. 外部接口层 (External Interface Layer)
**职责**: 与外部系统和硬件的接口
- **Hardware Interface**: 硬件接口
- **Network Protocol**: 网络协议
- **File Interface**: 文件接口

**技术特点**:
- Modbus TCP协议
- 硬件通信
- 文件导入导出

## 层间交互原则

1. **单向依赖**: 上层依赖下层，下层不依赖上层
2. **接口隔离**: 通过接口进行层间通信
3. **依赖注入**: 使用依赖注入容器管理依赖关系
4. **事件驱动**: 使用事件机制实现松耦合通信

## 技术优势

1. **可维护性**: 清晰的分层结构便于维护
2. **可扩展性**: 模块化设计支持功能扩展
3. **可测试性**: 接口抽象便于单元测试
4. **可重用性**: 服务层提供可重用组件

---
*生成时间: 2025年1月*
*适用版本: FatFullVersion V1.0* 