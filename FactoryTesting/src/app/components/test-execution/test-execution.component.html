<div class="test-execution-container">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <div class="page-header">
    <div class="header-content">
      <h1>ğŸ§ª æµ‹è¯•æ‰§è¡Œç›‘æ§</h1>
      <p *ngIf="executionData">{{ executionData.batch.product_model }} - {{ executionData.batch.serial_number }}</p>
      <p *ngIf="!executionData">å®æ—¶ç›‘æ§æµ‹è¯•æ‰§è¡Œè¿‡ç¨‹å’Œç»“æœ</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-secondary" (click)="goToDashboard()">
        <span class="btn-icon">ğŸ </span>
        è¿”å›ä»ªè¡¨æ¿
      </button>
      <button class="btn btn-secondary" (click)="goToBatchManagement()">
        <span class="btn-icon">ğŸ“¦</span>
        æ‰¹æ¬¡ç®¡ç†
      </button>
    </div>
  </div>

  <!-- æµ‹è¯•ç»Ÿè®¡æ¦‚è§ˆ -->
  <div class="statistics-overview" *ngIf="executionData">
    <div class="stat-card total">
      <div class="stat-icon">ğŸ“Š</div>
      <div class="stat-info">
        <div class="stat-number">{{ statistics.total }}</div>
        <div class="stat-label">æ€»æµ‹è¯•ç‚¹</div>
      </div>
    </div>
    
    <div class="stat-card completed">
      <div class="stat-icon">âœ…</div>
      <div class="stat-info">
        <div class="stat-number">{{ statistics.completed }}</div>
        <div class="stat-label">å·²å®Œæˆ</div>
      </div>
    </div>
    
    <div class="stat-card passed">
      <div class="stat-icon">ğŸ¯</div>
      <div class="stat-info">
        <div class="stat-number">{{ statistics.passed }}</div>
        <div class="stat-label">é€šè¿‡</div>
      </div>
    </div>
    
    <div class="stat-card failed">
      <div class="stat-icon">âŒ</div>
      <div class="stat-info">
        <div class="stat-number">{{ statistics.failed }}</div>
        <div class="stat-label">å¤±è´¥</div>
      </div>
    </div>
    
    <div class="stat-card in-progress">
      <div class="stat-icon">ğŸ”„</div>
      <div class="stat-info">
        <div class="stat-number">{{ statistics.inProgress }}</div>
        <div class="stat-label">è¿›è¡Œä¸­</div>
      </div>
    </div>
    
    <div class="stat-card success-rate">
      <div class="stat-icon">ğŸ“ˆ</div>
      <div class="stat-info">
        <div class="stat-number">{{ statistics.successRate }}%</div>
        <div class="stat-label">æˆåŠŸç‡</div>
      </div>
    </div>
  </div>

  <!-- æµ‹è¯•æ§åˆ¶é¢æ¿ -->
  <div class="control-panel" *ngIf="executionData">
    <div class="control-section">
      <h3>æµ‹è¯•æ§åˆ¶</h3>
      <div class="control-buttons">
        <button class="btn btn-success" (click)="startTest()" 
                [disabled]="isTestRunning || isLoading">
          <span class="btn-icon">â–¶ï¸</span>
          {{ isTestRunning ? 'æµ‹è¯•è¿è¡Œä¸­' : 'å¼€å§‹æµ‹è¯•' }}
        </button>
        
        <button class="btn btn-warning" (click)="pauseTest()" 
                [disabled]="!isTestRunning || isPaused || isLoading">
          <span class="btn-icon">â¸ï¸</span>
          æš‚åœæµ‹è¯•
        </button>
        
        <button class="btn btn-info" (click)="resumeTest()" 
                [disabled]="!isPaused || isLoading">
          <span class="btn-icon">â–¶ï¸</span>
          æ¢å¤æµ‹è¯•
        </button>
        
        <button class="btn btn-danger" (click)="stopTest()" 
                [disabled]="!isTestRunning || isLoading">
          <span class="btn-icon">â¹ï¸</span>
          åœæ­¢æµ‹è¯•
        </button>
      </div>
    </div>
    
    <div class="control-section">
      <h3>æ•°æ®æ§åˆ¶</h3>
      <div class="control-buttons">
        <button class="btn btn-secondary" (click)="refreshData()" [disabled]="isLoading">
          <span class="btn-icon">ğŸ”„</span>
          åˆ·æ–°æ•°æ®
        </button>
        
        <button class="btn btn-secondary" (click)="toggleAutoRefresh()">
          <span class="btn-icon">{{ autoRefresh ? 'â¸ï¸' : 'â–¶ï¸' }}</span>
          {{ autoRefresh ? 'åœæ­¢è‡ªåŠ¨åˆ·æ–°' : 'å¼€å¯è‡ªåŠ¨åˆ·æ–°' }}
        </button>
        
        <button class="btn btn-primary" (click)="exportResults()" 
                [disabled]="!executionData || statistics.completed === 0">
          <span class="btn-icon">ğŸ“¤</span>
          å¯¼å‡ºç»“æœ
        </button>
      </div>
    </div>
  </div>

  <!-- ç­›é€‰å’Œæœç´¢ -->
  <div class="filter-section" *ngIf="executionData">
    <div class="filter-group">
      <label>çŠ¶æ€ç­›é€‰:</label>
      <select [(ngModel)]="statusFilter" class="filter-select">
        <option value="">æ‰€æœ‰çŠ¶æ€</option>
        <option [value]="OverallTestStatus.NotStarted">{{ OVERALL_TEST_STATUS_LABELS[OverallTestStatus.NotStarted] }}</option>
        <option [value]="OverallTestStatus.InProgress">{{ OVERALL_TEST_STATUS_LABELS[OverallTestStatus.InProgress] }}</option>
        <option [value]="OverallTestStatus.Completed">{{ OVERALL_TEST_STATUS_LABELS[OverallTestStatus.Completed] }}</option>
        <option [value]="OverallTestStatus.Failed">{{ OVERALL_TEST_STATUS_LABELS[OverallTestStatus.Failed] }}</option>
      </select>
    </div>
    
    <div class="filter-group">
      <label>æ¨¡å—ç±»å‹:</label>
      <select [(ngModel)]="moduleTypeFilter" class="filter-select">
        <option value="">æ‰€æœ‰ç±»å‹</option>
        <option value="AI">æ¨¡æ‹Ÿé‡è¾“å…¥</option>
        <option value="AO">æ¨¡æ‹Ÿé‡è¾“å‡º</option>
        <option value="DI">æ•°å­—é‡è¾“å…¥</option>
        <option value="DO">æ•°å­—é‡è¾“å‡º</option>
      </select>
    </div>
    
    <div class="filter-group">
      <label>æœç´¢:</label>
      <input type="text" [(ngModel)]="searchTerm" placeholder="æœç´¢æ ‡ç­¾æˆ–æè¿°..." class="search-input">
    </div>
    
    <div class="filter-group">
      <label class="checkbox-label">
        <input type="checkbox" [(ngModel)]="showOnlyFailed">
        åªæ˜¾ç¤ºå¤±è´¥é¡¹
      </label>
    </div>
  </div>

  <!-- æµ‹è¯•æ•°æ®è¡¨æ ¼ -->
  <div class="data-table-section" *ngIf="executionData">
    <div class="table-header">
      <h3>æµ‹è¯•è¯¦ç»†æ•°æ®</h3>
      <div class="table-info">
        <span>æ˜¾ç¤º {{ getFilteredInstances().length }} / {{ statistics.total }} é¡¹</span>
        <span *ngIf="autoRefresh" class="auto-refresh-indicator">ğŸ”„ è‡ªåŠ¨åˆ·æ–°</span>
      </div>
    </div>
    
    <div class="data-table">
      <div class="table-head">
        <div class="table-cell">æ ‡ç­¾</div>
        <div class="table-cell">æè¿°</div>
        <div class="table-cell">æ¨¡å—ç±»å‹</div>
        <div class="table-cell">çŠ¶æ€</div>
        <div class="table-cell">æµ‹è¯•ç»“æœ</div>
        <div class="table-cell">æµ‹é‡å€¼</div>
        <div class="table-cell">æœŸæœ›å€¼</div>
        <div class="table-cell">è¯¯å·®</div>
        <div class="table-cell">æµ‹è¯•æ—¶é—´</div>
        <div class="table-cell">è€—æ—¶</div>
      </div>
      
      <div class="table-body">
        <div class="table-row" *ngFor="let instance of getFilteredInstances().slice((currentPage-1)*pageSize, currentPage*pageSize)">
          <div class="table-cell">
            <span class="tag-label">{{ getDefinitionForInstance(instance)?.tag || 'N/A' }}</span>
          </div>
          
          <div class="table-cell">
            <span class="description">{{ getDefinitionForInstance(instance)?.description || 'N/A' }}</span>
          </div>
          
          <div class="table-cell">
            <span class="module-type" [class]="'module-' + getDefinitionForInstance(instance)?.module_type">
              {{ getDefinitionForInstance(instance)?.module_type || 'N/A' }}
            </span>
          </div>
          
          <div class="table-cell">
            <span class="status-badge" [class]="getStatusClass(instance.overall_status)">
              {{ getStatusLabel(instance.overall_status) }}
            </span>
          </div>
          
          <div class="table-cell">
            <span class="test-result" 
                  [class]="getLatestOutcomeForInstance(instance)?.success ? 'result-pass' : 'result-fail'"
                  *ngIf="getLatestOutcomeForInstance(instance)">
              {{ getLatestOutcomeForInstance(instance)?.success ? 'é€šè¿‡' : 'å¤±è´¥' }}
            </span>
            <span *ngIf="!getLatestOutcomeForInstance(instance)" class="no-result">-</span>
          </div>
          
          <div class="table-cell">
            <span *ngIf="getLatestOutcomeForInstance(instance)?.measured_value !== undefined">
              {{ getLatestOutcomeForInstance(instance)?.measured_value }}
            </span>
            <span *ngIf="getLatestOutcomeForInstance(instance)?.measured_value === undefined" class="no-value">-</span>
          </div>
          
          <div class="table-cell">
            <span *ngIf="getLatestOutcomeForInstance(instance)?.expected_value !== undefined">
              {{ getLatestOutcomeForInstance(instance)?.expected_value }}
            </span>
            <span *ngIf="getLatestOutcomeForInstance(instance)?.expected_value === undefined" class="no-value">-</span>
          </div>
          
          <div class="table-cell">
            <span *ngIf="getLatestOutcomeForInstance(instance)?.tolerance !== undefined">
              Â±{{ getLatestOutcomeForInstance(instance)?.tolerance }}
            </span>
            <span *ngIf="getLatestOutcomeForInstance(instance)?.tolerance === undefined" class="no-value">-</span>
          </div>
          
          <div class="table-cell">
            <span *ngIf="getLatestOutcomeForInstance(instance)?.test_timestamp">
              {{ formatTimestamp(getLatestOutcomeForInstance(instance)!.test_timestamp) }}
            </span>
            <span *ngIf="!getLatestOutcomeForInstance(instance)?.test_timestamp" class="no-value">-</span>
          </div>
          
          <div class="table-cell">
            <span class="duration">
              {{ formatDuration(instance.created_at, instance.updated_at) }}
            </span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- åˆ†é¡µ -->
    <div class="pagination" *ngIf="getFilteredInstances().length > pageSize">
      <button class="btn btn-secondary" [disabled]="currentPage === 1" (click)="currentPage = currentPage - 1">
        â¬…ï¸ ä¸Šä¸€é¡µ
      </button>
      <span class="page-info">
        ç¬¬ {{ currentPage }} é¡µï¼Œå…± {{ Math.ceil(getFilteredInstances().length / pageSize) }} é¡µ
      </span>
      <button class="btn btn-secondary" 
              [disabled]="currentPage >= Math.ceil(getFilteredInstances().length / pageSize)" 
              (click)="currentPage = currentPage + 1">
        ä¸‹ä¸€é¡µ â¡ï¸
      </button>
    </div>
  </div>

  <!-- ç©ºçŠ¶æ€ -->
  <div class="empty-state" *ngIf="!executionData && !isLoading">
    <div class="empty-icon">ğŸ§ª</div>
    <h3>æœªé€‰æ‹©æµ‹è¯•æ‰¹æ¬¡</h3>
    <p>è¯·ä»ä»ªè¡¨æ¿æˆ–æ‰¹æ¬¡ç®¡ç†é¡µé¢é€‰æ‹©ä¸€ä¸ªæµ‹è¯•æ‰¹æ¬¡</p>
    <button class="btn btn-primary" (click)="goToDashboard()">
      <span class="btn-icon">ğŸ </span>
      è¿”å›ä»ªè¡¨æ¿
    </button>
  </div>

  <!-- é”™è¯¯çŠ¶æ€ -->
  <div class="error-state" *ngIf="error && !isLoading">
    <div class="error-icon">âš ï¸</div>
    <h3>åŠ è½½å¤±è´¥</h3>
    <p>{{ error }}</p>
    <button class="btn btn-primary" (click)="refreshData()">
      <span class="btn-icon">ğŸ”„</span>
      é‡è¯•
    </button>
  </div>

  <!-- åŠ è½½çŠ¶æ€ -->
  <div class="loading-overlay" *ngIf="isLoading">
    <div class="loading-spinner"></div>
    <p>{{ loadingMessage }}</p>
  </div>
</div>
