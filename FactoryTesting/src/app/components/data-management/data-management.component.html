<div class="data-management-container">
  <div class="page-header">
    <h2>
      <span nz-icon nzType="database" nzTheme="outline"></span>
      数据导入
    </h2>
    <p>导入新的点表或恢复之前的数据继续测试</p>
  </div>

  <!-- 工作流程步骤 -->
  <nz-card nzTitle="数据管理工作流程" class="workflow-card">
    <nz-steps [nzCurrent]="currentStep" nzDirection="horizontal">
      <nz-step nzTitle="选择文件" nzDescription="选择要导入的Excel点表文件"></nz-step>
      <nz-step nzTitle="数据导入" nzDescription="解析并导入点表数据"></nz-step>
      <nz-step nzTitle="导入完成" nzDescription="查看导入结果和统计信息"></nz-step>
    </nz-steps>
  </nz-card>

  <!-- 数据导入区域 -->
  <div class="import-section" *ngIf="currentStep <= 2">
    <nz-card nzTitle="数据导入" class="import-card">
      <div *ngIf="currentStep === 0" class="file-selection">
        <nz-alert 
          nzType="info" 
          nzMessage="文件选择" 
          nzDescription="请选择包含测试点表数据的Excel文件。支持.xlsx和.xls格式。"
          nzShowIcon
          class="import-alert">
        </nz-alert>
        
        <div class="upload-area">
          <!-- 文件选择按钮组 -->
          <div class="file-selection-buttons">
            <nz-space nzDirection="vertical" style="width: 100%;">
              <!-- Tauri文件对话框按钮 -->
              <button *nzSpaceItem nz-button nzType="primary" nzSize="large" (click)="selectFileWithDialog()">
                <span nz-icon nzType="folder-open" nzTheme="outline"></span>
                选择Excel文件
              </button>
            </nz-space>
          </div>
        </div>

        <div *ngIf="selectedFile" class="selected-file">
          <nz-tag nzColor="blue">
            <span nz-icon nzType="file-excel" nzTheme="outline"></span>
            {{ selectedFile.name }}
          </nz-tag>
          <nz-space style="margin-top: 16px;">
            <button *nzSpaceItem nz-button nzType="primary" (click)="startImport()">
              <span nz-icon nzType="upload" nzTheme="outline"></span>
              开始导入
            </button>
            <button *nzSpaceItem nz-button nzType="default" (click)="resetImport()">
              <span nz-icon nzType="reload" nzTheme="outline"></span>
              重新选择
            </button>
          </nz-space>
        </div>
      </div>

      <div *ngIf="currentStep === 1" class="import-progress">
        <nz-alert 
          nzType="info" 
          nzMessage="正在导入数据" 
          nzDescription="系统正在解析Excel文件并导入点表数据，请稍候..."
          nzShowIcon
          class="import-alert">
        </nz-alert>
        
        <div class="progress-section">
          <h4>导入进度</h4>
          <nz-progress 
            [nzPercent]="importProgress" 
            nzStatus="active"
            [nzShowInfo]="true">
          </nz-progress>
        </div>
      </div>

      <div *ngIf="currentStep === 2 && importResult" class="import-result">
        

        <!-- 数据状态提示 -->
        <div *ngIf="importResult.success && !importResult.isPersisted" class="data-status-warning">
          <nz-alert
            nzType="warning"
            nzMessage="数据未持久化"
            nzDescription="Excel数据已解析完成，但尚未保存到数据库。数据将在您开始测试时自动保存。"
            nzShowIcon
            [nzAction]="persistDataTemplate">
          </nz-alert>
          <ng-template #persistDataTemplate>
            <button nz-button nzSize="small" nzType="primary" (click)="persistDataNow()">
              <span nz-icon nzType="save" nzTheme="outline"></span>
              立即保存
            </button>
          </ng-template>
        </div>
        
        <div class="result-stats">
          <nz-space nzDirection="vertical" style="width: 100%;">
            <div *nzSpaceItem class="stat-item">
              <span class="stat-label">总通道数:</span>
              <nz-tag nzColor="blue">{{ importResult.totalChannels }}</nz-tag>
            </div>
            <div *nzSpaceItem class="stat-item">
              <span class="stat-label">成功导入:</span>
              <nz-tag nzColor="green">{{ importResult.successChannels }}</nz-tag>
            </div>
            <div *nzSpaceItem class="stat-item" [hidden]="importResult.failedChannels === 0">
              <span class="stat-label">导入失败:</span>
              <nz-tag nzColor="red">{{ importResult.failedChannels }}</nz-tag>
            </div>
          </nz-space>
        </div>

        <!-- 批次信息展示 -->
        <div class="batch-summary" *ngIf="importResult.batchInfo" style="margin-top: 24px;">
          <nz-descriptions nzTitle="批次信息" [nzColumn]="2" nzBordered>
            <nz-descriptions-item nzTitle="批次ID">{{ importResult.batchInfo.batch_id }}</nz-descriptions-item>
            <!-- <nz-descriptions-item nzTitle="批次数量">{{ batchCount }}</nz-descriptions-item> -->
            <nz-descriptions-item nzTitle="创建时间">{{ formatDateTime(importResult.batchInfo.creation_time) }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="AI点位数" *ngIf="channelCounts">{{ channelCounts.AI || 0 }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="AO点位数" *ngIf="channelCounts">{{ channelCounts.AO || 0 }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="DI点位数" *ngIf="channelCounts">{{ channelCounts.DI || 0 }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="DO点位数" *ngIf="channelCounts">{{ channelCounts.DO || 0 }}</nz-descriptions-item>
          </nz-descriptions>
        </div>

        <nz-space style="margin-top: 24px;">
          <button *nzSpaceItem nz-button nzType="primary" (click)="resetImport()">
            <span nz-icon nzType="plus" nzTheme="outline"></span>
            导入新文件
          </button>
          <button *nzSpaceItem nz-button nzType="default" [disabled]="!importResult?.success" routerLink="/test-area">
            <span nz-icon nzType="play-circle"></span>
            开始测试
          </button>
          <button *nzSpaceItem nz-button nzType="default" routerLink="/dashboard">
            <span nz-icon nzType="dashboard" nzTheme="outline"></span>
            返回仪表盘
          </button>
        </nz-space>
      </div>
    </nz-card>
  </div>
</div> 