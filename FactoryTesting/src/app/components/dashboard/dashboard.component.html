<div class="dashboard-container">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <div class="page-header">
    <h1>ğŸ­ å·¥å‚æµ‹è¯•ç³»ç»Ÿä»ªè¡¨æ¿</h1>
    <p>æ¬¢è¿ä½¿ç”¨å·¥å‚æµ‹è¯•ç³»ç»Ÿï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹æµç¨‹è¿›è¡Œæµ‹è¯•æ“ä½œ</p>
  </div>

  <!-- ç³»ç»ŸçŠ¶æ€æ¦‚è§ˆ -->
  <div class="system-overview">
    <div class="status-card system-health" [class.healthy]="systemStatus?.system_health === 'healthy'">
      <div class="status-icon">{{ systemStatus?.system_health === 'healthy' ? 'âœ…' : 'âš ï¸' }}</div>
      <div class="status-info">
        <h3>ç³»ç»ŸçŠ¶æ€</h3>
        <p class="status-value">{{ getSystemHealthText() }}</p>
        <small>ç‰ˆæœ¬: {{ systemStatus?.version || 'v1.0.0' }}</small>
      </div>
    </div>
    
    <div class="status-card active-tests">
      <div class="status-icon">ğŸ§ª</div>
      <div class="status-info">
        <h3>æ´»åŠ¨æµ‹è¯•</h3>
        <p class="status-value">{{ systemStatus?.active_test_tasks || 0 }}</p>
        <small>æ­£åœ¨è¿›è¡Œçš„æµ‹è¯•ä»»åŠ¡</small>
      </div>
    </div>
    
    <div class="status-card total-batches">
      <div class="status-icon">ğŸ“¦</div>
      <div class="status-info">
        <h3>å¾…æµ‹æ‰¹æ¬¡</h3>
        <p class="status-value">{{ pendingBatches }}</p>
        <small>ç­‰å¾…æµ‹è¯•çš„æ‰¹æ¬¡æ•°é‡</small>
      </div>
    </div>
    
    <div class="status-card success-rate">
      <div class="status-icon">ğŸ“Š</div>
      <div class="status-info">
        <h3>æˆåŠŸç‡</h3>
        <p class="status-value">{{ overallSuccessRate }}%</p>
        <small>æœ€è¿‘æµ‹è¯•çš„é€šè¿‡ç‡</small>
      </div>
    </div>
  </div>

  <!-- ä¸»è¦å·¥ä½œæµç¨‹ -->
  <div class="workflow-section">
    <h2>æµ‹è¯•å·¥ä½œæµç¨‹</h2>
    <div class="workflow-steps">
      <!-- æ­¥éª¤1: å¯¼å…¥ç‚¹è¡¨ -->
      <div class="workflow-step" [class.completed]="hasImportedData">
        <div class="step-number">1</div>
        <div class="step-content">
          <h3>ğŸ“¥ å¯¼å…¥ç‚¹è¡¨</h3>
          <p>ä¸Šä¼ Excelç‚¹ä½è¡¨æ–‡ä»¶ï¼Œç³»ç»Ÿè‡ªåŠ¨åˆ›å»ºæµ‹è¯•æ‰¹æ¬¡</p>
          <button class="btn btn-primary" (click)="navigateToDataImport()" 
                  [disabled]="systemStatus?.system_health !== 'healthy'">
            <span class="btn-icon">ğŸ“</span>
            å¯¼å…¥ç‚¹è¡¨æ–‡ä»¶
          </button>
        </div>
      </div>

      <!-- æ­¥éª¤2: é€‰æ‹©æ‰¹æ¬¡ -->
      <div class="workflow-step" [class.completed]="selectedBatch" [class.disabled]="!hasImportedData">
        <div class="step-number">2</div>
        <div class="step-content">
          <h3>ğŸ¯ é€‰æ‹©æµ‹è¯•æ‰¹æ¬¡</h3>
          <p>ä»å¯ç”¨æ‰¹æ¬¡ä¸­é€‰æ‹©éœ€è¦æµ‹è¯•çš„äº§å“æ‰¹æ¬¡</p>
          <div class="batch-selector" *ngIf="availableBatches.length > 0">
            <select class="batch-select" [(ngModel)]="selectedBatchId" (change)="onBatchSelected()">
              <option value="">è¯·é€‰æ‹©æµ‹è¯•æ‰¹æ¬¡...</option>
              <option *ngFor="let batch of availableBatches" [value]="batch.id">
                {{ batch.productModel }} - {{ batch.serialNumber }}
              </option>
            </select>
          </div>
          <div class="no-batches" *ngIf="availableBatches.length === 0 && hasImportedData">
            <p>æš‚æ— å¯ç”¨æ‰¹æ¬¡ï¼Œè¯·å…ˆå¯¼å…¥ç‚¹è¡¨æ•°æ®</p>
          </div>
        </div>
      </div>

      <!-- æ­¥éª¤3: ç¡®è®¤æ¥çº¿ -->
      <div class="workflow-step" [class.completed]="wiringConfirmed" [class.disabled]="!selectedBatch">
        <div class="step-number">3</div>
        <div class="step-content">
          <h3>ğŸ”Œ ç¡®è®¤æ¥çº¿</h3>
          <p>æ£€æŸ¥å¹¶ç¡®è®¤æ‰€æœ‰æµ‹è¯•ç‚¹çš„æ¥çº¿è¿æ¥æ­£ç¡®</p>
          <div class="wiring-info" *ngIf="selectedBatch">
            <div class="wiring-stats">
              <span class="stat-item">
                <strong>æ€»æµ‹è¯•ç‚¹:</strong> {{ selectedBatch.totalPoints }}
              </span>
              <span class="stat-item">
                <strong>æ¨¡æ‹Ÿé‡:</strong> {{ getAnalogPointsCount() }}
              </span>
              <span class="stat-item">
                <strong>æ•°å­—é‡:</strong> {{ getDigitalPointsCount() }}
              </span>
            </div>
            <button class="btn btn-warning" (click)="confirmWiring()" [disabled]="wiringConfirmed">
              <span class="btn-icon">âœ…</span>
              {{ wiringConfirmed ? 'æ¥çº¿å·²ç¡®è®¤' : 'ç¡®è®¤æ¥çº¿å®Œæˆ' }}
            </button>
          </div>
        </div>
      </div>

      <!-- æ­¥éª¤4: å¼€å§‹æµ‹è¯• -->
      <div class="workflow-step" [class.completed]="testInProgress || testCompleted" [class.disabled]="!wiringConfirmed">
        <div class="step-number">4</div>
        <div class="step-content">
          <h3>ğŸš€ å¼€å§‹æµ‹è¯•</h3>
          <p>å¯åŠ¨è‡ªåŠ¨åŒ–æµ‹è¯•æµç¨‹ï¼Œå®æ—¶ç›‘æ§æµ‹è¯•è¿›åº¦</p>
          <div class="test-controls" *ngIf="selectedBatch && wiringConfirmed">
            <div class="test-mode-selection">
              <h4>é€‰æ‹©æµ‹è¯•æ¨¡å¼</h4>
              <div class="test-mode-buttons">
                <button class="btn btn-success" (click)="startTest()" 
                        [disabled]="testInProgress || testCompleted">
                  <span class="btn-icon">â–¶ï¸</span>
                  {{ getTestButtonText() }}
                </button>
                <button class="btn btn-warning" (click)="navigateToManualTest()" 
                        [disabled]="testInProgress">
                  <span class="btn-icon">ğŸ”§</span>
                  æ‰‹åŠ¨æµ‹è¯•
                </button>
              </div>
            </div>
            <div class="test-actions" *ngIf="testInProgress || testCompleted">
              <button class="btn btn-secondary" (click)="viewTestDetails()">
                <span class="btn-icon">ğŸ“Š</span>
                æŸ¥çœ‹æµ‹è¯•è¯¦æƒ…
              </button>
              <button class="btn btn-info" (click)="navigateToManualTest()" 
                      *ngIf="testCompleted">
                <span class="btn-icon">ğŸ”§</span>
                æ‰‹åŠ¨å¹²é¢„æµ‹è¯•
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- æ­¥éª¤5: å¯¼å‡ºç»“æœ -->
      <div class="workflow-step" [class.completed]="resultExported" [class.disabled]="!testCompleted">
        <div class="step-number">5</div>
        <div class="step-content">
          <h3>ğŸ“„ å¯¼å‡ºç»“æœ</h3>
          <p>æµ‹è¯•å®Œæˆåå¯¼å‡ºè¯¦ç»†çš„æµ‹è¯•æŠ¥å‘Š</p>
          <div class="export-controls" *ngIf="testCompleted">
            <button class="btn btn-info" (click)="exportResults()">
              <span class="btn-icon">ğŸ“¤</span>
              å¯¼å‡ºæµ‹è¯•æŠ¥å‘Š
            </button>
            <button class="btn btn-secondary" (click)="resetWorkflow()">
              <span class="btn-icon">ğŸ”„</span>
              å¼€å§‹æ–°æµ‹è¯•
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- å½“å‰æµ‹è¯•çŠ¶æ€ -->
  <div class="current-test-section" *ngIf="selectedBatch">
    <h2>å½“å‰æµ‹è¯•çŠ¶æ€</h2>
    <div class="test-status-card">
      <div class="test-header">
        <h3>{{ selectedBatch.productModel }} - {{ selectedBatch.serialNumber }}</h3>
        <span class="test-status-badge" [class]="getTestStatusClass()">
          {{ getTestStatusText() }}
        </span>
      </div>
      
      <div class="test-progress" *ngIf="testInProgress">
        <div class="progress-info">
          <span>æµ‹è¯•è¿›åº¦: {{ currentTestProgress.completed }}/{{ currentTestProgress.total }}</span>
          <span class="progress-percentage">{{ getProgressPercentage() }}%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="getProgressPercentage()"></div>
        </div>
        <div class="progress-details">
          <span class="result-item passed">âœ… é€šè¿‡: {{ currentTestProgress.passed }}</span>
          <span class="result-item failed">âŒ å¤±è´¥: {{ currentTestProgress.failed }}</span>
          <span class="result-item pending">â³ å¾…æµ‹: {{ currentTestProgress.pending }}</span>
        </div>
      </div>
      
      <div class="test-summary" *ngIf="testCompleted">
        <div class="summary-stats">
          <div class="summary-item">
            <span class="summary-label">æ€»æµ‹è¯•ç‚¹:</span>
            <span class="summary-value">{{ selectedBatch.totalPoints }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">é€šè¿‡æ•°é‡:</span>
            <span class="summary-value passed">{{ finalResults.passed }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">å¤±è´¥æ•°é‡:</span>
            <span class="summary-value failed">{{ finalResults.failed }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">æˆåŠŸç‡:</span>
            <span class="summary-value">{{ getFinalSuccessRate() }}%</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- æœ€è¿‘æµ‹è¯•å†å² -->
  <div class="recent-tests-section">
    <h2>æœ€è¿‘æµ‹è¯•è®°å½•</h2>
    <div class="recent-tests-list" *ngIf="recentBatches.length > 0">
      <div class="test-record" *ngFor="let batch of recentBatches.slice(0, 5)">
        <div class="record-info">
          <h4>{{ batch.product_model }} - {{ batch.serial_number }}</h4>
          <p class="record-time">{{ formatTime(batch.created_at) }}</p>
        </div>
        <div class="record-status">
          <span class="status-badge" [class]="getBatchStatusClass(batch.overall_status)">
            {{ getBatchStatusText(batch.overall_status) }}
          </span>
          <span class="success-rate">{{ calculatePassRate(batch) }}%</span>
        </div>
        <div class="record-actions">
          <button class="btn-icon-small" (click)="viewBatchDetails(batch)" title="æŸ¥çœ‹è¯¦æƒ…">ğŸ‘ï¸</button>
          <button class="btn-icon-small" (click)="exportBatchReport(batch)" title="å¯¼å‡ºæŠ¥å‘Š">ğŸ“„</button>
        </div>
      </div>
    </div>
    <div class="empty-history" *ngIf="recentBatches.length === 0">
      <div class="empty-icon">ğŸ“‹</div>
      <p>æš‚æ— æµ‹è¯•è®°å½•</p>
      <p class="empty-hint">å®Œæˆç¬¬ä¸€æ¬¡æµ‹è¯•åï¼Œå†å²è®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
    </div>
  </div>

  <!-- åŠ è½½çŠ¶æ€ -->
  <div class="loading-overlay" *ngIf="loading">
    <div class="loading-spinner"></div>
    <p>{{ loadingMessage }}</p>
  </div>
</div>
