<div class="dashboard-container">
  <!-- 页面标题 -->
  <nz-card nzTitle="🏭 工厂测试系统仪表板" class="page-header-card">
    <p>欢迎使用工厂测试系统，请使用顶部导航栏进行操作</p>
    <nz-space nzAlign="center">
      <button *nzSpaceItem nz-button nzType="primary" (click)="onRefresh()">
        <span nz-icon nzType="reload" nzTheme="outline"></span>
        刷新数据
      </button>
      <button *nzSpaceItem nz-button nzType="dashed" (click)="createTestData()">
        <span nz-icon nzType="plus" nzTheme="outline"></span>
        创建测试数据
      </button>
      <nz-tag *nzSpaceItem [nzColor]="systemStatus?.system_health === 'healthy' ? 'green' : 'red'">
        {{ getSystemHealthText() }}
      </nz-tag>
    </nz-space>
  </nz-card>

  <!-- 系统状态概览 -->
  <div nz-row [nzGutter]="[16, 16]" class="statistics-row">
    <div nz-col nzXs="24" nzSm="12" nzMd="6">
      <nz-card>
        <nz-statistic
          nzTitle="系统状态"
          [nzValue]="getSystemHealthText()"
          [nzValueStyle]="{ color: systemStatus?.system_health === 'healthy' ? '#3f8600' : '#cf1322' }"
          nzPrefix="🏥">
        </nz-statistic>
        <small>版本: {{ systemStatus?.version || 'v1.0.0' }}</small>
      </nz-card>
    </div>

    <div nz-col nzXs="24" nzSm="12" nzMd="6">
      <nz-card>
        <nz-statistic
          nzTitle="活动测试"
          [nzValue]="systemStatus?.active_test_tasks || 0"
          [nzValueStyle]="{ color: '#1890ff' }"
          nzPrefix="🧪">
        </nz-statistic>
        <small>正在进行的测试任务</small>
      </nz-card>
    </div>

    <div nz-col nzXs="24" nzSm="12" nzMd="6">
      <nz-card>
        <nz-statistic
          nzTitle="待测批次"
          [nzValue]="pendingBatches"
          [nzValueStyle]="{ color: '#722ed1' }"
          nzPrefix="📦">
        </nz-statistic>
        <small>等待测试的批次数量</small>
      </nz-card>
    </div>

    <div nz-col nzXs="24" nzSm="12" nzMd="6">
      <nz-card>
        <nz-statistic
          nzTitle="成功率"
          [nzValue]="overallSuccessRate"
          nzSuffix="%"
          [nzValueStyle]="{ color: overallSuccessRate >= 90 ? '#3f8600' : overallSuccessRate >= 70 ? '#fa8c16' : '#cf1322' }"
          nzPrefix="📊">
        </nz-statistic>
        <small>最近测试的通过率</small>
      </nz-card>
    </div>
  </div>

  <!-- 图表展示区域 -->
  <div nz-row [nzGutter]="[16, 16]" class="charts-row">
    <div nz-col nzXs="24" nzSm="24" nzMd="8">
      <nz-card nzTitle="测试进度">
        <div echarts [options]="testProgressChartOption" class="chart-container"></div>
      </nz-card>
    </div>

    <div nz-col nzXs="24" nzSm="24" nzMd="8">
      <nz-card nzTitle="系统状态监控">
        <div echarts [options]="systemStatusChartOption" class="chart-container"></div>
      </nz-card>
    </div>

    <div nz-col nzXs="24" nzSm="24" nzMd="8">
      <nz-card nzTitle="批次状态分布">
        <div echarts [options]="batchStatusChartOption" class="chart-container"></div>
      </nz-card>
    </div>
  </div>

  <!-- 快速导航 -->
  <nz-card nzTitle="快速导航" class="quick-navigation-card">
    <div nz-row [nzGutter]="[16, 16]">
      <div nz-col nzXs="24" nzSm="12" nzMd="6">
        <nz-card nzHoverable class="nav-card" (click)="navigateToDataImport()">
          <div class="nav-content">
            <span nz-icon nzType="import" nzTheme="outline" class="nav-icon"></span>
            <h3>数据导入</h3>
            <p>导入Excel点位表文件</p>
          </div>
        </nz-card>
      </div>

      <div nz-col nzXs="24" nzSm="12" nzMd="6">
        <nz-card nzHoverable class="nav-card" (click)="navigateToTestArea()">
          <div class="nav-content">
            <span nz-icon nzType="experiment" nzTheme="outline" class="nav-icon"></span>
            <h3>测试区域</h3>
            <p>管理测试批次和执行测试</p>
          </div>
        </nz-card>
      </div>

      <div nz-col nzXs="24" nzSm="12" nzMd="6">
        <nz-card nzHoverable class="nav-card" (click)="navigateToManualTest()">
          <div class="nav-content">
            <span nz-icon nzType="tool" nzTheme="outline" class="nav-icon"></span>
            <h3>手动测试</h3>
            <p>手动控制和测试通道</p>
          </div>
        </nz-card>
      </div>

      <div nz-col nzXs="24" nzSm="12" nzMd="6">
        <nz-card nzHoverable class="nav-card" (click)="navigateToReports()">
          <div class="nav-content">
            <span nz-icon nzType="bar-chart" nzTheme="outline" class="nav-icon"></span>
            <h3>测试报告</h3>
            <p>查看和导出测试结果</p>
          </div>
        </nz-card>
      </div>
    </div>
  </nz-card>

  <!-- 最近批次 -->
  <nz-card nzTitle="最近批次" *ngIf="recentBatches.length > 0" class="recent-batches-card">
    <nz-list [nzDataSource]="recentBatches" nzItemLayout="horizontal">
      <ng-container *ngFor="let batch of recentBatches">
        <nz-list-item *ngIf="batch">
        <nz-list-item-meta
          [nzAvatar]="avatarTemplate"
          [nzTitle]="titleTemplate"
          [nzDescription]="descTemplate">

          <ng-template #avatarTemplate>
            <nz-avatar nzIcon="experiment" [ngStyle]="{ backgroundColor: getBatchStatusColor(batch?.overall_status || batch?.status) }"></nz-avatar>
          </ng-template>

          <ng-template #titleTemplate>
            <div class="batch-title">
              <a (click)="viewBatchDetails(batch)" class="batch-link">
                <strong>{{ batch?.batch_name || batch?.name || '批次' }}</strong>
                <span class="product-info">
                  {{ batch?.product_model || '未知产品' }}
                  <span *ngIf="batch?.serial_number"> - {{ batch?.serial_number }}</span>
                </span>
              </a>
              <div class="batch-tags">
                <nz-tag nzColor="blue">
                  <span nz-icon nzType="environment" nzTheme="outline"></span>
                  {{ (batch?.station_name || batch?.station || '未知站场') }}
                </nz-tag>
                <nz-tag [nzColor]="getBatchStatusColor(batch?.overall_status || batch?.status)">
                  {{ getBatchStatusText(batch?.overall_status || batch?.status) }}
                </nz-tag>
              </div>
            </div>
          </ng-template>

          <ng-template #descTemplate>
            <div class="batch-description">
              <!-- 第一行：基本统计信息 -->
              <div class="batch-stats-row">
                <nz-space nzAlign="center" nzSize="large">
                  <span *nzSpaceItem class="stat-item">
                    <span nz-icon nzType="database" nzTheme="outline" class="stat-icon"></span>
                    <strong>总点位:</strong> {{ batch?.total_points || batch?.totalPoints || 0 }}
                  </span>
                  <span *nzSpaceItem class="stat-item">
                    <span nz-icon nzType="check-circle" nzTheme="outline" class="stat-icon success"></span>
                    <strong>已测试:</strong> {{ batch?.tested_points || batch?.testedCount || 0 }}
                  </span>
                  <span *nzSpaceItem class="stat-item">
                    <span nz-icon nzType="clock-circle" nzTheme="outline" class="stat-icon pending"></span>
                    <strong>未测试:</strong> {{ getUntestedPoints(batch) }}
                  </span>
                </nz-space>
              </div>

              <!-- 第二行：测试结果统计 -->
              <div class="batch-results-row">
                <nz-space nzAlign="center" nzSize="large">
                  <span *nzSpaceItem class="stat-item">
                    <span nz-icon nzType="check" nzTheme="outline" class="stat-icon success"></span>
                    <strong>成功:</strong> {{ batch?.passed_points || batch?.successCount || 0 }}
                  </span>
                  <span *nzSpaceItem class="stat-item">
                    <span nz-icon nzType="close" nzTheme="outline" class="stat-icon error"></span>
                    <strong>失败:</strong> {{ batch?.failed_points || batch?.failureCount || 0 }}
                  </span>
                  <span *nzSpaceItem class="stat-item">
                    <span nz-icon nzType="minus" nzTheme="outline" class="stat-icon skipped"></span>
                    <strong>跳过:</strong> {{ batch?.skipped_points || 0 }}
                  </span>
                  <span *nzSpaceItem class="stat-item">
                    <span nz-icon nzType="percentage" nzTheme="outline" class="stat-icon"></span>
                    <strong>通过率:</strong> {{ calculatePassRate(batch) }}%
                  </span>
                </nz-space>
              </div>

              <!-- 第三行：时间和进度信息 -->
              <div class="batch-time-row">
                <nz-space nzAlign="center" nzSize="large">
                  <span *nzSpaceItem class="stat-item">
                    <span nz-icon nzType="calendar" nzTheme="outline" class="stat-icon"></span>
                    <strong>创建时间:</strong> {{ formatDetailedTime(batch?.creation_time || batch?.createdAt || '') }}
                  </span>
                  <span *nzSpaceItem class="stat-item">
                    <span *ngIf="getTestProgress(batch) > 0">
                      <span nz-icon nzType="loading" nzTheme="outline" class="stat-icon"></span>
                      <strong>测试进度:</strong> {{ getTestProgress(batch) }}%
                      <nz-progress
                        [nzPercent]="getTestProgress(batch)"
                        nzSize="small"
                        [nzStatus]="getProgressStatus(batch)"
                        [nzShowInfo]="false"
                        class="inline-progress">
                      </nz-progress>
                    </span>
                  </span>
                </nz-space>
              </div>
            </div>
          </ng-template>
        </nz-list-item-meta>

        <ul nz-list-item-actions>
          <nz-list-item-action>
            <button nz-button nzType="link" (click)="viewBatchDetails(batch)">
              <span nz-icon nzType="eye" nzTheme="outline"></span>
              查看详情
            </button>
          </nz-list-item-action>

          <nz-list-item-action>
            <button nz-button nzType="link" nzDanger (click)="deleteBatch(batch)">
              <span nz-icon nzType="delete" nzTheme="outline"></span>
              删除
            </button>
          </nz-list-item-action>
        </ul>
        </nz-list-item>
      </ng-container>
    </nz-list>
  </nz-card>

  <!-- 空状态提示 -->
  <nz-card *ngIf="recentBatches.length === 0 && !loading" class="empty-state-card">
    <div class="empty-state">
      <span nz-icon nzType="inbox" nzTheme="outline" class="empty-icon"></span>
      <h3>暂无测试批次</h3>
      <p>请先导入Excel文件创建测试批次</p>
      <button nz-button nzType="primary" (click)="navigateToDataImport()">
        <span nz-icon nzType="plus" nzTheme="outline"></span>
        开始导入数据
      </button>
    </div>
  </nz-card>

  <!-- 加载状态 -->
  <nz-card *ngIf="loading" class="loading-card">
    <div class="loading-state">
      <nz-spin nzSimple [nzSize]="'large'"></nz-spin>
      <p>{{ loadingMessage }}</p>
    </div>
  </nz-card>

  <!-- 错误状态 -->
  <nz-alert
    *ngIf="error"
    [nzMessage]="error"
    nzType="error"
    nzShowIcon
    nzClosable
    (nzOnClose)="error = null"
    class="error-alert">
  </nz-alert>
</div>
