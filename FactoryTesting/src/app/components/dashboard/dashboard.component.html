<div class="dashboard-container">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <nz-card nzTitle="ğŸ­ å·¥å‚æµ‹è¯•ç³»ç»Ÿä»ªè¡¨æ¿" class="page-header-card">
    <p>æ¬¢è¿ä½¿ç”¨å·¥å‚æµ‹è¯•ç³»ç»Ÿï¼Œè¯·ä½¿ç”¨é¡¶éƒ¨å¯¼èˆªæ è¿›è¡Œæ“ä½œ</p>
    <nz-space nzAlign="center">
      <button *nzSpaceItem nz-button nzType="primary" (click)="onRefresh()">
        <span nz-icon nzType="reload" nzTheme="outline"></span>
        åˆ·æ–°æ•°æ®
      </button>
      <button *nzSpaceItem nz-button nzType="dashed" (click)="createTestData()">
        <span nz-icon nzType="plus" nzTheme="outline"></span>
        åˆ›å»ºæµ‹è¯•æ•°æ®
      </button>
      <nz-tag *nzSpaceItem [nzColor]="systemStatus?.system_health === 'healthy' ? 'green' : 'red'">
        {{ getSystemHealthText() }}
      </nz-tag>
    </nz-space>
  </nz-card>

  <!-- ç³»ç»ŸçŠ¶æ€æ¦‚è§ˆ -->
  <div nz-row [nzGutter]="[16, 16]" class="statistics-row">
    <div nz-col nzXs="24" nzSm="12" nzMd="6">
      <nz-card>
        <nz-statistic
          nzTitle="ç³»ç»ŸçŠ¶æ€"
          [nzValue]="getSystemHealthText()"
          [nzValueStyle]="{ color: systemStatus?.system_health === 'healthy' ? '#3f8600' : '#cf1322' }"
          nzPrefix="ğŸ¥">
        </nz-statistic>
        <small>ç‰ˆæœ¬: {{ systemStatus?.version || 'v1.0.0' }}</small>
      </nz-card>
    </div>

    <div nz-col nzXs="24" nzSm="12" nzMd="6">
      <nz-card>
        <nz-statistic
          nzTitle="æ´»åŠ¨æµ‹è¯•"
          [nzValue]="systemStatus?.active_test_tasks || 0"
          [nzValueStyle]="{ color: '#1890ff' }"
          nzPrefix="ğŸ§ª">
        </nz-statistic>
        <small>æ­£åœ¨è¿›è¡Œçš„æµ‹è¯•ä»»åŠ¡</small>
      </nz-card>
    </div>

    <div nz-col nzXs="24" nzSm="12" nzMd="6">
      <nz-card>
        <nz-statistic
          nzTitle="å¾…æµ‹æ‰¹æ¬¡"
          [nzValue]="pendingBatches"
          [nzValueStyle]="{ color: '#722ed1' }"
          nzPrefix="ğŸ“¦">
        </nz-statistic>
        <small>ç­‰å¾…æµ‹è¯•çš„æ‰¹æ¬¡æ•°é‡</small>
      </nz-card>
    </div>

    <div nz-col nzXs="24" nzSm="12" nzMd="6">
      <nz-card>
        <nz-statistic
          nzTitle="æˆåŠŸç‡"
          [nzValue]="overallSuccessRate"
          nzSuffix="%"
          [nzValueStyle]="{ color: overallSuccessRate >= 90 ? '#3f8600' : overallSuccessRate >= 70 ? '#fa8c16' : '#cf1322' }"
          nzPrefix="ğŸ“Š">
        </nz-statistic>
        <small>æœ€è¿‘æµ‹è¯•çš„é€šè¿‡ç‡</small>
      </nz-card>
    </div>
  </div>

  <!-- å›¾è¡¨å±•ç¤ºåŒºåŸŸ -->
  <div nz-row [nzGutter]="[16, 16]" class="charts-row">
    <div nz-col nzXs="24" nzSm="24" nzMd="8">
      <nz-card nzTitle="æµ‹è¯•è¿›åº¦">
        <div echarts [options]="testProgressChartOption" class="chart-container"></div>
      </nz-card>
    </div>

    <div nz-col nzXs="24" nzSm="24" nzMd="8">
      <nz-card nzTitle="ç³»ç»ŸçŠ¶æ€ç›‘æ§">
        <div echarts [options]="systemStatusChartOption" class="chart-container"></div>
      </nz-card>
    </div>

    <div nz-col nzXs="24" nzSm="24" nzMd="8">
      <nz-card nzTitle="æ‰¹æ¬¡çŠ¶æ€åˆ†å¸ƒ">
        <div echarts [options]="batchStatusChartOption" class="chart-container"></div>
      </nz-card>
    </div>
  </div>

  <!-- å¿«é€Ÿå¯¼èˆª -->
  <nz-card nzTitle="å¿«é€Ÿå¯¼èˆª" class="quick-navigation-card">
    <div nz-row [nzGutter]="[16, 16]">
      <div nz-col nzXs="24" nzSm="12" nzMd="6">
        <nz-card nzHoverable class="nav-card" (click)="navigateToDataImport()">
          <div class="nav-content">
            <span nz-icon nzType="import" nzTheme="outline" class="nav-icon"></span>
            <h3>æ•°æ®å¯¼å…¥</h3>
            <p>å¯¼å…¥Excelç‚¹ä½è¡¨æ–‡ä»¶</p>
          </div>
        </nz-card>
      </div>

      <div nz-col nzXs="24" nzSm="12" nzMd="6">
        <nz-card nzHoverable class="nav-card" (click)="navigateToTestArea()">
          <div class="nav-content">
            <span nz-icon nzType="experiment" nzTheme="outline" class="nav-icon"></span>
            <h3>æµ‹è¯•åŒºåŸŸ</h3>
            <p>ç®¡ç†æµ‹è¯•æ‰¹æ¬¡å’Œæ‰§è¡Œæµ‹è¯•</p>
          </div>
        </nz-card>
      </div>

      <div nz-col nzXs="24" nzSm="12" nzMd="6">
        <nz-card nzHoverable class="nav-card" (click)="navigateToManualTest()">
          <div class="nav-content">
            <span nz-icon nzType="tool" nzTheme="outline" class="nav-icon"></span>
            <h3>æ‰‹åŠ¨æµ‹è¯•</h3>
            <p>æ‰‹åŠ¨æ§åˆ¶å’Œæµ‹è¯•é€šé“</p>
          </div>
        </nz-card>
      </div>

      <div nz-col nzXs="24" nzSm="12" nzMd="6">
        <nz-card nzHoverable class="nav-card" (click)="navigateToReports()">
          <div class="nav-content">
            <span nz-icon nzType="bar-chart" nzTheme="outline" class="nav-icon"></span>
            <h3>æµ‹è¯•æŠ¥å‘Š</h3>
            <p>æŸ¥çœ‹å’Œå¯¼å‡ºæµ‹è¯•ç»“æœ</p>
          </div>
        </nz-card>
      </div>
    </div>
  </nz-card>

  <!-- æœ€è¿‘æ‰¹æ¬¡ -->
  <nz-card nzTitle="æœ€è¿‘æ‰¹æ¬¡" *ngIf="recentBatches.length > 0" class="recent-batches-card">
    <nz-list [nzDataSource]="recentBatches" nzItemLayout="horizontal">
      <ng-container *ngFor="let batch of recentBatches">
        <nz-list-item *ngIf="batch">
        <nz-list-item-meta
          [nzAvatar]="avatarTemplate"
          [nzTitle]="titleTemplate"
          [nzDescription]="descTemplate">

          <ng-template #avatarTemplate>
            <nz-avatar nzIcon="experiment" [ngStyle]="{ backgroundColor: getBatchStatusColor(batch?.overall_status || batch?.status) }"></nz-avatar>
          </ng-template>

          <ng-template #titleTemplate>
            <div class="batch-title">
              <a (click)="viewBatchDetails(batch)" class="batch-link">
                <strong>{{ batch?.batch_name || batch?.name || 'æ‰¹æ¬¡' }}</strong>
                <span class="product-info">
                  {{ batch?.product_model || 'æœªçŸ¥äº§å“' }}
                  <span *ngIf="batch?.serial_number"> - {{ batch?.serial_number }}</span>
                </span>
              </a>
              <div class="batch-tags">
                <nz-tag nzColor="blue">
                  <span nz-icon nzType="environment" nzTheme="outline"></span>
                  {{ (batch?.station_name || batch?.station || 'æœªçŸ¥ç«™åœº') }}
                </nz-tag>
                <nz-tag [nzColor]="getBatchStatusColor(batch?.overall_status || batch?.status)">
                  {{ getBatchStatusText(batch?.overall_status || batch?.status) }}
                </nz-tag>
              </div>
            </div>
          </ng-template>

          <ng-template #descTemplate>
            <div class="batch-description">
              <!-- ç¬¬ä¸€è¡Œï¼šåŸºæœ¬ç»Ÿè®¡ä¿¡æ¯ -->
              <div class="batch-stats-row">
                <nz-space nzAlign="center" nzSize="large">
                  <span *nzSpaceItem class="stat-item">
                    <span nz-icon nzType="database" nzTheme="outline" class="stat-icon"></span>
                    <strong>æ€»ç‚¹ä½:</strong> {{ batch?.total_points || batch?.totalPoints || 0 }}
                  </span>
                  <span *nzSpaceItem class="stat-item">
                    <span nz-icon nzType="check-circle" nzTheme="outline" class="stat-icon success"></span>
                    <strong>å·²æµ‹è¯•:</strong> {{ batch?.tested_points || batch?.testedCount || 0 }}
                  </span>
                  <span *nzSpaceItem class="stat-item">
                    <span nz-icon nzType="clock-circle" nzTheme="outline" class="stat-icon pending"></span>
                    <strong>æœªæµ‹è¯•:</strong> {{ getUntestedPoints(batch) }}
                  </span>
                </nz-space>
              </div>

              <!-- ç¬¬äºŒè¡Œï¼šæµ‹è¯•ç»“æœç»Ÿè®¡ -->
              <div class="batch-results-row">
                <nz-space nzAlign="center" nzSize="large">
                  <span *nzSpaceItem class="stat-item">
                    <span nz-icon nzType="check" nzTheme="outline" class="stat-icon success"></span>
                    <strong>æˆåŠŸ:</strong> {{ batch?.passed_points || batch?.successCount || 0 }}
                  </span>
                  <span *nzSpaceItem class="stat-item">
                    <span nz-icon nzType="close" nzTheme="outline" class="stat-icon error"></span>
                    <strong>å¤±è´¥:</strong> {{ batch?.failed_points || batch?.failureCount || 0 }}
                  </span>
                  <span *nzSpaceItem class="stat-item">
                    <span nz-icon nzType="minus" nzTheme="outline" class="stat-icon skipped"></span>
                    <strong>è·³è¿‡:</strong> {{ batch?.skipped_points || 0 }}
                  </span>
                  <span *nzSpaceItem class="stat-item">
                    <span nz-icon nzType="percentage" nzTheme="outline" class="stat-icon"></span>
                    <strong>é€šè¿‡ç‡:</strong> {{ calculatePassRate(batch) }}%
                  </span>
                </nz-space>
              </div>

              <!-- ç¬¬ä¸‰è¡Œï¼šæ—¶é—´å’Œè¿›åº¦ä¿¡æ¯ -->
              <div class="batch-time-row">
                <nz-space nzAlign="center" nzSize="large">
                  <span *nzSpaceItem class="stat-item">
                    <span nz-icon nzType="calendar" nzTheme="outline" class="stat-icon"></span>
                    <strong>åˆ›å»ºæ—¶é—´:</strong> {{ formatDetailedTime(batch?.creation_time || batch?.createdAt || '') }}
                  </span>
                  <span *nzSpaceItem class="stat-item">
                    <span *ngIf="getTestProgress(batch) > 0">
                      <span nz-icon nzType="loading" nzTheme="outline" class="stat-icon"></span>
                      <strong>æµ‹è¯•è¿›åº¦:</strong> {{ getTestProgress(batch) }}%
                      <nz-progress
                        [nzPercent]="getTestProgress(batch)"
                        nzSize="small"
                        [nzStatus]="getProgressStatus(batch)"
                        [nzShowInfo]="false"
                        class="inline-progress">
                      </nz-progress>
                    </span>
                  </span>
                </nz-space>
              </div>
            </div>
          </ng-template>
        </nz-list-item-meta>

        <ul nz-list-item-actions>
          <nz-list-item-action>
            <button nz-button nzType="link" (click)="viewBatchDetails(batch)">
              <span nz-icon nzType="eye" nzTheme="outline"></span>
              æŸ¥çœ‹è¯¦æƒ…
            </button>
          </nz-list-item-action>

          <nz-list-item-action>
            <button nz-button nzType="link" nzDanger (click)="deleteBatch(batch)">
              <span nz-icon nzType="delete" nzTheme="outline"></span>
              åˆ é™¤
            </button>
          </nz-list-item-action>
        </ul>
        </nz-list-item>
      </ng-container>
    </nz-list>
  </nz-card>

  <!-- ç©ºçŠ¶æ€æç¤º -->
  <nz-card *ngIf="recentBatches.length === 0 && !loading" class="empty-state-card">
    <div class="empty-state">
      <span nz-icon nzType="inbox" nzTheme="outline" class="empty-icon"></span>
      <h3>æš‚æ— æµ‹è¯•æ‰¹æ¬¡</h3>
      <p>è¯·å…ˆå¯¼å…¥Excelæ–‡ä»¶åˆ›å»ºæµ‹è¯•æ‰¹æ¬¡</p>
      <button nz-button nzType="primary" (click)="navigateToDataImport()">
        <span nz-icon nzType="plus" nzTheme="outline"></span>
        å¼€å§‹å¯¼å…¥æ•°æ®
      </button>
    </div>
  </nz-card>

  <!-- åŠ è½½çŠ¶æ€ -->
  <nz-card *ngIf="loading" class="loading-card">
    <div class="loading-state">
      <nz-spin nzSimple [nzSize]="'large'"></nz-spin>
      <p>{{ loadingMessage }}</p>
    </div>
  </nz-card>

  <!-- é”™è¯¯çŠ¶æ€ -->
  <nz-alert
    *ngIf="error"
    [nzMessage]="error"
    nzType="error"
    nzShowIcon
    nzClosable
    (nzOnClose)="error = null"
    class="error-alert">
  </nz-alert>
</div>
