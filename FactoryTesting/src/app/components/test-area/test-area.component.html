<div class="test-area-container">
  <nz-card nzTitle="æµ‹è¯•åŒºåŸŸç®¡ç†" [nzExtra]="extraTemplate">
    <!-- é¡µé¢æ“ä½œæŒ‰é’® -->
    <ng-template #extraTemplate>
      <nz-space>
        <button
          *nzSpaceItem
          nz-button
          nzType="default"
          [nzLoading]="isConnecting"
          [disabled]="!selectedBatch || isConnecting || isConnected"
          (click)="confirmWiring()">
          <span nz-icon nzType="link" nzTheme="outline"></span>
          ç¡®è®¤æ¥çº¿
        </button>
        <button
          *nzSpaceItem
          nz-button
          nzType="primary"
          [nzLoading]="isAutoTesting"
          [disabled]="!selectedBatch || !isConnected || isAutoTesting"
          (click)="startAutoTest()">
          <span nz-icon nzType="play-circle" nzTheme="outline"></span>
          å¼€å§‹é€šé“è‡ªåŠ¨æµ‹è¯•
        </button>

        <button
          *nzSpaceItem
          nz-button
          nzType="default"
          [nzLoading]="isLoadingDetails"
          [disabled]="!selectedBatch || isLoadingDetails"
          (click)="refreshBatchDetails()">
          <span nz-icon nzType="reload" nzTheme="outline"></span>
          åˆ·æ–°çŠ¶æ€
        </button>

        <button
          *nzSpaceItem
          nz-button
          nzType="default"
          [disabled]="!selectedBatch"
          (click)="exportChannelAllocation()">
          <span nz-icon nzType="download" nzTheme="outline"></span>
          å¯¼å‡ºæ‰¹æ¬¡åˆ†é…
        </button>

        <!-- æµ‹è¯•çŠ¶æ€æ˜¾ç¤º -->
        <ng-container *nzSpaceItem>
          <div class="test-status-container" *ngIf="isAutoTesting">
            <nz-tag nzColor="processing">
              <i nz-icon nzType="loading" nzSpin></i>
              æ­£åœ¨è¿›è¡Œè‡ªåŠ¨æµ‹è¯•...
            </nz-tag>
          </div>
        </ng-container>


      </nz-space>
    </ng-template>

    <!-- æ‰¹æ¬¡é€‰æ‹©åŒºåŸŸ - å¯æŠ˜å  -->
    <div class="batch-selection-section">
      <nz-collapse nzExpandIconPosition="end">
        <nz-collapse-panel
          [nzActive]="batchPanelExpanded"
          (nzActiveChange)="onBatchPanelToggle($event)"
          [nzHeader]="getBatchPanelHeader()"
          [nzExtra]="batchPanelExtra">

          <ng-template #batchPanelExtra>
            <span class="batch-count-info">
              <i nz-icon nzType="database" nzTheme="outline"></i>
              {{ availableBatches.length }} ä¸ªæ‰¹æ¬¡
            </span>
          </ng-template>

          <nz-spin [nzSpinning]="isLoadingBatches">
            <div class="batch-list">
              <nz-empty
                *ngIf="availableBatches.length === 0 && !isLoadingBatches"
                nzNotFoundContent="æš‚æ— å¯ç”¨çš„æµ‹è¯•æ‰¹æ¬¡"
                [nzNotFoundImage]="'simple'">
                <div nz-empty-footer>
                  <span nz-typography nzType="secondary">
                    è¯·å…ˆåœ¨æ•°æ®ç®¡ç†é¡µé¢å¯¼å…¥Excelç‚¹è¡¨æ–‡ä»¶
                  </span>
                </div>
              </nz-empty>

              <div class="batch-cards" *ngIf="availableBatches.length > 0">
                <nz-card
                  *ngFor="let batch of availableBatches"
                  class="batch-card"
                  [class.selected]="selectedBatch?.batch_id === batch.batch_id"
                  (click)="selectBatch(batch)"
                  nzHoverable>
                  <div class="batch-header">
                    <h4>{{ batch.batch_name || batch.batch_id }}</h4>
                    <nz-tag [nzColor]="getStatusColor(batch.overall_status)">
                      {{ batch.status_summary || 'æœªå¼€å§‹' }}
                    </nz-tag>
                  </div>
                  <div class="batch-info">
                    <div class="batch-basic-info">
                      <p><strong>ç«™åœº:</strong> {{ batch.station_name || 'N/A' }}</p>
                      <p><strong>åˆ›å»ºæ—¶é—´:</strong> {{ formatDateTime(batch.creation_time || batch.created_at) }}</p>
                    </div>

                    <!-- æµ‹è¯•ç»Ÿè®¡ä¿¡æ¯ - å§‹ç»ˆæ˜¾ç¤º -->
                    <div class="batch-test-stats">
                      <div class="stats-grid">
                        <div class="stat-item">
                          <span class="stat-label">æ€»ç‚¹æ•°</span>
                          <span class="stat-value total">{{ getBatchTestStats(batch).totalPoints }}</span>
                        </div>
                        <div class="stat-item">
                          <span class="stat-label">å¾…æµ‹ç‚¹æ•°</span>
                          <span class="stat-value pending">{{ getBatchTestStats(batch).pendingPoints }}</span>
                        </div>
                        <div class="stat-item">
                          <span class="stat-label">å·²æµ‹ç‚¹æ•°</span>
                          <span class="stat-value tested">{{ getBatchTestStats(batch).testedPoints }}</span>
                        </div>
                        <div class="stat-item">
                          <span class="stat-label">æˆåŠŸç‚¹æ•°</span>
                          <span class="stat-value success">{{ getBatchTestStats(batch).successPoints }}</span>
                        </div>
                        <div class="stat-item">
                          <span class="stat-label">å¤±è´¥ç‚¹æ•°</span>
                          <span class="stat-value failed">{{ getBatchTestStats(batch).failedPoints }}</span>
                        </div>
                        <!--div class="stat-item">
                          <span class="stat-label">è·³è¿‡ç‚¹æ•°</span>
                          <span class="stat-value skipped">{{ getBatchTestStats(batch).skippedPoints }}</span>
                      </div-->
                      </div>
                    </div>
                  </div>
                </nz-card>
              </div>
            </div>
          </nz-spin>
        </nz-collapse-panel>
      </nz-collapse>
    </div>

    <!-- é€šé“è¯¦æƒ…åŒºåŸŸ -->
    <div class="channel-details-section" *ngIf="selectedBatch && batchDetails">
      <nz-divider></nz-divider>
      <h3>é€šé“è¯¦æƒ… - {{ selectedBatch.batch_name || selectedBatch.batch_id }}</h3>

      <nz-spin [nzSpinning]="isLoadingDetails">
        <div class="details-content">

          <!-- æµ‹è¯•è¿›åº¦åŒºåŸŸ -->
          <div class="test-progress-section" *ngIf="selectedBatch">
            <nz-card nzTitle="æµ‹è¯•è¿›åº¦" [nzSize]="'small'" class="progress-card">
              <div class="progress-content">
                <!-- è¿›åº¦æ¡å’Œç»Ÿè®¡ -->
                <div class="progress-main">
                  <div class="progress-header">
                    <h4>{{ selectedBatch.batch_name || selectedBatch.batch_id }}</h4>
                    <div class="progress-percentage">
                      <span class="percentage-text">{{ testProgress.progressPercentage.toFixed(1) }}%</span>
                      <nz-tag [nzColor]="getTestStatusColor()">
                        {{ getTestStatusText() }}
                      </nz-tag>
                    </div>
                  </div>

                  <nz-progress
                    [nzPercent]="testProgress.progressPercentage"
                    [nzStatus]="getProgressStatus()"
                    [nzStrokeColor]="getProgressColor()"
                    nzSize="default"
                    [nzShowInfo]="false">
                  </nz-progress>

                  <div class="progress-info">
                    <span>{{ testProgress.completedPoints }} / {{ testProgress.totalPoints }} ä¸ªç‚¹ä½å·²å®Œæˆ</span>
                    <span *ngIf="testProgress.currentPoint" class="current-test">
                      å½“å‰æµ‹è¯•: {{ testProgress.currentPoint }}
                    </span>
                    <span *ngIf="isTestCompleted" class="completion-status">
                      âœ… æµ‹è¯•å·²å®Œæˆ
                    </span>
                  </div>
                </div>

                <!-- è¯¦ç»†ç»Ÿè®¡ -->
                <div class="progress-stats">
                  <div class="stats-row">
                    <div class="stat-item success">
                      <span class="stat-icon">âœ…</span>
                      <span class="stat-label">æˆåŠŸ</span>
                      <span class="stat-value">{{ testProgress.successPoints }}</span>
                    </div>
                    <div class="stat-item failed">
                      <span class="stat-icon">âŒ</span>
                      <span class="stat-label">å¤±è´¥</span>
                      <span class="stat-value">{{ testProgress.failedPoints }}</span>
                    </div>
                    <div class="stat-item pending">
                      <span class="stat-icon">â³</span>
                      <span class="stat-label">å¾…æµ‹</span>
                      <span class="stat-value">{{ testProgress.totalPoints - testProgress.completedPoints }}</span>
                    </div>
                    <div class="stat-item testing" *ngIf="isAutoTesting">
                      <span class="stat-icon">ğŸ”„</span>
                      <span class="stat-label">æµ‹è¯•ä¸­</span>
                      <span class="stat-value">{{ getTestingCount() }}</span>
                    </div>
                  </div>
                </div>

                <!-- æœ€è¿‘æµ‹è¯•ç»“æœ -->
                <div class="recent-results" *ngIf="recentTestResults.length > 0">
                  <div class="recent-header">
                    <span>æœ€è¿‘æµ‹è¯•ç»“æœ:</span>
                  </div>
                  <div class="recent-list">
                    <nz-tag
                      *ngFor="let result of recentTestResults.slice(-5)"
                      [nzColor]="result.success ? 'success' : 'error'"
                      class="result-tag">
                      {{ result.pointTag }}: {{ result.success ? 'æˆåŠŸ' : 'å¤±è´¥' }}
                    </nz-tag>
                  </div>
                </div>
              </div>
            </nz-card>
          </div>

          <!-- ç­›é€‰å·¥å…·æ  -->
          <div class="filter-toolbar">
            <div class="filter-row">
              <div class="filter-item">
                <label>æœç´¢:</label>
                <nz-input-group nzCompact>
                  <input 
                    nz-input 
                    placeholder="æœç´¢ç‚¹ä½åã€å˜é‡åæˆ–æè¿°"
                    [(ngModel)]="searchText"
                    style="width: 250px;">
                  <button nz-button nzType="primary" nzSearch>
                    <i nz-icon nzType="search"></i>
                  </button>
                </nz-input-group>
              </div>
              
              <div class="filter-item">
                <label>é€šé“ç±»å‹:</label>
                <nz-select
                  nzMode="multiple"
                  nzPlaceHolder="é€‰æ‹©é€šé“ç±»å‹"
                  [(ngModel)]="selectedModuleTypes"
                  (ngModelChange)="onModuleTypeFilterChange()"
                  style="width: 200px;">
                  <nz-option 
                    *ngFor="let option of moduleTypeOptions"
                    [nzLabel]="option.label + ' (' + option.count + ')'"
                    [nzValue]="option.value">
                  </nz-option>
                </nz-select>
              </div>
              
              <div class="filter-item">
                <nz-checkbox [(ngModel)]="showOnlyTested" (ngModelChange)="onFilterChange()">ä»…æ˜¾ç¤ºå·²æµ‹è¯•</nz-checkbox>
              </div>
              
              <div class="filter-item">
                <nz-checkbox [(ngModel)]="showOnlyFailed" (ngModelChange)="onFilterChange()">ä»…æ˜¾ç¤ºå¤±è´¥</nz-checkbox>
              </div>
              
              <div class="filter-item">
                <button nz-button (click)="clearAllFilters()">
                  <i nz-icon nzType="clear"></i>
                  æ¸…é™¤ç­›é€‰
                </button>
              </div>
            </div>
            
            <div class="filter-status">
              <span>{{ getFilterStatusText() }}</span>
              <nz-divider nzType="vertical"></nz-divider>
              <span class="scroll-hint">
                <i nz-icon nzType="info-circle" nzTheme="outline"></i>
                è¡¨æ ¼æ”¯æŒæ»šåŠ¨æŸ¥çœ‹æ‰€æœ‰æ•°æ®
              </span>
            </div>
          </div>

          <!-- é€šé“åˆ—è¡¨è¡¨æ ¼ -->
          <nz-table
            #channelTable
            [nzData]="getFilteredInstances()"
            [nzPageSize]="0"
            [nzShowPagination]="false"
            [nzScroll]="{ x: '1200px', y: '800px' }"
            nzSize="small">

            <thead>
              <tr>
                <th nzWidth="80px">åºå·</th>
                <th>ç‚¹ä½åç§°</th>
                <th>æµ‹è¯•PLCé€šé“å·</th>
                <th>è¢«æµ‹PLCé€šé“å·</th>
                <th>é€šé“ç±»å‹</th>
                <th>æ•°æ®ç±»å‹</th>
                <th>é”™è¯¯è¯¦æƒ…</th>
                <th>æµ‹è¯•çŠ¶æ€</th>
                <th>ç¡¬ç‚¹é‡æµ‹</th>
                <th>ä¸Šä½æœºæµ‹è¯•</th>
              </tr>
            </thead>
            
            <tbody>
              <tr *ngFor="let instance of filteredInstances; trackBy: trackByInstanceId"
                  [class]="getRowClassName(instance, 0)">
                <td>
                  <span class="sequence-number">
                    {{ getDefinitionByInstanceId(instance.instance_id)?.sequenceNumber || '-' }}
                  </span>
                </td>
                <td>
                  <strong>{{ getDefinitionByInstanceId(instance.instance_id)?.tag || 'N/A' }}</strong>
                </td>
                <td>
                  <nz-tag nzColor="blue">
                    {{ instance.test_plc_channel_tag || 'AO1_1' }}
                  </nz-tag>
                </td>
                <td>
                  <nz-tag nzColor="green">
                    {{ getDefinitionByInstanceId(instance.instance_id)?.channel_number || 'N/A' }}
                  </nz-tag>
                </td>
                <td>
                  <nz-tag [nzColor]="getModuleTypeColor(getDefinitionByInstanceId(instance.instance_id)?.module_type)">
                    {{ getDefinitionByInstanceId(instance.instance_id)?.module_type || 'N/A' }}
                  </nz-tag>
                </td>
                <td>
                  <nz-tag [nzColor]="getPointDataTypeColor(getDefinitionByInstanceId(instance.instance_id)?.point_data_type)">
                    {{ getPointDataTypeLabel(getDefinitionByInstanceId(instance.instance_id)?.point_data_type) }}
                  </nz-tag>
                </td>
                <td>
                  <div class="error-detail-cell">
                    <!-- é”™è¯¯ä¿¡æ¯æ˜¾ç¤º -->
                    <div class="error-text">
                      <span *ngIf="instance.error_message && instance.error_message.trim()" class="error-message">
                        {{ instance.error_message }}
                      </span>
                      <span *ngIf="instance.overall_status === OverallTestStatus.TestCompletedFailed && (!instance.error_message || !instance.error_message.trim())" class="error-message">
                        æµ‹è¯•å¤±è´¥ - æœªçŸ¥é”™è¯¯
                      </span>
                      <span *ngIf="instance.overall_status === OverallTestStatus.TestCompletedPassed" class="success-message">
                        æµ‹è¯•é€šè¿‡
                      </span>
                      <span *ngIf="instance.overall_status === OverallTestStatus.NotTested || instance.overall_status === OverallTestStatus.WiringConfirmed" class="no-error">
                        æœªæµ‹è¯•
                      </span>
                    </div>

                    <!-- é”™è¯¯è¯¦æƒ…æŒ‰é’® -->
                    <div class="error-actions" *ngIf="hasErrorDetails(instance)">
                      <button
                        nz-button
                        nzType="link"
                        nzSize="small"
                        (click)="showErrorDetail(instance)"
                        class="error-detail-btn">
                        <span nz-icon nzType="eye" nzTheme="outline"></span>
                        æŸ¥çœ‹è¯¦æƒ…
                      </button>
                    </div>
                  </div>
                  <span *ngIf="instance.overall_status === OverallTestStatus.HardPointTesting || instance.overall_status === OverallTestStatus.AlarmTesting" class="testing-message">
                    æµ‹è¯•ä¸­...
                  </span>
                </td>
                <td>
                  <nz-tag [nzColor]="getInstanceStatusColor(instance.overall_status)">
                    {{ getInstanceStatusText(instance.overall_status) }}
                  </nz-tag>
                </td>
                <td>
                  <button
                    nz-button
                    nzType="primary"
                    nzSize="small"
                    [disabled]="isChannelTestDisabled(instance)"
                    [nzLoading]="instance.overall_status === OverallTestStatus.HardPointTesting"
                    (click)="startSingleChannelTest(instance)">
                    <i nz-icon nzType="play-circle" *ngIf="instance.overall_status !== OverallTestStatus.HardPointTesting"></i>
                    {{ getChannelTestButtonText(instance) }}
                  </button>
                </td>
                <td>
                  <button
                    nz-button
                    nzType="default"
                    nzSize="small"
                    [disabled]="!isManualTestEnabled(instance)"
                    (click)="startManualTest(instance)">
                    <i nz-icon nzType="setting"></i>
                    ä¸Šä½æœºæµ‹è¯•
                  </button>
                </td>
              </tr>
            </tbody>
          </nz-table>
        </div>
      </nz-spin>
    </div>
  </nz-card>

  <!-- é”™è¯¯è¯¦æƒ…æ¨¡æ€æ¡† -->
  <app-error-detail-modal
    [(visible)]="errorDetailModalVisible"
    [instance]="selectedErrorInstance"
    [definition]="selectedErrorDefinition"
    (visibleChange)="closeErrorDetailModal()">
  </app-error-detail-modal>

  <!-- æ‰‹åŠ¨æµ‹è¯•æ¨¡æ€æ¡† -->
  <app-manual-test-modal
    [(visible)]="manualTestModalVisible"
    [instance]="selectedManualTestInstance"
    [definition]="selectedManualTestDefinition"
    (visibleChange)="closeManualTestModal()"
    (testCompleted)="onManualTestCompleted()">
  </app-manual-test-modal>

</div>