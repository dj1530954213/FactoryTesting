<div class="test-area-container">
  <nz-card nzTitle="测试区域管理" [nzExtra]="extraTemplate">
    <!-- 页面操作按钮 -->
    <ng-template #extraTemplate>
      <nz-space>
        <button
          *nzSpaceItem
          nz-button
          nzType="default"
          [nzLoading]="isConnecting"
          [disabled]="!selectedBatch || isConnecting || isConnected"
          (click)="confirmWiring()">
          <span nz-icon nzType="link" nzTheme="outline"></span>
          确认接线
        </button>
        <button
          *nzSpaceItem
          nz-button
          nzType="primary"
          [nzLoading]="isAutoTesting"
          [disabled]="!selectedBatch || !isConnected || isAutoTesting"
          (click)="startAutoTest()">
          <span nz-icon nzType="play-circle" nzTheme="outline"></span>
          开始通道自动测试
        </button>

        <button
          *nzSpaceItem
          nz-button
          nzType="default"
          [nzLoading]="isRetestingFailed"
          [disabled]="!selectedBatch || !isConnected || isRetestingFailed || !hasFailedHardPoints()"
          (click)="retestFailedHardPoints()">
          <span nz-icon nzType="history" nzTheme="outline"></span>
          失败点位重测
        </button>

        <button
          *nzSpaceItem
          nz-button
          nzType="default"
          [nzLoading]="isLoadingDetails"
          [disabled]="!selectedBatch || isLoadingDetails"
          (click)="refreshBatchDetails()">
          <span nz-icon nzType="reload" nzTheme="outline"></span>
          刷新状态
        </button>

        <button
          *nzSpaceItem
          nz-button
          nzType="default"
          [disabled]="!selectedBatch"
          (click)="exportChannelAllocation()">
          <span nz-icon nzType="download" nzTheme="outline"></span>
          导出批次分配
        </button>

        <!-- 测试状态显示 -->
        <ng-container *nzSpaceItem>
          <div class="test-status-container" *ngIf="isAutoTesting">
            <nz-tag nzColor="processing">
              <i nz-icon nzType="loading" nzSpin></i>
              正在进行自动测试...
            </nz-tag>
          </div>
        </ng-container>


      </nz-space>
    </ng-template>

    <!-- 批次选择区域 - 可折叠 -->
    <div class="batch-selection-section">
      <nz-collapse nzExpandIconPosition="end">
        <nz-collapse-panel
          [nzActive]="batchPanelExpanded"
          (nzActiveChange)="onBatchPanelToggle($event)"
          [nzHeader]="getBatchPanelHeader()"
          [nzExtra]="batchPanelExtra">

          <ng-template #batchPanelExtra>
            <span class="batch-count-info">
              <i nz-icon nzType="database" nzTheme="outline"></i>
              {{ availableBatches.length }} 个批次
            </span>
          </ng-template>

          <nz-spin [nzSpinning]="isLoadingBatches">
            <div class="batch-list">
              <nz-empty
                *ngIf="availableBatches.length === 0 && !isLoadingBatches"
                nzNotFoundContent="暂无可用的测试批次"
                [nzNotFoundImage]="'simple'">
                <div nz-empty-footer>
                  <span nz-typography nzType="secondary">
                    请先在数据管理页面导入Excel点表文件
                  </span>
                </div>
              </nz-empty>

              <div class="batch-cards" *ngIf="availableBatches.length > 0">
                <nz-card
                  *ngFor="let batch of availableBatches"
                  class="batch-card"
                  [class.selected]="selectedBatch?.batch_id === batch.batch_id"
                  (click)="selectBatch(batch)"
                  nzHoverable>
                  <div class="batch-header">
                    <h4>{{ batch.batch_name || batch.batch_id }}</h4>
                    <nz-tag [nzColor]="getBatchSelectionStatus(batch).color">
                      {{ getBatchSelectionStatus(batch).status }}
                    </nz-tag>
                  </div>
                  <div class="batch-info">
                    <div class="batch-basic-info">
                      <p><strong>站场:</strong> {{ batch.station_name || 'N/A' }}</p>
                      <p><strong>创建时间:</strong> {{ formatDateTime(batch.creation_time || batch.created_at) }}</p>
                    </div>

                    <!-- 测试统计信息 - 始终显示 -->
                    <div class="batch-test-stats">
                      <div class="stats-grid">
                        <div class="stat-item">
                          <span class="stat-label">总点数</span>
                          <span class="stat-value total">{{ getBatchTestStats(batch).totalPoints }}</span>
                        </div>
                        <div class="stat-item">
                          <span class="stat-label">待测点数</span>
                          <span class="stat-value pending">{{ getBatchTestStats(batch).pendingPoints }}</span>
                        </div>
                        <div class="stat-item">
                          <span class="stat-label">已测点数</span>
                          <span class="stat-value tested">{{ getBatchTestStats(batch).testedPoints }}</span>
                        </div>
                        <div class="stat-item">
                          <span class="stat-label">成功点数</span>
                          <span class="stat-value success">{{ getBatchTestStats(batch).successPoints }}</span>
                        </div>
                        <div class="stat-item">
                          <span class="stat-label">失败点数</span>
                          <span class="stat-value failed">{{ getBatchTestStats(batch).failedPoints }}</span>
                        </div>
                        <!--div class="stat-item">
                          <span class="stat-label">跳过点数</span>
                          <span class="stat-value skipped">{{ getBatchTestStats(batch).skippedPoints }}</span>
                      </div-->
                      </div>
                    </div>
                  </div>
                </nz-card>
              </div>
            </div>
          </nz-spin>
        </nz-collapse-panel>
      </nz-collapse>
    </div>

    <!-- 通道详情区域 -->
    <div class="channel-details-section" *ngIf="selectedBatch && batchDetails">
      <nz-divider></nz-divider>
      <h3>通道详情 - {{ selectedBatch.batch_name || selectedBatch.batch_id }}</h3>

      <nz-spin [nzSpinning]="isLoadingDetails">
        <div class="details-content">

          <!-- 测试进度区域 -->
          <div class="test-progress-section" *ngIf="selectedBatch">
            <nz-card nzTitle="测试进度" [nzSize]="'small'" class="progress-card">
              <div class="progress-content">
                <!-- 进度条和统计 -->
                <div class="progress-main">
                  <div class="progress-header">
                    <h4>{{ selectedBatch.batch_name || selectedBatch.batch_id }}</h4>
                    <div class="progress-percentage">
                      <span class="percentage-text">{{ testProgress.progressPercentage.toFixed(1) }}%</span>
                      <nz-tag [nzColor]="getTestStatusColor()">
                        {{ getTestStatusText() }}
                      </nz-tag>
                    </div>
                  </div>

                  <nz-progress
                    [nzPercent]="testProgress.progressPercentage"
                    [nzStatus]="getProgressStatus()"
                    [nzStrokeColor]="getProgressColor()"
                    nzSize="default"
                    [nzShowInfo]="false">
                  </nz-progress>

                  <div class="progress-info">
                    <span>{{ testProgress.completedPoints }} / {{ testProgress.totalPoints }} 个点位已完成</span>
                    <span *ngIf="testProgress.currentPoint" class="current-test">
                      当前测试: {{ testProgress.currentPoint }}
                    </span>
                    <span *ngIf="isTestCompleted" class="completion-status">
                      ✅ 测试已完成
                    </span>
                  </div>
                </div>

                <!-- 最近测试结果 -->
                <div class="recent-results" *ngIf="recentTestResults.length > 0">
                  <div class="recent-header">
                    <span>最近测试结果:</span>
                  </div>
                  <div class="recent-list">
                    <nz-tag
                      *ngFor="let result of recentTestResults.slice(-5)"
                      [nzColor]="result.success ? 'success' : 'error'"
                      class="result-tag">
                      {{ result.pointTag }}: {{ result.success ? '成功' : '失败' }}
                    </nz-tag>
                  </div>
                </div>
              </div>
            </nz-card>
          </div>

          <!-- 筛选工具栏 -->
          <div class="filter-toolbar">
            <div class="filter-row">
              <div class="filter-item">
                <label>搜索:</label>
                <nz-input-group nzCompact>
                  <input 
                    nz-input 
                    placeholder="搜索点位名、变量名或描述"
                    [(ngModel)]="searchText"
                    style="width: 250px;">
                  <button nz-button nzType="primary" nzSearch>
                    <i nz-icon nzType="search"></i>
                  </button>
                </nz-input-group>
              </div>
              
              <div class="filter-item">
                <label>通道类型:</label>
                <nz-select
                  nzMode="multiple"
                  nzPlaceHolder="选择通道类型"
                  [(ngModel)]="selectedModuleTypes"
                  (ngModelChange)="onModuleTypeFilterChange()"
                  style="width: 200px;">
                  <nz-option 
                    *ngFor="let option of moduleTypeOptions"
                    [nzLabel]="option.label + ' (' + option.count + ')'"
                    [nzValue]="option.value">
                  </nz-option>
                </nz-select>
              </div>
              
              <div class="filter-item">
                <label nz-checkbox [(ngModel)]="showOnlyTested" (ngModelChange)="onFilterChange()">仅显示已测试</label>
              </div>
              
              <div class="filter-item">
                <label nz-checkbox [(ngModel)]="showOnlyPassed" (ngModelChange)="onFilterChange()">仅显示已通过</label>
              </div>
              
              <div class="filter-item">
                <label nz-checkbox [(ngModel)]="showOnlyFailed" (ngModelChange)="onFilterChange()">仅显示失败</label>
              </div>
              
              <div class="filter-item">
                <label nz-checkbox [(ngModel)]="showOnlyHardPointPassed" (ngModelChange)="onFilterChange()">仅显示硬点测试通过</label>
              </div>
              
              <div class="filter-item">
                <label nz-checkbox [(ngModel)]="showOnlyNotTested" (ngModelChange)="onFilterChange()">仅显示未测试</label>
              </div>
              
              <div class="filter-item">
                <button nz-button (click)="clearAllFilters()">
                  <i nz-icon nzType="clear"></i>
                  清除筛选
                </button>
              </div>
            </div>
            
            <div class="filter-status">
              <span>{{ getFilterStatusText() }}</span>
              <nz-divider nzType="vertical"></nz-divider>
              <span class="scroll-hint">
                <i nz-icon nzType="info-circle" nzTheme="outline"></i>
                表格支持滚动查看所有数据
              </span>
            </div>
          </div>

          <!-- 通道列表表格 -->
          <nz-table
            #channelTable
            [nzData]="getFilteredInstances()"
            [nzPageSize]="0"
            [nzShowPagination]="false"
            [nzScroll]="{ x: '1200px', y: '800px' }"
            nzSize="small">

            <thead>
              <tr>
                <th nzWidth="80px">序号</th>
                <th>点位名称</th>
                <th>测试PLC通道号</th>
                <th>被测PLC通道号</th>
                <th>通道类型</th>
                <th>数据类型</th>
                <th>错误详情</th>
                <th>测试状态</th>
                <th>硬点重测</th>
                <th>上位机测试</th>
              </tr>
            </thead>
            
            <tbody>
              <tr *ngFor="let instance of filteredInstances; trackBy: trackByInstanceId"
                  [class]="getRowClassName(instance, 0)">
                <td>
                  <span class="sequence-number">
                    {{ getDefinitionByInstanceId(instance.instance_id)?.sequenceNumber || '-' }}
                  </span>
                </td>
                <td>
                  <strong>{{ getDefinitionByInstanceId(instance.instance_id)?.tag || 'N/A' }}</strong>
                </td>
                <td>
                  <nz-tag nzColor="blue">
                    {{ instance.test_plc_channel_tag || 'AO1_1' }}
                  </nz-tag>
                </td>
                <td>
                  <nz-tag nzColor="green">
                    {{ getDefinitionByInstanceId(instance.instance_id)?.channel_number || 'N/A' }}
                  </nz-tag>
                </td>
                <td>
                  <nz-tag [nzColor]="getModuleTypeColor(getDefinitionByInstanceId(instance.instance_id)?.module_type)">
                    {{ getDefinitionByInstanceId(instance.instance_id)?.module_type || 'N/A' }}
                  </nz-tag>
                </td>
                <td>
                  <nz-tag [nzColor]="getPointDataTypeColor(getDefinitionByInstanceId(instance.instance_id)?.point_data_type)">
                    {{ getPointDataTypeLabel(getDefinitionByInstanceId(instance.instance_id)?.point_data_type) }}
                  </nz-tag>
                </td>
                <td>
                  <div class="error-detail-cell">
                    <!-- 错误信息显示 -->
                    <div class="error-text">
                      <span *ngIf="instance.error_message && instance.error_message.trim()" class="error-message">
                        {{ instance.error_message }}
                      </span>
                      <span *ngIf="instance.overall_status === OverallTestStatus.TestCompletedFailed && (!instance.error_message || !instance.error_message.trim())" class="error-message">
                        测试失败 - 未知错误
                      </span>
                      <span *ngIf="instance.overall_status === OverallTestStatus.TestCompletedPassed" class="success-message">
                        测试通过
                      </span>
                      <span *ngIf="instance.overall_status === OverallTestStatus.NotTested || instance.overall_status === OverallTestStatus.WiringConfirmed" class="no-error">
                        未测试
                      </span>
                    </div>

                    <!-- 错误详情按钮 -->
                    <div class="error-actions" *ngIf="hasErrorDetails(instance)">
                      <button
                        nz-button
                        nzType="link"
                        nzSize="small"
                        (click)="showErrorDetail(instance)"
                        class="error-detail-btn">
                        <span nz-icon nzType="eye" nzTheme="outline"></span>
                        查看详情
                      </button>
                    </div>
                  </div>
                  <span *ngIf="instance.overall_status === OverallTestStatus.HardPointTesting || instance.overall_status === OverallTestStatus.AlarmTesting" class="testing-message">
                    测试中...
                  </span>
                </td>
                <td>
                  <nz-tag [nzColor]="getInstanceStatusColor(instance.overall_status)">
                    {{ getInstanceStatusText(instance.overall_status) }}
                  </nz-tag>
                </td>
                <td>
                  <button
                    nz-button
                    nzType="primary"
                    nzSize="small"
                    [disabled]="isChannelTestDisabled(instance)"
                    [nzLoading]="instance.overall_status === OverallTestStatus.HardPointTesting"
                    (click)="startSingleChannelTest(instance)">
                    <i nz-icon nzType="play-circle" *ngIf="instance.overall_status !== OverallTestStatus.HardPointTesting"></i>
                    {{ getChannelTestButtonText(instance) }}
                  </button>
                </td>
                <td>
                  <div class="manual-test-actions">
                    <button
                      nz-button
                      [nzType]="isManualTestFailed(instance) ? 'primary' : 'default'"
                      nzSize="small"
                      [disabled]="!isManualTestEnabled(instance)"
                      (click)="startManualTest(instance)">
                      <i nz-icon 
                         [nzType]="isManualTestFailed(instance) ? 'redo' : 'setting'"></i>
                      {{ getManualTestButtonText(instance) }}
                    </button>
                    <button
                      *ngIf="showErrorNotesButton(instance)"
                      nz-button
                      nzType="default"
                      nzSize="small"
                      nzTitle="添加错误备注"
                      (click)="openErrorNotesModal(instance)"
                      style="margin-left: 4px;">
                      <i nz-icon nzType="edit"></i>
                      备注
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </nz-table>
        </div>
      </nz-spin>
    </div>
  </nz-card>

  <!-- 错误详情模态框 -->
  <app-error-detail-modal
    [(visible)]="errorDetailModalVisible"
    [instance]="selectedErrorInstance"
    [definition]="selectedErrorDefinition"
    (visibleChange)="closeErrorDetailModal()">
  </app-error-detail-modal>

  <!-- 手动测试模态框 -->
  <app-manual-test-modal
    [(visible)]="manualTestModalVisible"
    [instance]="selectedManualTestInstance"
    [definition]="selectedManualTestDefinition"
    (visibleChange)="closeManualTestModal()"
    (testCompleted)="onManualTestCompleted()">
  </app-manual-test-modal>

  <!-- 错误备注模态框 -->
  <app-error-notes-modal
    [(visible)]="errorNotesModalVisible"
    [instance]="selectedErrorNotesInstance"
    [definition]="selectedErrorNotesDefinition"
    (visibleChange)="closeErrorNotesModal()"
    (notesSaved)="onErrorNotesSaved()">
  </app-error-notes-modal>

</div>