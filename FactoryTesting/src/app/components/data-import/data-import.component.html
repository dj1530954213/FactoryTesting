<div class="data-import-container">
  <div class="page-header">
    <h1>ğŸ“¥ æ•°æ®å¯¼å…¥ä¸æ‰¹æ¬¡åˆ›å»º</h1>
    <p>å¯¼å…¥Excelç‚¹ä½è¡¨ï¼Œåˆ›å»ºæµ‹è¯•æ‰¹æ¬¡ï¼Œå¼€å§‹å·¥å‚æµ‹è¯•æµç¨‹</p>
    
    <!-- è°ƒè¯•æµ‹è¯•æŒ‰é’® -->
    <div class="debug-section" style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 5px;">
      <button class="btn btn-secondary" (click)="testTauriApi()" style="margin-right: 10px;">
        ğŸ”§ æµ‹è¯•Tauri API
      </button>
      <small>è°ƒè¯•ç”¨ï¼šæµ‹è¯•åç«¯APIè¿æ¥çŠ¶æ€</small>
    </div>
  </div>

  <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
  <div class="steps-indicator">
    <div class="step" [class.active]="currentStep >= 1" [class.completed]="currentStep > 1">
      <div class="step-number">1</div>
      <div class="step-label">é€‰æ‹©æ–‡ä»¶</div>
    </div>
    <div class="step" [class.active]="currentStep >= 2" [class.completed]="currentStep > 2">
      <div class="step-number">2</div>
      <div class="step-label">é¢„è§ˆæ•°æ®</div>
    </div>
    <div class="step" [class.active]="currentStep >= 3">
      <div class="step-number">3</div>
      <div class="step-label">å¼€å§‹æµ‹è¯•</div>
    </div>
  </div>

  <!-- æ­¥éª¤1: æ–‡ä»¶é€‰æ‹© -->
  <div class="import-section" *ngIf="currentStep === 1">
    <!-- é”™è¯¯æç¤º -->
    <div class="error-alert" *ngIf="error">
      <div class="error-icon">âš ï¸</div>
      <div class="error-content">
        <p>{{ error }}</p>
        <button class="btn-close" (click)="clearError()">Ã—</button>
      </div>
    </div>

    <!-- åŠ è½½çŠ¶æ€ -->
    <div class="loading-overlay" *ngIf="isLoading">
      <div class="loading-spinner"></div>
      <p>{{ loadingMessage }}</p>
    </div>

    <div class="file-upload-area">
      <div class="upload-zone" 
           (click)="selectFile()" 
           [class.dragover]="isDragOver"
           [class.has-file]="selectedFileName"
           (dragenter)="onDragEnter($event)"
           (dragleave)="onDragLeave($event)"
           (dragover)="onDragOver($event)"
           (drop)="onDrop($event)"
           style="position: relative;"
           [attr.data-drag-zone]="true">
        
        <div class="upload-content" *ngIf="!selectedFileName"
             (dragenter)="onDragEnter($event)"
             (dragleave)="onDragLeave($event)"
             (dragover)="onDragOver($event)"
             (drop)="onDrop($event)"
             style="pointer-events: none;">
          <div class="upload-icon">ğŸ“„</div>
          <h3>é€‰æ‹©Excelç‚¹ä½è¡¨æ–‡ä»¶</h3>
          <p>æ”¯æŒ .xlsx, .xls æ ¼å¼æ–‡ä»¶</p>
          <p class="file-hint">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤åŒºåŸŸ</p>
          <button class="btn btn-primary" type="button" 
                  (click)="selectFile(); $event.stopPropagation()"
                  style="pointer-events: auto;">
            <span class="btn-icon">ğŸ“</span>
            æµè§ˆæ–‡ä»¶
          </button>
        </div>

        <div class="selected-file-info" *ngIf="selectedFileName"
             style="pointer-events: none;">
          <div class="file-icon-large">ğŸ“„</div>
          <h3>{{ selectedFileName }}</h3>
          <p>æ–‡ä»¶å·²é€‰æ‹©ï¼Œç‚¹å‡»ä¸‹ä¸€æ­¥ç»§ç»­</p>
          <button class="btn btn-secondary" type="button" 
                  (click)="selectFile(); $event.stopPropagation()"
                  style="pointer-events: auto;">
            <span class="btn-icon">ğŸ”„</span>
            é‡æ–°é€‰æ‹©
          </button>
        </div>

        <!-- æ‹–æ‹½çŠ¶æ€æŒ‡ç¤ºå™¨ -->
        <div class="drag-overlay" *ngIf="isDragOver">
          <div class="drag-content">
            <div class="drag-icon">ğŸ“</div>
            <h3>é‡Šæ”¾æ–‡ä»¶ä»¥ä¸Šä¼ </h3>
            <p>æ”¯æŒ .xlsx, .xls æ ¼å¼</p>
          </div>
        </div>
      </div>
      
      <div class="recent-files" *ngIf="recentFiles.length > 0">
        <h4>æœ€è¿‘ä½¿ç”¨çš„æ–‡ä»¶</h4>
        <div class="file-list">
          <div class="file-item" *ngFor="let file of recentFiles" (click)="selectRecentFile(file)">
            <span class="file-icon">ğŸ“„</span>
            <div class="file-info">
              <div class="file-name">{{ file.name }}</div>
              <div class="file-date">{{ file.lastUsed | date:'yyyy-MM-dd HH:mm' }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- æ­¥éª¤2: æ•°æ®é¢„è§ˆ -->
  <div class="preview-section" *ngIf="currentStep === 2">
    <div class="preview-header">
      <h3>æ•°æ®é¢„è§ˆ</h3>
      <p>å·²è§£æ {{ previewData.length }} ä¸ªé€šé“ç‚¹ä½</p>
    </div>
    
    <div class="preview-stats">
      <div class="stat-card">
        <div class="stat-icon">ğŸ”Œ</div>
        <div class="stat-info">
          <div class="stat-number">{{ getModuleTypeCount('AI') }}</div>
          <div class="stat-label">æ¨¡æ‹Ÿé‡è¾“å…¥</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">ğŸ“¤</div>
        <div class="stat-info">
          <div class="stat-number">{{ getModuleTypeCount('AO') }}</div>
          <div class="stat-label">æ¨¡æ‹Ÿé‡è¾“å‡º</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">ğŸ”˜</div>
        <div class="stat-info">
          <div class="stat-number">{{ getModuleTypeCount('DI') }}</div>
          <div class="stat-label">æ•°å­—é‡è¾“å…¥</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">ğŸ”²</div>
        <div class="stat-info">
          <div class="stat-number">{{ getModuleTypeCount('DO') }}</div>
          <div class="stat-label">æ•°å­—é‡è¾“å‡º</div>
        </div>
      </div>
    </div>

    <!-- è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯ -->
    <div class="detail-stats">
      <div class="detail-row">
        <span class="detail-label">æ•°æ®ç±»å‹åˆ†å¸ƒ:</span>
        <div class="detail-badges">
          <span class="data-type-badge type-bool" *ngIf="getDataTypeCount('Bool') > 0">
            Bool: {{ getDataTypeCount('Bool') }}
          </span>
          <span class="data-type-badge type-float" *ngIf="getDataTypeCount('Float') > 0">
            Float: {{ getDataTypeCount('Float') }}
          </span>
          <span class="data-type-badge type-int" *ngIf="getDataTypeCount('Int') > 0">
            Int: {{ getDataTypeCount('Int') }}
          </span>
          <span class="data-type-badge type-string" *ngIf="getDataTypeCount('String') > 0">
            String: {{ getDataTypeCount('String') }}
          </span>
        </div>
      </div>
      <div class="detail-row">
        <span class="detail-label">ç«™ç‚¹åˆ†å¸ƒ:</span>
        <div class="detail-badges">
          <span class="station-badge" *ngFor="let station of getUniqueStations()">
            {{ station }}: {{ getStationCount(station) }}
          </span>
        </div>
      </div>
    </div>

    <div class="preview-table">
      <div class="table-header">
        <div class="table-cell">æ ‡ç­¾</div>
        <div class="table-cell">å˜é‡å</div>
        <div class="table-cell">æè¿°</div>
        <div class="table-cell">æ¨¡å—ç±»å‹</div>
        <div class="table-cell">é€šé“å·</div>
        <div class="table-cell">æ•°æ®ç±»å‹</div>
        <div class="table-cell">ç«™å</div>
        <div class="table-cell">PLCåœ°å€</div>
        <div class="table-cell">é‡ç¨‹</div>
      </div>
      <div class="table-body">
        <div class="table-row" *ngFor="let item of previewData.slice(0, 10)">
          <div class="table-cell">{{ item.tag }}</div>
          <div class="table-cell">{{ item.variableName }}</div>
          <div class="table-cell" [title]="item.description">{{ item.description }}</div>
          <div class="table-cell">
            <span class="module-badge" [class]="'module-' + item.moduleType">
              {{ item.moduleType }}
            </span>
          </div>
          <div class="table-cell">{{ item.channelNumber }}</div>
          <div class="table-cell">
            <span class="data-type-badge" [class]="'type-' + item.dataType.toLowerCase()">
              {{ item.dataType }}
            </span>
          </div>
          <div class="table-cell">{{ item.stationName }}</div>
          <div class="table-cell">{{ item.plcAddress }}</div>
          <div class="table-cell">
            <span *ngIf="item.analogRangeMin !== undefined && item.analogRangeMax !== undefined">
              {{ item.analogRangeMin }} ~ {{ item.analogRangeMax }}
            </span>
            <span *ngIf="item.analogRangeMin === undefined || item.analogRangeMax === undefined">
              -
            </span>
          </div>
        </div>
      </div>
      <div class="table-footer" *ngIf="previewData.length > 10">
        <p>æ˜¾ç¤ºå‰10æ¡ï¼Œå…±{{ previewData.length }}æ¡è®°å½•</p>
      </div>
    </div>
  </div>

  <!-- æ­¥éª¤3: ç¡®è®¤å¯åŠ¨ -->
  <div class="confirm-section" *ngIf="currentStep === 3">
    <div class="confirm-info">
      <h3>ç¡®è®¤ä¿¡æ¯</h3>
      <div class="info-grid">
        <div class="info-item">
          <label>æ–‡ä»¶å:</label>
          <span>{{ selectedFileName }}</span>
        </div>
        <div class="info-item">
          <label>é€šé“æ•°é‡:</label>
          <span>{{ previewData.length }} ä¸ª</span>
        </div>
      </div>
      
      <div class="warning-box">
        <div class="warning-icon">âš ï¸</div>
        <div class="warning-text">
          <h4>å¼€å§‹æµ‹è¯•å‰è¯·ç¡®è®¤:</h4>
          <ul>
            <li>æ‰€æœ‰æµ‹è¯•è®¾å¤‡å·²æ­£ç¡®è¿æ¥</li>
            <li>PLCç¨‹åºå·²ä¸‹è½½å¹¶è¿è¡Œ</li>
            <li>æµ‹è¯•å°æ¶å¤„äºå°±ç»ªçŠ¶æ€</li>
            <li>æ¥çº¿å·²æŒ‰ç…§ç‚¹ä½è¡¨å®Œæˆ</li>
          </ul>
          <p><strong>ç³»ç»Ÿå°†è‡ªåŠ¨åˆ›å»ºæµ‹è¯•æ‰¹æ¬¡å¹¶åˆ†é…æ‰¹æ¬¡ä¿¡æ¯</strong></p>
        </div>
      </div>
    </div>
  </div>

  <!-- æ“ä½œæŒ‰é’® -->
  <div class="action-buttons">
    <button class="btn btn-outline" (click)="goToDashboard()">
      <span class="btn-icon">ğŸ </span>
      è¿”å›ä»ªè¡¨æ¿
    </button>
    
    <button class="btn btn-secondary" *ngIf="currentStep > 1" (click)="previousStep()">
      <span class="btn-icon">â¬…ï¸</span>
      ä¸Šä¸€æ­¥
    </button>
    
    <button class="btn btn-primary" *ngIf="currentStep < 3" (click)="nextStep()" 
            [disabled]="!canProceedToNext()">
      <span class="btn-icon">â¡ï¸</span>
      ä¸‹ä¸€æ­¥
    </button>
    
    <button class="btn btn-success" *ngIf="currentStep === 3" (click)="startTesting()" 
            [disabled]="isCreatingBatch">
      <span class="btn-icon">ğŸš€</span>
      {{ isCreatingBatch ? 'åˆ›å»ºä¸­...' : 'è‡ªåŠ¨åˆ›å»ºæ‰¹æ¬¡å¹¶å¼€å§‹æµ‹è¯•' }}
    </button>
  </div>
</div>
