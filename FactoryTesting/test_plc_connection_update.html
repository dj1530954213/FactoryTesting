<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLC连接配置更新测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success {
            background-color: #f6ffed;
            border-color: #b7eb8f;
            color: #52c41a;
        }
        .error {
            background-color: #fff2f0;
            border-color: #ffccc7;
            color: #ff4d4f;
        }
        .info {
            background-color: #e6f7ff;
            border-color: #91d5ff;
            color: #1890ff;
        }
        button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #40a9ff;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #f6f6f6;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .connection-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        .connection-form label {
            font-weight: bold;
        }
        .connection-form input, .connection-form select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .connection-item {
            background: #fafafa;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border: 1px solid #eee;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 PLC连接配置更新测试</h1>
        
        <div class="test-section info">
            <h3>测试目标</h3>
            <p>验证PLC连接配置的编辑和更新功能是否正常工作，特别是修复主键冲突问题。</p>
        </div>
        
        <div class="test-section">
            <h3>1. 获取现有PLC连接配置</h3>
            <button onclick="loadConnections()" id="load-btn">加载PLC连接配置</button>
            <div id="connections-list"></div>
        </div>

        <div class="test-section">
            <h3>2. 编辑PLC连接配置</h3>
            <div id="edit-form-container" style="display: none;">
                <div class="connection-form">
                    <label>连接名称:</label>
                    <input type="text" id="edit-name" placeholder="连接名称">
                    
                    <label>PLC类型:</label>
                    <select id="edit-plc-type">
                        <option value="ModbusTcp">Modbus TCP</option>
                        <option value="SiemensS7">Siemens S7</option>
                        <option value="OpcUa">OPC UA</option>
                        <option value="Mock">模拟PLC</option>
                    </select>
                    
                    <label>IP地址:</label>
                    <input type="text" id="edit-ip" placeholder="192.168.1.100">
                    
                    <label>端口:</label>
                    <input type="number" id="edit-port" placeholder="502">
                    
                    <label>超时时间(ms):</label>
                    <input type="number" id="edit-timeout" placeholder="5000">
                    
                    <label>重试次数:</label>
                    <input type="number" id="edit-retry" placeholder="3">
                    
                    <label>PLC用途:</label>
                    <select id="edit-is-test-plc">
                        <option value="true">测试PLC</option>
                        <option value="false">被测PLC</option>
                    </select>
                    
                    <label>描述:</label>
                    <input type="text" id="edit-description" placeholder="描述信息">
                </div>
                
                <button onclick="updateConnection()" id="update-btn">更新配置</button>
                <button onclick="cancelEdit()">取消编辑</button>
            </div>
        </div>

        <div class="test-section">
            <h3>3. 测试日志</h3>
            <button onclick="clearLog()">清除日志</button>
            <div id="test-log" class="log"></div>
        </div>
    </div>

    <script>
        let connections = [];
        let editingConnection = null;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'blue';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function clearLog() {
            document.getElementById('test-log').innerHTML = '';
        }
        
        async function loadConnections() {
            const loadBtn = document.getElementById('load-btn');
            loadBtn.disabled = true;
            loadBtn.textContent = '加载中...';
            
            try {
                log('开始加载PLC连接配置...', 'info');
                
                const result = await window.__TAURI__.core.invoke('get_plc_connections_cmd');
                connections = result;
                
                log(`成功加载 ${connections.length} 个PLC连接配置`, 'success');
                
                displayConnections();
                
            } catch (error) {
                log(`加载PLC连接配置失败: ${error}`, 'error');
            } finally {
                loadBtn.disabled = false;
                loadBtn.textContent = '加载PLC连接配置';
            }
        }
        
        function displayConnections() {
            const listDiv = document.getElementById('connections-list');
            
            if (connections.length === 0) {
                listDiv.innerHTML = '<p>没有找到PLC连接配置</p>';
                return;
            }
            
            let html = '<h4>现有PLC连接配置:</h4>';
            
            connections.forEach((conn, index) => {
                html += `
                    <div class="connection-item">
                        <strong>${conn.name}</strong> (${conn.plcType}) - ${conn.ipAddress}:${conn.port}
                        <br>
                        <small>用途: ${conn.isTestPlc ? '测试PLC' : '被测PLC'} | 状态: ${conn.connectionStatus}</small>
                        <br>
                        <button onclick="editConnection(${index})" style="margin-top: 5px;">编辑此连接</button>
                    </div>
                `;
            });
            
            listDiv.innerHTML = html;
        }
        
        function editConnection(index) {
            editingConnection = connections[index];
            
            // 填充编辑表单
            document.getElementById('edit-name').value = editingConnection.name;
            document.getElementById('edit-plc-type').value = editingConnection.plcType;
            document.getElementById('edit-ip').value = editingConnection.ipAddress;
            document.getElementById('edit-port').value = editingConnection.port;
            document.getElementById('edit-timeout').value = editingConnection.timeout;
            document.getElementById('edit-retry').value = editingConnection.retryCount;
            document.getElementById('edit-is-test-plc').value = editingConnection.isTestPlc.toString();
            document.getElementById('edit-description').value = editingConnection.description || '';
            
            // 显示编辑表单
            document.getElementById('edit-form-container').style.display = 'block';
            
            log(`开始编辑连接: ${editingConnection.name}`, 'info');
        }
        
        function cancelEdit() {
            editingConnection = null;
            document.getElementById('edit-form-container').style.display = 'none';
            log('取消编辑', 'info');
        }
        
        async function updateConnection() {
            if (!editingConnection) {
                log('没有选择要编辑的连接', 'error');
                return;
            }
            
            const updateBtn = document.getElementById('update-btn');
            updateBtn.disabled = true;
            updateBtn.textContent = '更新中...';
            
            try {
                // 构建更新的连接配置
                const updatedConnection = {
                    id: editingConnection.id, // 保持原有ID
                    name: document.getElementById('edit-name').value,
                    plcType: document.getElementById('edit-plc-type').value,
                    ipAddress: document.getElementById('edit-ip').value,
                    port: parseInt(document.getElementById('edit-port').value),
                    timeout: parseInt(document.getElementById('edit-timeout').value),
                    retryCount: parseInt(document.getElementById('edit-retry').value),
                    isTestPlc: document.getElementById('edit-is-test-plc').value === 'true',
                    description: document.getElementById('edit-description').value,
                    isEnabled: editingConnection.isEnabled, // 保持原有状态
                    connectionStatus: editingConnection.connectionStatus, // 保持原有状态
                    lastConnected: editingConnection.lastConnected // 保持原有时间
                };
                
                log(`开始更新连接配置: ${updatedConnection.name}`, 'info');
                log(`连接ID: ${updatedConnection.id}`, 'info');
                
                const result = await window.__TAURI__.core.invoke('save_plc_connection_cmd', {
                    connection: updatedConnection
                });
                
                log('PLC连接配置更新成功!', 'success');
                log(`更新结果: ${JSON.stringify(result, null, 2)}`, 'info');
                
                // 重新加载连接列表
                await loadConnections();
                
                // 隐藏编辑表单
                cancelEdit();
                
            } catch (error) {
                log(`更新PLC连接配置失败: ${error}`, 'error');
                console.error('更新失败详情:', error);
            } finally {
                updateBtn.disabled = false;
                updateBtn.textContent = '更新配置';
            }
        }
        
        // 页面加载时的初始化
        window.addEventListener('DOMContentLoaded', () => {
            log('PLC连接配置更新测试页面已加载', 'info');
            
            if (window.__TAURI__) {
                log('Tauri API 可用，准备开始测试', 'success');
                // 自动加载连接配置
                loadConnections();
            } else {
                log('Tauri API 不可用 - 请在Tauri应用中打开此页面', 'error');
            }
        });
    </script>
</body>
</html> 