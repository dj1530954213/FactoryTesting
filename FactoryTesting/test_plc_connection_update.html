<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLCè¿æ¥é…ç½®æ›´æ–°æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success {
            background-color: #f6ffed;
            border-color: #b7eb8f;
            color: #52c41a;
        }
        .error {
            background-color: #fff2f0;
            border-color: #ffccc7;
            color: #ff4d4f;
        }
        .info {
            background-color: #e6f7ff;
            border-color: #91d5ff;
            color: #1890ff;
        }
        button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #40a9ff;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #f6f6f6;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .connection-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        .connection-form label {
            font-weight: bold;
        }
        .connection-form input, .connection-form select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .connection-item {
            background: #fafafa;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border: 1px solid #eee;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ PLCè¿æ¥é…ç½®æ›´æ–°æµ‹è¯•</h1>
        
        <div class="test-section info">
            <h3>æµ‹è¯•ç›®æ ‡</h3>
            <p>éªŒè¯PLCè¿æ¥é…ç½®çš„ç¼–è¾‘å’Œæ›´æ–°åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œï¼Œç‰¹åˆ«æ˜¯ä¿®å¤ä¸»é”®å†²çªé—®é¢˜ã€‚</p>
        </div>
        
        <div class="test-section">
            <h3>1. è·å–ç°æœ‰PLCè¿æ¥é…ç½®</h3>
            <button onclick="loadConnections()" id="load-btn">åŠ è½½PLCè¿æ¥é…ç½®</button>
            <div id="connections-list"></div>
        </div>

        <div class="test-section">
            <h3>2. ç¼–è¾‘PLCè¿æ¥é…ç½®</h3>
            <div id="edit-form-container" style="display: none;">
                <div class="connection-form">
                    <label>è¿æ¥åç§°:</label>
                    <input type="text" id="edit-name" placeholder="è¿æ¥åç§°">
                    
                    <label>PLCç±»å‹:</label>
                    <select id="edit-plc-type">
                        <option value="ModbusTcp">Modbus TCP</option>
                        <option value="SiemensS7">Siemens S7</option>
                        <option value="OpcUa">OPC UA</option>
                        <option value="Mock">æ¨¡æ‹ŸPLC</option>
                    </select>
                    
                    <label>IPåœ°å€:</label>
                    <input type="text" id="edit-ip" placeholder="192.168.1.100">
                    
                    <label>ç«¯å£:</label>
                    <input type="number" id="edit-port" placeholder="502">
                    
                    <label>è¶…æ—¶æ—¶é—´(ms):</label>
                    <input type="number" id="edit-timeout" placeholder="5000">
                    
                    <label>é‡è¯•æ¬¡æ•°:</label>
                    <input type="number" id="edit-retry" placeholder="3">
                    
                    <label>PLCç”¨é€”:</label>
                    <select id="edit-is-test-plc">
                        <option value="true">æµ‹è¯•PLC</option>
                        <option value="false">è¢«æµ‹PLC</option>
                    </select>
                    
                    <label>æè¿°:</label>
                    <input type="text" id="edit-description" placeholder="æè¿°ä¿¡æ¯">
                </div>
                
                <button onclick="updateConnection()" id="update-btn">æ›´æ–°é…ç½®</button>
                <button onclick="cancelEdit()">å–æ¶ˆç¼–è¾‘</button>
            </div>
        </div>

        <div class="test-section">
            <h3>3. æµ‹è¯•æ—¥å¿—</h3>
            <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
            <div id="test-log" class="log"></div>
        </div>
    </div>

    <script>
        let connections = [];
        let editingConnection = null;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'blue';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function clearLog() {
            document.getElementById('test-log').innerHTML = '';
        }
        
        async function loadConnections() {
            const loadBtn = document.getElementById('load-btn');
            loadBtn.disabled = true;
            loadBtn.textContent = 'åŠ è½½ä¸­...';
            
            try {
                log('å¼€å§‹åŠ è½½PLCè¿æ¥é…ç½®...', 'info');
                
                const result = await window.__TAURI__.core.invoke('get_plc_connections_cmd');
                connections = result;
                
                log(`æˆåŠŸåŠ è½½ ${connections.length} ä¸ªPLCè¿æ¥é…ç½®`, 'success');
                
                displayConnections();
                
            } catch (error) {
                log(`åŠ è½½PLCè¿æ¥é…ç½®å¤±è´¥: ${error}`, 'error');
            } finally {
                loadBtn.disabled = false;
                loadBtn.textContent = 'åŠ è½½PLCè¿æ¥é…ç½®';
            }
        }
        
        function displayConnections() {
            const listDiv = document.getElementById('connections-list');
            
            if (connections.length === 0) {
                listDiv.innerHTML = '<p>æ²¡æœ‰æ‰¾åˆ°PLCè¿æ¥é…ç½®</p>';
                return;
            }
            
            let html = '<h4>ç°æœ‰PLCè¿æ¥é…ç½®:</h4>';
            
            connections.forEach((conn, index) => {
                html += `
                    <div class="connection-item">
                        <strong>${conn.name}</strong> (${conn.plcType}) - ${conn.ipAddress}:${conn.port}
                        <br>
                        <small>ç”¨é€”: ${conn.isTestPlc ? 'æµ‹è¯•PLC' : 'è¢«æµ‹PLC'} | çŠ¶æ€: ${conn.connectionStatus}</small>
                        <br>
                        <button onclick="editConnection(${index})" style="margin-top: 5px;">ç¼–è¾‘æ­¤è¿æ¥</button>
                    </div>
                `;
            });
            
            listDiv.innerHTML = html;
        }
        
        function editConnection(index) {
            editingConnection = connections[index];
            
            // å¡«å……ç¼–è¾‘è¡¨å•
            document.getElementById('edit-name').value = editingConnection.name;
            document.getElementById('edit-plc-type').value = editingConnection.plcType;
            document.getElementById('edit-ip').value = editingConnection.ipAddress;
            document.getElementById('edit-port').value = editingConnection.port;
            document.getElementById('edit-timeout').value = editingConnection.timeout;
            document.getElementById('edit-retry').value = editingConnection.retryCount;
            document.getElementById('edit-is-test-plc').value = editingConnection.isTestPlc.toString();
            document.getElementById('edit-description').value = editingConnection.description || '';
            
            // æ˜¾ç¤ºç¼–è¾‘è¡¨å•
            document.getElementById('edit-form-container').style.display = 'block';
            
            log(`å¼€å§‹ç¼–è¾‘è¿æ¥: ${editingConnection.name}`, 'info');
        }
        
        function cancelEdit() {
            editingConnection = null;
            document.getElementById('edit-form-container').style.display = 'none';
            log('å–æ¶ˆç¼–è¾‘', 'info');
        }
        
        async function updateConnection() {
            if (!editingConnection) {
                log('æ²¡æœ‰é€‰æ‹©è¦ç¼–è¾‘çš„è¿æ¥', 'error');
                return;
            }
            
            const updateBtn = document.getElementById('update-btn');
            updateBtn.disabled = true;
            updateBtn.textContent = 'æ›´æ–°ä¸­...';
            
            try {
                // æ„å»ºæ›´æ–°çš„è¿æ¥é…ç½®
                const updatedConnection = {
                    id: editingConnection.id, // ä¿æŒåŸæœ‰ID
                    name: document.getElementById('edit-name').value,
                    plcType: document.getElementById('edit-plc-type').value,
                    ipAddress: document.getElementById('edit-ip').value,
                    port: parseInt(document.getElementById('edit-port').value),
                    timeout: parseInt(document.getElementById('edit-timeout').value),
                    retryCount: parseInt(document.getElementById('edit-retry').value),
                    isTestPlc: document.getElementById('edit-is-test-plc').value === 'true',
                    description: document.getElementById('edit-description').value,
                    isEnabled: editingConnection.isEnabled, // ä¿æŒåŸæœ‰çŠ¶æ€
                    connectionStatus: editingConnection.connectionStatus, // ä¿æŒåŸæœ‰çŠ¶æ€
                    lastConnected: editingConnection.lastConnected // ä¿æŒåŸæœ‰æ—¶é—´
                };
                
                log(`å¼€å§‹æ›´æ–°è¿æ¥é…ç½®: ${updatedConnection.name}`, 'info');
                log(`è¿æ¥ID: ${updatedConnection.id}`, 'info');
                
                const result = await window.__TAURI__.core.invoke('save_plc_connection_cmd', {
                    connection: updatedConnection
                });
                
                log('PLCè¿æ¥é…ç½®æ›´æ–°æˆåŠŸ!', 'success');
                log(`æ›´æ–°ç»“æœ: ${JSON.stringify(result, null, 2)}`, 'info');
                
                // é‡æ–°åŠ è½½è¿æ¥åˆ—è¡¨
                await loadConnections();
                
                // éšè—ç¼–è¾‘è¡¨å•
                cancelEdit();
                
            } catch (error) {
                log(`æ›´æ–°PLCè¿æ¥é…ç½®å¤±è´¥: ${error}`, 'error');
                console.error('æ›´æ–°å¤±è´¥è¯¦æƒ…:', error);
            } finally {
                updateBtn.disabled = false;
                updateBtn.textContent = 'æ›´æ–°é…ç½®';
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            log('PLCè¿æ¥é…ç½®æ›´æ–°æµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
            
            if (window.__TAURI__) {
                log('Tauri API å¯ç”¨ï¼Œå‡†å¤‡å¼€å§‹æµ‹è¯•', 'success');
                // è‡ªåŠ¨åŠ è½½è¿æ¥é…ç½®
                loadConnections();
            } else {
                log('Tauri API ä¸å¯ç”¨ - è¯·åœ¨Tauriåº”ç”¨ä¸­æ‰“å¼€æ­¤é¡µé¢', 'error');
            }
        });
    </script>
</body>
</html> 