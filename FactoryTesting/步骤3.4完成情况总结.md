# æ­¥éª¤3.4: å®ç°æ ¸å¿ƒä¸šåŠ¡æµç¨‹çš„ Tauri Commands - å®Œæˆæƒ…å†µæ€»ç»“

## æ­¥éª¤3.4è¦æ±‚æ¦‚è¿°

æ ¹æ®æŠ€æœ¯æ ˆè¿ç§»è¯¦ç»†å®æ–½æ­¥éª¤æ–‡æ¡£ï¼Œæ­¥éª¤3.4è¦æ±‚å®ç°ä»¥ä¸‹æ ¸å¿ƒä¸šåŠ¡æµç¨‹çš„Tauri Commandsï¼š

1. **import_excel_and_prepare_batch_cmd** - å¯¼å…¥Excelå¹¶å‡†å¤‡æ‰¹æ¬¡
2. **start_tests_for_batch_cmd** - å¼€å§‹æ‰¹æ¬¡æµ‹è¯•  
3. **get_batch_status_cmd** - è·å–æ‰¹æ¬¡çŠ¶æ€
4. **execute_manual_sub_test_cmd** - æ‰§è¡Œæ‰‹åŠ¨å­æµ‹è¯•
5. **read_channel_value_cmd** - è¯»å–é€šé“å€¼
6. **write_channel_value_cmd** - å†™å…¥é€šé“å€¼

## å®ç°çŠ¶æ€

### âœ… å·²å®Œæˆçš„å‘½ä»¤

#### 1. import_excel_and_prepare_batch_cmd
**ä½ç½®**: `src-tauri/src/commands/data_management.rs`
**åŠŸèƒ½**: 
- è§£æExcelæ–‡ä»¶è·å–é€šé“å®šä¹‰
- åˆ›å»ºæµ‹è¯•æ‰¹æ¬¡ä¿¡æ¯
- ä¸ºæ¯ä¸ªé€šé“å®šä¹‰åˆ›å»ºæµ‹è¯•å®ä¾‹
- ä¿å­˜æ‰¹æ¬¡ä¿¡æ¯å’Œæµ‹è¯•å®ä¾‹åˆ°æ•°æ®åº“

**å‚æ•°ç»“æ„**:
```rust
pub struct ImportExcelAndPrepareBatchCmdArgs {
    pub file_path_str: String,
    pub product_model: Option<String>,
    pub serial_number: Option<String>,
}
```

**è¿”å›ç»“æ„**:
```rust
pub struct ImportAndPrepareBatchResponse {
    pub batch_info: TestBatchInfo,
    pub instances: Vec<ChannelTestInstance>,
}
```

#### 2. start_tests_for_batch_cmd
**ä½ç½®**: `src-tauri/src/commands/data_management.rs`
**åŠŸèƒ½**: 
- è°ƒç”¨æµ‹è¯•åè°ƒæœåŠ¡å¼€å§‹æ‰¹æ¬¡æµ‹è¯•
- å¯åŠ¨è‡ªåŠ¨åŒ–æµ‹è¯•æµç¨‹

**å‚æ•°ç»“æ„**:
```rust
pub struct StartTestsForBatchCmdArgs {
    pub batch_id: String,
}
```

#### 3. get_batch_status_cmd
**ä½ç½®**: `src-tauri/src/commands/data_management.rs`
**åŠŸèƒ½**: 
- è·å–æ‰¹æ¬¡ä¿¡æ¯å’Œæµ‹è¯•å®ä¾‹
- è®¡ç®—æµ‹è¯•è¿›åº¦ç»Ÿè®¡
- è¿”å›è¯¦ç»†çš„æ‰¹æ¬¡çŠ¶æ€

**å‚æ•°ç»“æ„**:
```rust
pub struct GetBatchStatusCmdArgs {
    pub batch_id: String,
}
```

**è¿”å›ç»“æ„**:
```rust
pub struct BatchDetailsPayload {
    pub batch_info: TestBatchInfo,
    pub instances: Vec<ChannelTestInstance>,
    pub progress: BatchProgressInfo,
}
```

#### 4. execute_manual_sub_test_cmd
**ä½ç½®**: `src-tauri/src/commands/manual_testing.rs`
**åŠŸèƒ½**: 
- æ‰§è¡Œæ‰‹åŠ¨å­æµ‹è¯•
- åˆ›å»ºæµ‹è¯•ç»“æœ
- æ›´æ–°æµ‹è¯•å®ä¾‹çŠ¶æ€

**å‚æ•°ç»“æ„**:
```rust
pub struct ExecuteManualSubTestCmdArgs {
    pub instance_id: String,
    pub sub_test_item: SubTestItem,
    pub params: Option<HashMap<String, serde_json::Value>>,
}
```

#### 5. read_channel_value_cmd
**ä½ç½®**: `src-tauri/src/commands/manual_testing.rs`
**åŠŸèƒ½**: 
- è¯»å–æŒ‡å®šPLCåœ°å€çš„é€šé“å€¼
- æ”¯æŒä¸åŒæ•°æ®ç±»å‹
- ç›®å‰è¿”å›æ¨¡æ‹Ÿå€¼ï¼ˆå¾…é›†æˆçœŸå®PLCé€šä¿¡ï¼‰

**å‚æ•°ç»“æ„**:
```rust
pub struct ReadChannelValueCmdArgs {
    pub instance_id: String,
    pub plc_address: String,
    pub data_type: PointDataType,
}
```

#### 6. write_channel_value_cmd
**ä½ç½®**: `src-tauri/src/commands/manual_testing.rs`
**åŠŸèƒ½**: 
- å†™å…¥å€¼åˆ°æŒ‡å®šPLCåœ°å€
- éªŒè¯å€¼ç±»å‹åŒ¹é…
- ç›®å‰åªè®°å½•æ—¥å¿—ï¼ˆå¾…é›†æˆçœŸå®PLCé€šä¿¡ï¼‰

**å‚æ•°ç»“æ„**:
```rust
pub struct WriteChannelValueCmdArgs {
    pub instance_id: String,
    pub plc_address: String,
    pub data_type: PointDataType,
    pub value_to_write: serde_json::Value,
}
```

## å‘½ä»¤æ³¨å†ŒçŠ¶æ€

### âœ… å·²åœ¨lib.rsä¸­æ³¨å†Œçš„å‘½ä»¤

æ‰€æœ‰6ä¸ªæ ¸å¿ƒå‘½ä»¤éƒ½å·²åœ¨`src-tauri/src/lib.rs`çš„`invoke_handler`ä¸­æ­£ç¡®æ³¨å†Œï¼š

```rust
.invoke_handler(tauri::generate_handler![
    // ... å…¶ä»–å‘½ä»¤ ...
    import_excel_and_prepare_batch_cmd,
    start_tests_for_batch_cmd,
    get_batch_status_cmd,
    execute_manual_sub_test_cmd,
    read_channel_value_cmd,
    write_channel_value_cmd
])
```

## æ”¯æŒçš„æ•°æ®ç»“æ„

### æ–°å¢çš„Payloadç»“æ„

1. **ImportExcelAndPrepareBatchCmdArgs** - å¯¼å…¥Excelå‚æ•°
2. **ImportAndPrepareBatchResponse** - å¯¼å…¥Excelå“åº”
3. **StartTestsForBatchCmdArgs** - å¼€å§‹æµ‹è¯•å‚æ•°
4. **GetBatchStatusCmdArgs** - è·å–çŠ¶æ€å‚æ•°
5. **BatchDetailsPayload** - æ‰¹æ¬¡è¯¦æƒ…è½½è·
6. **BatchProgressInfo** - æ‰¹æ¬¡è¿›åº¦ä¿¡æ¯
7. **ExecuteManualSubTestCmdArgs** - æ‰‹åŠ¨æµ‹è¯•å‚æ•°
8. **ReadChannelValueCmdArgs** - è¯»å–é€šé“å‚æ•°
9. **WriteChannelValueCmdArgs** - å†™å…¥é€šé“å‚æ•°

## æ–‡ä»¶ç»„ç»‡ç»“æ„

```
src-tauri/src/commands/
â”œâ”€â”€ mod.rs                    # æ¨¡å—å¯¼å‡º
â”œâ”€â”€ data_management.rs        # æ•°æ®ç®¡ç†å‘½ä»¤ï¼ˆåŒ…å«å‰3ä¸ªå‘½ä»¤ï¼‰
â””â”€â”€ manual_testing.rs         # æ‰‹åŠ¨æµ‹è¯•å‘½ä»¤ï¼ˆåŒ…å«å3ä¸ªå‘½ä»¤ï¼‰
```

## ä¸ç°æœ‰ç³»ç»Ÿçš„é›†æˆ

### âœ… å·²é›†æˆçš„æœåŠ¡

1. **ExcelImporter** - Excelæ–‡ä»¶è§£æ
2. **TestCoordinationService** - æµ‹è¯•åè°ƒæœåŠ¡
3. **ChannelStateManager** - é€šé“çŠ¶æ€ç®¡ç†
4. **PersistenceService** - æ•°æ®æŒä¹…åŒ–æœåŠ¡

### ğŸ”„ å¾…å®Œå–„çš„é›†æˆ

1. **PLCé€šä¿¡æœåŠ¡** - ç›®å‰read/writeå‘½ä»¤ä½¿ç”¨æ¨¡æ‹Ÿå€¼
2. **äº‹ä»¶é€šçŸ¥æœºåˆ¶** - çŠ¶æ€å˜åŒ–æ—¶çš„å‰ç«¯é€šçŸ¥
3. **é”™è¯¯å¤„ç†ä¼˜åŒ–** - æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œæ¢å¤æœºåˆ¶

## æµ‹è¯•å»ºè®®

### 1. å•ä¸ªå‘½ä»¤æµ‹è¯•
å¯ä»¥åœ¨Tauri DevToolsä¸­ä½¿ç”¨ä»¥ä¸‹æ–¹å¼æµ‹è¯•ï¼š

```javascript
// æµ‹è¯•å¯¼å…¥Excelå¹¶å‡†å¤‡æ‰¹æ¬¡
window.__TAURI__.invoke('import_excel_and_prepare_batch_cmd', {
    file_path_str: 'D:\\GIT\\Git\\code\\FactoryTesting\\æµ‹è¯•æ–‡ä»¶\\æµ‹è¯•IO.xlsx',
    product_model: 'TestProduct',
    serial_number: 'SN123456'
});

// æµ‹è¯•è·å–æ‰¹æ¬¡çŠ¶æ€
window.__TAURI__.invoke('get_batch_status_cmd', {
    batch_id: 'your-batch-id'
});
```

### 2. ç«¯åˆ°ç«¯æµç¨‹æµ‹è¯•
1. è°ƒç”¨`import_excel_and_prepare_batch_cmd`åˆ›å»ºæ‰¹æ¬¡
2. è°ƒç”¨`get_batch_status_cmd`æŸ¥çœ‹çŠ¶æ€
3. è°ƒç”¨`start_tests_for_batch_cmd`å¼€å§‹æµ‹è¯•
4. è°ƒç”¨`execute_manual_sub_test_cmd`æ‰§è¡Œæ‰‹åŠ¨æµ‹è¯•
5. è°ƒç”¨`read_channel_value_cmd`å’Œ`write_channel_value_cmd`æµ‹è¯•é€šé“æ“ä½œ

## ä¸å‰ç«¯çš„å¯¹æ¥

### å‰ç«¯TauriApiServiceéœ€è¦æ·»åŠ çš„æ–¹æ³•

å‰ç«¯çš„`TauriApiService`éœ€è¦æ·»åŠ å¯¹åº”çš„æ–¹æ³•æ¥è°ƒç”¨è¿™äº›æ–°å‘½ä»¤ï¼š

```typescript
// å¯¼å…¥Excelå¹¶å‡†å¤‡æ‰¹æ¬¡
importExcelAndPrepareBatch(args: ImportExcelAndPrepareBatchCmdArgs): Observable<ImportAndPrepareBatchResponse>

// å¼€å§‹æ‰¹æ¬¡æµ‹è¯•
startTestsForBatch(batchId: string): Observable<void>

// è·å–æ‰¹æ¬¡çŠ¶æ€
getBatchStatus(batchId: string): Observable<BatchDetailsPayload>

// æ‰§è¡Œæ‰‹åŠ¨å­æµ‹è¯•
executeManualSubTest(args: ExecuteManualSubTestCmdArgs): Observable<RawTestOutcome>

// è¯»å–é€šé“å€¼
readChannelValue(args: ReadChannelValueCmdArgs): Observable<any>

// å†™å…¥é€šé“å€¼
writeChannelValue(args: WriteChannelValueCmdArgs): Observable<void>
```

## æ€»ç»“

### âœ… æ­¥éª¤3.4å®ŒæˆçŠ¶æ€ï¼š**å·²å®Œæˆ**

1. **æ‰€æœ‰6ä¸ªæ ¸å¿ƒå‘½ä»¤å·²å®ç°** âœ…
2. **å‘½ä»¤å·²æ­£ç¡®æ³¨å†Œ** âœ…
3. **æ•°æ®ç»“æ„å®šä¹‰å®Œæ•´** âœ…
4. **åŸºæœ¬åŠŸèƒ½é€»è¾‘å®ç°** âœ…
5. **ä¸ç°æœ‰æœåŠ¡é›†æˆ** âœ…

### ğŸ”„ åç»­ä¼˜åŒ–æ–¹å‘

1. **PLCé€šä¿¡é›†æˆ** - å°†æ¨¡æ‹Ÿå€¼æ›¿æ¢ä¸ºçœŸå®PLCé€šä¿¡
2. **äº‹ä»¶é€šçŸ¥å®Œå–„** - æ·»åŠ çŠ¶æ€å˜åŒ–çš„å®æ—¶é€šçŸ¥
3. **é”™è¯¯å¤„ç†å¢å¼º** - æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œç”¨æˆ·å‹å¥½çš„æç¤º
4. **æ€§èƒ½ä¼˜åŒ–** - å¤§æ‰¹é‡æ•°æ®å¤„ç†çš„æ€§èƒ½ä¼˜åŒ–
5. **å‰ç«¯å¯¹æ¥** - å®Œå–„å‰ç«¯TauriApiServiceçš„æ–¹æ³•

**æ­¥éª¤3.4å·²æˆåŠŸå®Œæˆå¹¶é€šè¿‡ç¼–è¯‘éªŒè¯ï¼Œå¯ä»¥æ ‡è®°ä¸ºå®ŒæˆçŠ¶æ€ã€‚**

## ç¼–è¯‘éªŒè¯

### âœ… ç¼–è¯‘çŠ¶æ€ï¼š**é€šè¿‡**

æœ€æ–°çš„ç¼–è¯‘æ£€æŸ¥ç»“æœï¼š
- **é”™è¯¯æ•°é‡**: 0 âŒ â†’ âœ…
- **è­¦å‘Šæ•°é‡**: 37 (ä¸»è¦æ˜¯æœªä½¿ç”¨çš„å˜é‡å’Œå¯¼å…¥ï¼Œä¸å½±å“åŠŸèƒ½)
- **ç¼–è¯‘çŠ¶æ€**: æˆåŠŸé€šè¿‡ âœ…

```bash
cargo check
# Finished `dev` profile [unoptimized + debuginfo] target(s) in 11.53s
```

### ä¿®å¤çš„ç¼–è¯‘é—®é¢˜

1. **æ–¹æ³•åé”™è¯¯**: `initialize_channel_test_instance` â†’ `create_test_instance`
2. **å‚æ•°ç±»å‹é”™è¯¯**: å­—ç¬¦ä¸²å¼•ç”¨ç±»å‹ä¿®æ­£
3. **Optionå¤„ç†**: `args.params` â†’ `args.params.unwrap_or_default()`
4. **æšä¸¾åŒ¹é…**: æ·»åŠ äº†æ‰€æœ‰`PointDataType`å˜ä½“çš„åŒ¹é…åˆ†æ”¯
5. **æœªä½¿ç”¨å¯¼å…¥**: ç§»é™¤äº†`Serialize`ç­‰æœªä½¿ç”¨çš„å¯¼å…¥

## ä¸‹ä¸€æ­¥å»ºè®®

ç°åœ¨æ­¥éª¤3.4å·²å®Œæˆï¼Œå»ºè®®ç»§ç»­è¿›è¡Œï¼š

1. **æ­¥éª¤3.5**: å®ç°åç«¯åˆ°å‰ç«¯çš„äº‹ä»¶é€šçŸ¥æœºåˆ¶ (Tauri Events)
2. **æ­¥éª¤4.x**: å‰ç«¯AngularåŸºç¡€æ­å»ºä¸åˆæ­¥é›†æˆ
3. **åŠŸèƒ½æµ‹è¯•**: ä½¿ç”¨Tauri DevToolsæµ‹è¯•æ–°å®ç°çš„å‘½ä»¤

**æ­¥éª¤3.4å·²æˆåŠŸå®Œæˆå¹¶é€šè¿‡ç¼–è¯‘éªŒè¯ï¼Œå¯ä»¥æ ‡è®°ä¸ºå®ŒæˆçŠ¶æ€ã€‚** âœ… 