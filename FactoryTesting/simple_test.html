<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAT_TEST 简化功能测试</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            margin: 20px;
            background-color: #f0f2f5;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #1890ff;
        }
        .header h1 {
            color: #1890ff;
            margin: 0;
            font-size: 2.2em;
        }
        .header p {
            color: #666;
            margin: 10px 0 0 0;
            font-size: 1.1em;
        }
        .status-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #1890ff;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-connected { background-color: #52c41a; }
        .status-disconnected { background-color: #ff4d4f; }
        .status-unknown { background-color: #faad14; }
        .button-section {
            text-align: center;
            margin: 30px 0;
        }
        .btn {
            background-color: #1890ff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #40a9ff;
        }
        .btn:disabled {
            background-color: #d9d9d9;
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #6c757d;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        .console {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-fill {
            height: 100%;
            background-color: #1890ff;
            width: 0%;
            transition: width 0.3s ease;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #1890ff;
        }
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏭 FAT_TEST 功能验证</h1>
            <p>Rust + Angular + Tauri 技术栈集成测试</p>
        </div>

        <div class="status-section">
            <h3>🔗 连接状态</h3>
            <div id="connection-status">
                <span class="status-indicator status-unknown"></span>
                <span>正在检测Tauri环境...</span>
            </div>
        </div>

        <div class="button-section">
            <button class="btn" onclick="runQuickTest()" id="test-btn">
                🚀 开始功能测试
            </button>
            <button class="btn btn-secondary" onclick="clearConsole()">
                🗑️ 清空控制台
            </button>
        </div>

        <div class="stats" id="stats" style="display: none;">
            <div class="stat-card">
                <div class="stat-number" id="total-tests">0</div>
                <div class="stat-label">总测试数</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="passed-tests" style="color: #52c41a;">0</div>
                <div class="stat-label">通过</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="failed-tests" style="color: #ff4d4f;">0</div>
                <div class="stat-label">失败</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="success-rate">0%</div>
                <div class="stat-label">成功率</div>
            </div>
        </div>

        <div class="progress-bar" id="progress-container" style="display: none;">
            <div class="progress-fill" id="progress-fill"></div>
        </div>

        <h3>📝 测试控制台</h3>
        <div class="console" id="console">
等待开始测试...

使用说明：
1. 确保Tauri应用已正常启动
2. 点击"开始功能测试"按钮
3. 观察测试结果和详细日志
4. 检查统计信息了解系统状态

测试内容包括：
✓ 系统状态检查
✓ Excel导入功能
✓ 批次创建和管理
✓ 通道定义操作
✓ 测试实例创建
✓ 手动测试功能
✓ 报告生成功能
        </div>
    </div>

    <script>
        // 控制台输出管理
        const consoleElement = document.getElementById('console');
        const originalConsoleLog = console.log;
        
        // 重写console.log以显示在页面上
        console.log = function(...args) {
            const message = args.join(' ');
            const timestamp = new Date().toLocaleTimeString();
            consoleElement.textContent += `[${timestamp}] ${message}\n`;
            consoleElement.scrollTop = consoleElement.scrollHeight;
            originalConsoleLog.apply(console, args);
        };

        function clearConsole() {
            consoleElement.textContent = '控制台已清空...\n';
        }

        // 更新连接状态
        function updateConnectionStatus(connected, message = '') {
            const statusElement = document.getElementById('connection-status');
            const indicator = statusElement.querySelector('.status-indicator');
            const text = statusElement.querySelector('span:last-child');
            
            if (connected) {
                indicator.className = 'status-indicator status-connected';
                text.textContent = '✅ Tauri环境连接正常' + (message ? ` - ${message}` : '');
            } else {
                indicator.className = 'status-indicator status-disconnected';
                text.textContent = '❌ Tauri环境连接失败' + (message ? ` - ${message}` : '');
            }
        }

        // 更新测试统计
        function updateStats(total, passed, failed) {
            document.getElementById('stats').style.display = 'grid';
            document.getElementById('total-tests').textContent = total;
            document.getElementById('passed-tests').textContent = passed;
            document.getElementById('failed-tests').textContent = failed;
            
            const successRate = total > 0 ? ((passed / total) * 100).toFixed(1) : 0;
            document.getElementById('success-rate').textContent = successRate + '%';
        }

        // 更新进度条
        function updateProgress(current, total) {
            const progressContainer = document.getElementById('progress-container');
            const progressFill = document.getElementById('progress-fill');
            
            if (total > 0) {
                progressContainer.style.display = 'block';
                const percentage = (current / total) * 100;
                progressFill.style.width = percentage + '%';
            } else {
                progressContainer.style.display = 'none';
            }
        }

        // 检查Tauri环境
        function checkTauriEnvironment() {
            const isTauriEnv = typeof window !== 'undefined' && window.__TAURI__;
            
            if (isTauriEnv) {
                updateConnectionStatus(true, '环境检测通过');
                document.getElementById('test-btn').disabled = false;
                console.log('✅ Tauri环境检测成功，可以进行功能测试');
                return true;
            } else {
                updateConnectionStatus(false, '请在Tauri应用中打开');
                document.getElementById('test-btn').disabled = true;
                console.log('❌ 未检测到Tauri环境，请在Tauri应用中打开此页面');
                return false;
            }
        }

        // 页面加载完成后检查环境
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🏭 FAT_TEST 功能验证页面加载完成');
            checkTauriEnvironment();
        });

        // 嵌入快速测试脚本
        // 模拟测试数据
        const testData = {
            batchInfo: {
                batch_id: `quick_test_${Date.now()}`,
                product_model: '快速测试产品',
                serial_number: `QT${Date.now()}`,
                customer_name: '测试客户',
                operator_name: '自动测试',
                creation_time: new Date().toISOString(),
                status: 'Created'
            },
            definitions: [
                {
                    id: `def_${Date.now()}_1`,
                    tag: 'AI001',
                    variable_description: '模拟输入点1',
                    station_name: '测试站1',
                    module_name: '模拟模块',
                    module_type: 'AI',
                    channel_number: 'CH01',
                    data_type: 'Float',
                    plc_communication_address: 'DB1.DBD0',
                    analog_range_min: 0.0,
                    analog_range_max: 100.0
                },
                {
                    id: `def_${Date.now()}_2`,
                    tag: 'DI001',
                    variable_description: '数字输入点1',
                    station_name: '测试站1',
                    module_name: '模拟模块',
                    module_type: 'DI',
                    channel_number: 'CH02',
                    data_type: 'Bool',
                    plc_communication_address: 'DB1.DBX0.0'
                }
            ]
        };

        // 测试结果统计
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0,
            errors: []
        };

        // 调用Tauri命令的包装函数
        async function invokeCommand(command, args = {}) {
            if (typeof window === 'undefined' || !window.__TAURI__) {
                throw new Error('Tauri环境不可用');
            }
            
            try {
                const result = await window.__TAURI__.invoke(command, args);
                return result;
            } catch (error) {
                throw new Error(`命令 ${command} 执行失败: ${error.message}`);
            }
        }

        // 测试函数
        async function runTest(testName, testFunction) {
            testResults.total++;
            updateProgress(testResults.passed + testResults.failed, testResults.total);
            updateStats(testResults.total, testResults.passed, testResults.failed);
            
            console.log(`🔧 执行测试: ${testName}`);
            
            try {
                await testFunction();
                testResults.passed++;
                console.log(`✅ ${testName} - 通过\n`);
            } catch (error) {
                testResults.failed++;
                testResults.errors.push({ test: testName, error: error.message });
                console.log(`❌ ${testName} - 失败: ${error.message}\n`);
            }
            
            updateProgress(testResults.passed + testResults.failed, testResults.total);
            updateStats(testResults.total, testResults.passed, testResults.failed);
        }

        // 各种测试函数
        async function testSystemStatus() {
            const status = await invokeCommand('get_system_status');
            if (!status || typeof status !== 'object') {
                throw new Error('系统状态返回格式错误');
            }
            console.log(`   系统健康状态: ${status.system_health || '未知'}`);
            console.log(`   活跃测试任务: ${status.active_test_tasks || 0}`);
        }

        async function testCreateBatch() {
            const batchId = await invokeCommand('create_test_batch_with_definitions', {
                batchInfo: testData.batchInfo,
                definitions: testData.definitions
            });
            
            if (!batchId || typeof batchId !== 'string') {
                throw new Error('批次创建失败，返回的批次ID无效');
            }
            
            console.log(`   成功创建批次: ${batchId}`);
            testData.createdBatchId = batchId;
        }

        async function testGetDefinitions() {
            const definitions = await invokeCommand('get_all_channel_definitions');
            if (!Array.isArray(definitions)) {
                throw new Error('获取通道定义失败，返回格式错误');
            }
            console.log(`   获取到 ${definitions.length} 个通道定义`);
        }

        async function testGetBatches() {
            const batches = await invokeCommand('get_all_batch_info');
            if (!Array.isArray(batches)) {
                throw new Error('获取批次信息失败，返回格式错误');
            }
            console.log(`   获取到 ${batches.length} 个测试批次`);
        }

        async function testCreateInstance() {
            if (!testData.createdBatchId) {
                throw new Error('没有可用的批次ID，无法创建测试实例');
            }
            
            const instance = await invokeCommand('create_test_instance', {
                definitionId: testData.definitions[0].id,
                batchId: testData.createdBatchId
            });
            
            if (!instance || !instance.instance_id) {
                throw new Error('测试实例创建失败');
            }
            
            console.log(`   成功创建测试实例: ${instance.instance_id}`);
            testData.createdInstanceId = instance.instance_id;
        }

        async function testManualTesting() {
            if (!testData.createdInstanceId) {
                throw new Error('没有可用的测试实例ID');
            }
            
            try {
                const value = await invokeCommand('read_channel_value_cmd', {
                    instance_id: testData.createdInstanceId,
                    plc_address: 'DB1.DBD0',
                    data_type: 'Float'
                });
                console.log(`   读取通道值成功: ${JSON.stringify(value)}`);
            } catch (error) {
                console.log(`   读取通道值: ${error.message}`);
            }
        }

        async function testReportGeneration() {
            try {
                const templates = await invokeCommand('get_report_templates');
                console.log(`   获取到 ${templates.length} 个报告模板`);
            } catch (error) {
                console.log(`   获取报告模板: ${error.message}`);
            }
        }

        // 主测试函数
        async function runQuickTest() {
            if (!checkTauriEnvironment()) {
                return;
            }

            // 重置测试结果
            testResults = { total: 0, passed: 0, failed: 0, errors: [] };
            updateStats(0, 0, 0);
            updateProgress(0, 0);
            
            document.getElementById('test-btn').disabled = true;
            console.log('🏭 开始执行FAT_TEST功能验证...\n');
            
            try {
                await runTest('系统状态检查', testSystemStatus);
                await runTest('创建测试批次', testCreateBatch);
                await runTest('获取通道定义', testGetDefinitions);
                await runTest('获取批次信息', testGetBatches);
                await runTest('创建测试实例', testCreateInstance);
                await runTest('手动测试功能', testManualTesting);
                await runTest('报告生成功能', testReportGeneration);
                
            } catch (error) {
                console.log(`❌ 测试执行失败: ${error.message}\n`);
            }
            
            // 输出测试结果
            console.log('='.repeat(60));
            console.log('🏭 FAT_TEST 功能验证结果');
            console.log('='.repeat(60));
            console.log(`总测试数: ${testResults.total}`);
            console.log(`通过: ${testResults.passed} ✅`);
            console.log(`失败: ${testResults.failed} ❌`);
            console.log(`成功率: ${((testResults.passed / testResults.total) * 100).toFixed(1)}%`);
            
            if (testResults.errors.length > 0) {
                console.log('\n失败的测试详情:');
                testResults.errors.forEach((error, index) => {
                    console.log(`${index + 1}. ${error.test}: ${error.error}`);
                });
            }
            
            console.log('\n' + '='.repeat(60));
            
            if (testResults.failed === 0) {
                console.log('🎉 所有测试通过！系统运行正常。');
            } else if (testResults.passed > testResults.failed) {
                console.log('⚠️  大部分测试通过，系统基本正常，但有部分功能需要检查。');
            } else {
                console.log('🚨 多个测试失败，系统可能存在问题，需要进一步调试。');
            }
            
            document.getElementById('test-btn').disabled = false;
        }
    </script>
</body>
</html> 