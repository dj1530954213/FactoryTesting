<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAT_TEST ç®€åŒ–åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            margin: 20px;
            background-color: #f0f2f5;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #1890ff;
        }
        .header h1 {
            color: #1890ff;
            margin: 0;
            font-size: 2.2em;
        }
        .header p {
            color: #666;
            margin: 10px 0 0 0;
            font-size: 1.1em;
        }
        .status-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #1890ff;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-connected { background-color: #52c41a; }
        .status-disconnected { background-color: #ff4d4f; }
        .status-unknown { background-color: #faad14; }
        .button-section {
            text-align: center;
            margin: 30px 0;
        }
        .btn {
            background-color: #1890ff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #40a9ff;
        }
        .btn:disabled {
            background-color: #d9d9d9;
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #6c757d;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        .console {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-fill {
            height: 100%;
            background-color: #1890ff;
            width: 0%;
            transition: width 0.3s ease;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #1890ff;
        }
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ­ FAT_TEST åŠŸèƒ½éªŒè¯</h1>
            <p>Rust + Angular + Tauri æŠ€æœ¯æ ˆé›†æˆæµ‹è¯•</p>
        </div>

        <div class="status-section">
            <h3>ğŸ”— è¿æ¥çŠ¶æ€</h3>
            <div id="connection-status">
                <span class="status-indicator status-unknown"></span>
                <span>æ­£åœ¨æ£€æµ‹Tauriç¯å¢ƒ...</span>
            </div>
        </div>

        <div class="button-section">
            <button class="btn" onclick="runQuickTest()" id="test-btn">
                ğŸš€ å¼€å§‹åŠŸèƒ½æµ‹è¯•
            </button>
            <button class="btn btn-secondary" onclick="clearConsole()">
                ğŸ—‘ï¸ æ¸…ç©ºæ§åˆ¶å°
            </button>
        </div>

        <div class="stats" id="stats" style="display: none;">
            <div class="stat-card">
                <div class="stat-number" id="total-tests">0</div>
                <div class="stat-label">æ€»æµ‹è¯•æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="passed-tests" style="color: #52c41a;">0</div>
                <div class="stat-label">é€šè¿‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="failed-tests" style="color: #ff4d4f;">0</div>
                <div class="stat-label">å¤±è´¥</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="success-rate">0%</div>
                <div class="stat-label">æˆåŠŸç‡</div>
            </div>
        </div>

        <div class="progress-bar" id="progress-container" style="display: none;">
            <div class="progress-fill" id="progress-fill"></div>
        </div>

        <h3>ğŸ“ æµ‹è¯•æ§åˆ¶å°</h3>
        <div class="console" id="console">
ç­‰å¾…å¼€å§‹æµ‹è¯•...

ä½¿ç”¨è¯´æ˜ï¼š
1. ç¡®ä¿Tauriåº”ç”¨å·²æ­£å¸¸å¯åŠ¨
2. ç‚¹å‡»"å¼€å§‹åŠŸèƒ½æµ‹è¯•"æŒ‰é’®
3. è§‚å¯Ÿæµ‹è¯•ç»“æœå’Œè¯¦ç»†æ—¥å¿—
4. æ£€æŸ¥ç»Ÿè®¡ä¿¡æ¯äº†è§£ç³»ç»ŸçŠ¶æ€

æµ‹è¯•å†…å®¹åŒ…æ‹¬ï¼š
âœ“ ç³»ç»ŸçŠ¶æ€æ£€æŸ¥
âœ“ Excelå¯¼å…¥åŠŸèƒ½
âœ“ æ‰¹æ¬¡åˆ›å»ºå’Œç®¡ç†
âœ“ é€šé“å®šä¹‰æ“ä½œ
âœ“ æµ‹è¯•å®ä¾‹åˆ›å»º
âœ“ æ‰‹åŠ¨æµ‹è¯•åŠŸèƒ½
âœ“ æŠ¥å‘Šç”ŸæˆåŠŸèƒ½
        </div>
    </div>

    <script>
        // æ§åˆ¶å°è¾“å‡ºç®¡ç†
        const consoleElement = document.getElementById('console');
        const originalConsoleLog = console.log;
        
        // é‡å†™console.logä»¥æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
        console.log = function(...args) {
            const message = args.join(' ');
            const timestamp = new Date().toLocaleTimeString();
            consoleElement.textContent += `[${timestamp}] ${message}\n`;
            consoleElement.scrollTop = consoleElement.scrollHeight;
            originalConsoleLog.apply(console, args);
        };

        function clearConsole() {
            consoleElement.textContent = 'æ§åˆ¶å°å·²æ¸…ç©º...\n';
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(connected, message = '') {
            const statusElement = document.getElementById('connection-status');
            const indicator = statusElement.querySelector('.status-indicator');
            const text = statusElement.querySelector('span:last-child');
            
            if (connected) {
                indicator.className = 'status-indicator status-connected';
                text.textContent = 'âœ… Tauriç¯å¢ƒè¿æ¥æ­£å¸¸' + (message ? ` - ${message}` : '');
            } else {
                indicator.className = 'status-indicator status-disconnected';
                text.textContent = 'âŒ Tauriç¯å¢ƒè¿æ¥å¤±è´¥' + (message ? ` - ${message}` : '');
            }
        }

        // æ›´æ–°æµ‹è¯•ç»Ÿè®¡
        function updateStats(total, passed, failed) {
            document.getElementById('stats').style.display = 'grid';
            document.getElementById('total-tests').textContent = total;
            document.getElementById('passed-tests').textContent = passed;
            document.getElementById('failed-tests').textContent = failed;
            
            const successRate = total > 0 ? ((passed / total) * 100).toFixed(1) : 0;
            document.getElementById('success-rate').textContent = successRate + '%';
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(current, total) {
            const progressContainer = document.getElementById('progress-container');
            const progressFill = document.getElementById('progress-fill');
            
            if (total > 0) {
                progressContainer.style.display = 'block';
                const percentage = (current / total) * 100;
                progressFill.style.width = percentage + '%';
            } else {
                progressContainer.style.display = 'none';
            }
        }

        // æ£€æŸ¥Tauriç¯å¢ƒ
        function checkTauriEnvironment() {
            const isTauriEnv = typeof window !== 'undefined' && window.__TAURI__;
            
            if (isTauriEnv) {
                updateConnectionStatus(true, 'ç¯å¢ƒæ£€æµ‹é€šè¿‡');
                document.getElementById('test-btn').disabled = false;
                console.log('âœ… Tauriç¯å¢ƒæ£€æµ‹æˆåŠŸï¼Œå¯ä»¥è¿›è¡ŒåŠŸèƒ½æµ‹è¯•');
                return true;
            } else {
                updateConnectionStatus(false, 'è¯·åœ¨Tauriåº”ç”¨ä¸­æ‰“å¼€');
                document.getElementById('test-btn').disabled = true;
                console.log('âŒ æœªæ£€æµ‹åˆ°Tauriç¯å¢ƒï¼Œè¯·åœ¨Tauriåº”ç”¨ä¸­æ‰“å¼€æ­¤é¡µé¢');
                return false;
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥ç¯å¢ƒ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ­ FAT_TEST åŠŸèƒ½éªŒè¯é¡µé¢åŠ è½½å®Œæˆ');
            checkTauriEnvironment();
        });

        // åµŒå…¥å¿«é€Ÿæµ‹è¯•è„šæœ¬
        // æ¨¡æ‹Ÿæµ‹è¯•æ•°æ®
        const testData = {
            batchInfo: {
                batch_id: `quick_test_${Date.now()}`,
                product_model: 'å¿«é€Ÿæµ‹è¯•äº§å“',
                serial_number: `QT${Date.now()}`,
                customer_name: 'æµ‹è¯•å®¢æˆ·',
                operator_name: 'è‡ªåŠ¨æµ‹è¯•',
                creation_time: new Date().toISOString(),
                status: 'Created'
            },
            definitions: [
                {
                    id: `def_${Date.now()}_1`,
                    tag: 'AI001',
                    variable_description: 'æ¨¡æ‹Ÿè¾“å…¥ç‚¹1',
                    station_name: 'æµ‹è¯•ç«™1',
                    module_name: 'æ¨¡æ‹Ÿæ¨¡å—',
                    module_type: 'AI',
                    channel_number: 'CH01',
                    data_type: 'Float',
                    plc_communication_address: 'DB1.DBD0',
                    analog_range_min: 0.0,
                    analog_range_max: 100.0
                },
                {
                    id: `def_${Date.now()}_2`,
                    tag: 'DI001',
                    variable_description: 'æ•°å­—è¾“å…¥ç‚¹1',
                    station_name: 'æµ‹è¯•ç«™1',
                    module_name: 'æ¨¡æ‹Ÿæ¨¡å—',
                    module_type: 'DI',
                    channel_number: 'CH02',
                    data_type: 'Bool',
                    plc_communication_address: 'DB1.DBX0.0'
                }
            ]
        };

        // æµ‹è¯•ç»“æœç»Ÿè®¡
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0,
            errors: []
        };

        // è°ƒç”¨Tauriå‘½ä»¤çš„åŒ…è£…å‡½æ•°
        async function invokeCommand(command, args = {}) {
            if (typeof window === 'undefined' || !window.__TAURI__) {
                throw new Error('Tauriç¯å¢ƒä¸å¯ç”¨');
            }
            
            try {
                const result = await window.__TAURI__.invoke(command, args);
                return result;
            } catch (error) {
                throw new Error(`å‘½ä»¤ ${command} æ‰§è¡Œå¤±è´¥: ${error.message}`);
            }
        }

        // æµ‹è¯•å‡½æ•°
        async function runTest(testName, testFunction) {
            testResults.total++;
            updateProgress(testResults.passed + testResults.failed, testResults.total);
            updateStats(testResults.total, testResults.passed, testResults.failed);
            
            console.log(`ğŸ”§ æ‰§è¡Œæµ‹è¯•: ${testName}`);
            
            try {
                await testFunction();
                testResults.passed++;
                console.log(`âœ… ${testName} - é€šè¿‡\n`);
            } catch (error) {
                testResults.failed++;
                testResults.errors.push({ test: testName, error: error.message });
                console.log(`âŒ ${testName} - å¤±è´¥: ${error.message}\n`);
            }
            
            updateProgress(testResults.passed + testResults.failed, testResults.total);
            updateStats(testResults.total, testResults.passed, testResults.failed);
        }

        // å„ç§æµ‹è¯•å‡½æ•°
        async function testSystemStatus() {
            const status = await invokeCommand('get_system_status');
            if (!status || typeof status !== 'object') {
                throw new Error('ç³»ç»ŸçŠ¶æ€è¿”å›æ ¼å¼é”™è¯¯');
            }
            console.log(`   ç³»ç»Ÿå¥åº·çŠ¶æ€: ${status.system_health || 'æœªçŸ¥'}`);
            console.log(`   æ´»è·ƒæµ‹è¯•ä»»åŠ¡: ${status.active_test_tasks || 0}`);
        }

        async function testCreateBatch() {
            const batchId = await invokeCommand('create_test_batch_with_definitions', {
                batchInfo: testData.batchInfo,
                definitions: testData.definitions
            });
            
            if (!batchId || typeof batchId !== 'string') {
                throw new Error('æ‰¹æ¬¡åˆ›å»ºå¤±è´¥ï¼Œè¿”å›çš„æ‰¹æ¬¡IDæ— æ•ˆ');
            }
            
            console.log(`   æˆåŠŸåˆ›å»ºæ‰¹æ¬¡: ${batchId}`);
            testData.createdBatchId = batchId;
        }

        async function testGetDefinitions() {
            const definitions = await invokeCommand('get_all_channel_definitions');
            if (!Array.isArray(definitions)) {
                throw new Error('è·å–é€šé“å®šä¹‰å¤±è´¥ï¼Œè¿”å›æ ¼å¼é”™è¯¯');
            }
            console.log(`   è·å–åˆ° ${definitions.length} ä¸ªé€šé“å®šä¹‰`);
        }

        async function testGetBatches() {
            const batches = await invokeCommand('get_all_batch_info');
            if (!Array.isArray(batches)) {
                throw new Error('è·å–æ‰¹æ¬¡ä¿¡æ¯å¤±è´¥ï¼Œè¿”å›æ ¼å¼é”™è¯¯');
            }
            console.log(`   è·å–åˆ° ${batches.length} ä¸ªæµ‹è¯•æ‰¹æ¬¡`);
        }

        async function testCreateInstance() {
            if (!testData.createdBatchId) {
                throw new Error('æ²¡æœ‰å¯ç”¨çš„æ‰¹æ¬¡IDï¼Œæ— æ³•åˆ›å»ºæµ‹è¯•å®ä¾‹');
            }
            
            const instance = await invokeCommand('create_test_instance', {
                definitionId: testData.definitions[0].id,
                batchId: testData.createdBatchId
            });
            
            if (!instance || !instance.instance_id) {
                throw new Error('æµ‹è¯•å®ä¾‹åˆ›å»ºå¤±è´¥');
            }
            
            console.log(`   æˆåŠŸåˆ›å»ºæµ‹è¯•å®ä¾‹: ${instance.instance_id}`);
            testData.createdInstanceId = instance.instance_id;
        }

        async function testManualTesting() {
            if (!testData.createdInstanceId) {
                throw new Error('æ²¡æœ‰å¯ç”¨çš„æµ‹è¯•å®ä¾‹ID');
            }
            
            try {
                const value = await invokeCommand('read_channel_value_cmd', {
                    instance_id: testData.createdInstanceId,
                    plc_address: 'DB1.DBD0',
                    data_type: 'Float'
                });
                console.log(`   è¯»å–é€šé“å€¼æˆåŠŸ: ${JSON.stringify(value)}`);
            } catch (error) {
                console.log(`   è¯»å–é€šé“å€¼: ${error.message}`);
            }
        }

        async function testReportGeneration() {
            try {
                const templates = await invokeCommand('get_report_templates');
                console.log(`   è·å–åˆ° ${templates.length} ä¸ªæŠ¥å‘Šæ¨¡æ¿`);
            } catch (error) {
                console.log(`   è·å–æŠ¥å‘Šæ¨¡æ¿: ${error.message}`);
            }
        }

        // ä¸»æµ‹è¯•å‡½æ•°
        async function runQuickTest() {
            if (!checkTauriEnvironment()) {
                return;
            }

            // é‡ç½®æµ‹è¯•ç»“æœ
            testResults = { total: 0, passed: 0, failed: 0, errors: [] };
            updateStats(0, 0, 0);
            updateProgress(0, 0);
            
            document.getElementById('test-btn').disabled = true;
            console.log('ğŸ­ å¼€å§‹æ‰§è¡ŒFAT_TESTåŠŸèƒ½éªŒè¯...\n');
            
            try {
                await runTest('ç³»ç»ŸçŠ¶æ€æ£€æŸ¥', testSystemStatus);
                await runTest('åˆ›å»ºæµ‹è¯•æ‰¹æ¬¡', testCreateBatch);
                await runTest('è·å–é€šé“å®šä¹‰', testGetDefinitions);
                await runTest('è·å–æ‰¹æ¬¡ä¿¡æ¯', testGetBatches);
                await runTest('åˆ›å»ºæµ‹è¯•å®ä¾‹', testCreateInstance);
                await runTest('æ‰‹åŠ¨æµ‹è¯•åŠŸèƒ½', testManualTesting);
                await runTest('æŠ¥å‘Šç”ŸæˆåŠŸèƒ½', testReportGeneration);
                
            } catch (error) {
                console.log(`âŒ æµ‹è¯•æ‰§è¡Œå¤±è´¥: ${error.message}\n`);
            }
            
            // è¾“å‡ºæµ‹è¯•ç»“æœ
            console.log('='.repeat(60));
            console.log('ğŸ­ FAT_TEST åŠŸèƒ½éªŒè¯ç»“æœ');
            console.log('='.repeat(60));
            console.log(`æ€»æµ‹è¯•æ•°: ${testResults.total}`);
            console.log(`é€šè¿‡: ${testResults.passed} âœ…`);
            console.log(`å¤±è´¥: ${testResults.failed} âŒ`);
            console.log(`æˆåŠŸç‡: ${((testResults.passed / testResults.total) * 100).toFixed(1)}%`);
            
            if (testResults.errors.length > 0) {
                console.log('\nå¤±è´¥çš„æµ‹è¯•è¯¦æƒ…:');
                testResults.errors.forEach((error, index) => {
                    console.log(`${index + 1}. ${error.test}: ${error.error}`);
                });
            }
            
            console.log('\n' + '='.repeat(60));
            
            if (testResults.failed === 0) {
                console.log('ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ç³»ç»Ÿè¿è¡Œæ­£å¸¸ã€‚');
            } else if (testResults.passed > testResults.failed) {
                console.log('âš ï¸  å¤§éƒ¨åˆ†æµ‹è¯•é€šè¿‡ï¼Œç³»ç»ŸåŸºæœ¬æ­£å¸¸ï¼Œä½†æœ‰éƒ¨åˆ†åŠŸèƒ½éœ€è¦æ£€æŸ¥ã€‚');
            } else {
                console.log('ğŸš¨ å¤šä¸ªæµ‹è¯•å¤±è´¥ï¼Œç³»ç»Ÿå¯èƒ½å­˜åœ¨é—®é¢˜ï¼Œéœ€è¦è¿›ä¸€æ­¥è°ƒè¯•ã€‚');
            }
            
            document.getElementById('test-btn').disabled = false;
        }
    </script>
</body>
</html> 