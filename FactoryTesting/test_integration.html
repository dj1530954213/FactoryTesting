<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>前后端集成测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button {
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 3px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>FAT_TEST 前后端集成测试</h1>
    
    <div class="test-section">
        <h2>1. 系统状态测试</h2>
        <button onclick="testSystemStatus()">获取系统状态</button>
        <div id="systemStatusResult"></div>
    </div>

    <div class="test-section">
        <h2>2. 测试执行流程测试</h2>
        <button onclick="testExecutionFlow()">创建并提交测试批次</button>
        <button onclick="startBatchTest()">开始批次测试</button>
        <button onclick="getBatchProgress()">获取测试进度</button>
        <button onclick="getBatchResults()">获取测试结果</button>
        <div id="executionFlowResult"></div>
    </div>

    <div class="test-section">
        <h2>3. 数据管理测试</h2>
        <button onclick="testDataManagement()">测试数据管理功能</button>
        <div id="dataManagementResult"></div>
    </div>

    <div class="test-section">
        <h2>测试日志</h2>
        <div id="testLog"></div>
    </div>

    <script>
        let currentBatchId = null;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function testSystemStatus() {
            try {
                log('正在获取系统状态...');
                
                // 检查是否在Tauri环境中
                if (typeof window.__TAURI__ === 'undefined') {
                    throw new Error('不在Tauri环境中，请在Tauri应用中运行此测试');
                }

                const { invoke } = window.__TAURI__.core;
                const status = await invoke('get_system_status');
                
                document.getElementById('systemStatusResult').innerHTML = `
                    <div class="success">✓ 系统状态获取成功</div>
                    <pre>${JSON.stringify(status, null, 2)}</pre>
                `;
                log('系统状态获取成功', 'success');
            } catch (error) {
                const errorMsg = `系统状态获取失败: ${error}`;
                document.getElementById('systemStatusResult').innerHTML = `<div class="error">✗ ${errorMsg}</div>`;
                log(errorMsg, 'error');
            }
        }

        async function testExecutionFlow() {
            try {
                log('正在创建测试批次...');
                
                const { invoke } = window.__TAURI__.core;
                
                // 创建示例通道定义
                const sampleDefinitions = [
                    {
                        id: 'def_001',
                        tag: 'AI001',
                        variable_name: 'Temperature_1',
                        description: '温度传感器1',
                        station_name: 'Station1',
                        module_name: 'Module1',
                        module_type: 'AI',
                        channel_number: 'CH01',
                        point_data_type: 'Float',
                        plc_communication_address: 'DB1.DBD0',
                        analog_range_min: 0,
                        analog_range_max: 100,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    },
                    {
                        id: 'def_002',
                        tag: 'DI001',
                        variable_name: 'Switch_1',
                        description: '开关状态1',
                        station_name: 'Station1',
                        module_name: 'Module2',
                        module_type: 'DI',
                        channel_number: 'CH01',
                        point_data_type: 'Bool',
                        plc_communication_address: 'I0.0',
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    }
                ];

                // 创建批次信息
                const batchInfo = {
                    batch_id: 'batch_' + Date.now(),
                    product_model: 'TestProduct_V1.0',
                    serial_number: 'SN' + Date.now(),
                    operator_name: '测试操作员',
                    total_points: sampleDefinitions.length,
                    passed_points: 0,
                    failed_points: 0,
                    overall_status: 'NotTested',
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };

                // 创建测试执行请求
                const request = {
                    batch_info: batchInfo,
                    channel_definitions: sampleDefinitions,
                    max_concurrent_tests: 3,
                    auto_start: false
                };

                const response = await invoke('submit_test_execution', { request });
                currentBatchId = response.batch_id;
                
                document.getElementById('executionFlowResult').innerHTML = `
                    <div class="success">✓ 测试批次创建成功</div>
                    <pre>${JSON.stringify(response, null, 2)}</pre>
                `;
                log(`测试批次创建成功: ${response.batch_id}`, 'success');
            } catch (error) {
                const errorMsg = `测试批次创建失败: ${error}`;
                document.getElementById('executionFlowResult').innerHTML = `<div class="error">✗ ${errorMsg}</div>`;
                log(errorMsg, 'error');
            }
        }

        async function startBatchTest() {
            if (!currentBatchId) {
                log('请先创建测试批次', 'error');
                return;
            }

            try {
                log('正在开始批次测试...');
                
                const { invoke } = window.__TAURI__.core;
                await invoke('start_batch_testing', { batchId: currentBatchId });
                
                log('批次测试已开始', 'success');
            } catch (error) {
                log(`开始批次测试失败: ${error}`, 'error');
            }
        }

        async function getBatchProgress() {
            if (!currentBatchId) {
                log('请先创建测试批次', 'error');
                return;
            }

            try {
                log('正在获取测试进度...');
                
                const { invoke } = window.__TAURI__.core;
                const progress = await invoke('get_batch_progress', { batchId: currentBatchId });
                
                document.getElementById('executionFlowResult').innerHTML += `
                    <div class="success">✓ 测试进度获取成功</div>
                    <pre>${JSON.stringify(progress, null, 2)}</pre>
                `;
                log('测试进度获取成功', 'success');
            } catch (error) {
                log(`获取测试进度失败: ${error}`, 'error');
            }
        }

        async function getBatchResults() {
            if (!currentBatchId) {
                log('请先创建测试批次', 'error');
                return;
            }

            try {
                log('正在获取测试结果...');
                
                const { invoke } = window.__TAURI__.core;
                const results = await invoke('get_batch_results', { batchId: currentBatchId });
                
                document.getElementById('executionFlowResult').innerHTML += `
                    <div class="success">✓ 测试结果获取成功</div>
                    <pre>${JSON.stringify(results, null, 2)}</pre>
                `;
                log('测试结果获取成功', 'success');
            } catch (error) {
                log(`获取测试结果失败: ${error}`, 'error');
            }
        }

        async function testDataManagement() {
            try {
                log('正在测试数据管理功能...');
                
                const { invoke } = window.__TAURI__.core;
                
                // 测试获取所有通道定义
                const definitions = await invoke('get_all_channel_definitions');
                
                // 测试获取所有批次信息
                const batches = await invoke('get_all_batch_info');
                
                document.getElementById('dataManagementResult').innerHTML = `
                    <div class="success">✓ 数据管理功能测试成功</div>
                    <p>通道定义数量: ${definitions.length}</p>
                    <p>批次数量: ${batches.length}</p>
                    <pre>通道定义: ${JSON.stringify(definitions.slice(0, 2), null, 2)}</pre>
                    <pre>批次信息: ${JSON.stringify(batches.slice(0, 2), null, 2)}</pre>
                `;
                log('数据管理功能测试成功', 'success');
            } catch (error) {
                const errorMsg = `数据管理功能测试失败: ${error}`;
                document.getElementById('dataManagementResult').innerHTML = `<div class="error">✗ ${errorMsg}</div>`;
                log(errorMsg, 'error');
            }
        }

        // 页面加载时的初始化
        window.addEventListener('load', () => {
            log('前后端集成测试页面已加载');
            if (typeof window.__TAURI__ === 'undefined') {
                log('警告: 不在Tauri环境中，某些功能可能无法正常工作', 'error');
            } else {
                log('检测到Tauri环境，可以进行完整测试', 'success');
            }
        });
    </script>
</body>
</html> 