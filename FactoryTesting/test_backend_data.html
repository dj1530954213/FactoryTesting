<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•PLCé…ç½®æ•°æ®éªŒè¯</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            color: #1890ff;
            border-bottom: 2px solid #1890ff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success {
            background-color: #f6ffed;
            border-color: #52c41a;
        }
        .error {
            background-color: #fff2f0;
            border-color: #ff4d4f;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .data-table th {
            background-color: #fafafa;
            font-weight: bold;
        }
        button {
            background-color: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #40a9ff;
        }
        .loading {
            color: #1890ff;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="header">ğŸ” æµ‹è¯•PLCé…ç½®æ•°æ®éªŒè¯å·¥å…·</h1>
        
        <div class="test-section">
            <h3>ğŸ“Š æ•°æ®è·å–æµ‹è¯•</h3>
            <button onclick="testGetChannels()">è·å–æµ‹è¯•PLCé€šé“é…ç½®</button>
            <button onclick="testGetConnections()">è·å–PLCè¿æ¥é…ç½®</button>
            <button onclick="initializeDefaultData()">åˆå§‹åŒ–é»˜è®¤æ•°æ®</button>
            <div id="test-results"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ æ•°æ®æ˜¾ç¤º</h3>
            <div id="data-display"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ”§ è°ƒè¯•ä¿¡æ¯</h3>
            <div id="debug-info"></div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹ŸTauri APIè°ƒç”¨ï¼ˆç”¨äºæµ‹è¯•ï¼‰
        const mockTauriInvoke = async (command, args = {}) => {
            console.log(`ğŸ”§ æ¨¡æ‹Ÿè°ƒç”¨: ${command}`, args);
            
            // æ¨¡æ‹Ÿæ•°æ®
            if (command === 'get_test_plc_channels_cmd') {
                return [
                    {
                        id: "1",
                        channelAddress: "AI1_1",
                        channelType: 0,
                        communicationAddress: "40101",
                        powerSupplyType: "24V DC",
                        description: "æ¨¡æ‹Ÿé‡è¾“å…¥é€šé“ 1",
                        isEnabled: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: "2",
                        channelAddress: "AI1_2", 
                        channelType: 0,
                        communicationAddress: "40103",
                        powerSupplyType: "24V DC",
                        description: "æ¨¡æ‹Ÿé‡è¾“å…¥é€šé“ 2",
                        isEnabled: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];
            }
            
            if (command === 'get_plc_connections_cmd') {
                return [
                    {
                        id: "conn1",
                        name: "æµ‹è¯•PLCè¿æ¥",
                        plcType: "ModbusTcp",
                        ipAddress: "192.168.1.100",
                        port: 502,
                        timeout: 5000,
                        retryCount: 3,
                        isTestPlc: true,
                        description: "ä¸»æµ‹è¯•PLCè¿æ¥",
                        isEnabled: true,
                        connectionStatus: "Disconnected"
                    }
                ];
            }
            
            if (command === 'initialize_default_test_plc_channels_cmd') {
                return null; // æˆåŠŸè¿”å›
            }
            
            throw new Error(`æœªçŸ¥å‘½ä»¤: ${command}`);
        };

        // æ£€æŸ¥æ˜¯å¦åœ¨Tauriç¯å¢ƒä¸­
        const isInTauri = typeof window.__TAURI__ !== 'undefined';
        const invoke = isInTauri ? window.__TAURI__.invoke : mockTauriInvoke;

        function updateResults(elementId, content, isSuccess = true) {
            const element = document.getElementById(elementId);
            element.innerHTML = content;
            element.className = `test-section ${isSuccess ? 'success' : 'error'}`;
        }

        function updateDebug(message) {
            const debugElement = document.getElementById('debug-info');
            const timestamp = new Date().toLocaleTimeString();
            debugElement.innerHTML += `<div>[${timestamp}] ${message}</div>`;
        }

        async function testGetChannels() {
            updateResults('test-results', '<div class="loading">æ­£åœ¨è·å–æµ‹è¯•PLCé€šé“é…ç½®...</div>');
            updateDebug('å¼€å§‹è·å–æµ‹è¯•PLCé€šé“é…ç½®');
            
            try {
                const channels = await invoke('get_test_plc_channels_cmd', {
                    channelTypeFilter: null,
                    enabledOnly: null
                });
                
                updateDebug(`æˆåŠŸè·å– ${channels.length} ä¸ªé€šé“é…ç½®`);
                
                let tableHtml = `
                    <h4>âœ… æˆåŠŸè·å– ${channels.length} ä¸ªæµ‹è¯•PLCé€šé“é…ç½®</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>é€šé“ä½å·</th>
                                <th>é€šé“ç±»å‹</th>
                                <th>é€šè®¯åœ°å€</th>
                                <th>ä¾›ç”µç±»å‹</th>
                                <th>æè¿°</th>
                                <th>çŠ¶æ€</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                channels.forEach(channel => {
                    const typeLabels = {
                        0: 'AI', 1: 'AO', 2: 'DI', 3: 'DO',
                        4: 'AIæ— æº', 5: 'AOæ— æº', 6: 'DIæ— æº', 7: 'DOæ— æº'
                    };
                    
                    tableHtml += `
                        <tr>
                            <td>${channel.channelAddress || 'âŒ ç©º'}</td>
                            <td>${typeLabels[channel.channelType] || channel.channelType}</td>
                            <td>${channel.communicationAddress || 'âŒ ç©º'}</td>
                            <td>${channel.powerSupplyType || 'âŒ ç©º'}</td>
                            <td>${channel.description || '-'}</td>
                            <td>${channel.isEnabled ? 'âœ… å¯ç”¨' : 'âŒ ç¦ç”¨'}</td>
                        </tr>
                    `;
                });
                
                tableHtml += '</tbody></table>';
                updateResults('test-results', tableHtml, true);
                
                // æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
                const emptyChannelAddress = channels.filter(c => !c.channelAddress).length;
                const emptyCommunicationAddress = channels.filter(c => !c.communicationAddress).length;
                
                if (emptyChannelAddress > 0 || emptyCommunicationAddress > 0) {
                    updateDebug(`âš ï¸ æ•°æ®å®Œæ•´æ€§é—®é¢˜: ${emptyChannelAddress} ä¸ªç©ºé€šé“ä½å·, ${emptyCommunicationAddress} ä¸ªç©ºé€šè®¯åœ°å€`);
                } else {
                    updateDebug('âœ… æ•°æ®å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡');
                }
                
            } catch (error) {
                updateDebug(`âŒ è·å–é€šé“é…ç½®å¤±è´¥: ${error.message}`);
                updateResults('test-results', `<h4>âŒ è·å–å¤±è´¥</h4><p>é”™è¯¯: ${error.message}</p>`, false);
            }
        }

        async function testGetConnections() {
            updateResults('test-results', '<div class="loading">æ­£åœ¨è·å–PLCè¿æ¥é…ç½®...</div>');
            updateDebug('å¼€å§‹è·å–PLCè¿æ¥é…ç½®');
            
            try {
                const connections = await invoke('get_plc_connections_cmd');
                
                updateDebug(`æˆåŠŸè·å– ${connections.length} ä¸ªè¿æ¥é…ç½®`);
                
                let tableHtml = `
                    <h4>âœ… æˆåŠŸè·å– ${connections.length} ä¸ªPLCè¿æ¥é…ç½®</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>è¿æ¥åç§°</th>
                                <th>PLCç±»å‹</th>
                                <th>IPåœ°å€</th>
                                <th>ç«¯å£</th>
                                <th>ç”¨é€”</th>
                                <th>çŠ¶æ€</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                connections.forEach(conn => {
                    tableHtml += `
                        <tr>
                            <td>${conn.name}</td>
                            <td>${conn.plcType}</td>
                            <td>${conn.ipAddress}</td>
                            <td>${conn.port}</td>
                            <td>${conn.isTestPlc ? 'æµ‹è¯•PLC' : 'è¢«æµ‹PLC'}</td>
                            <td>${conn.connectionStatus}</td>
                        </tr>
                    `;
                });
                
                tableHtml += '</tbody></table>';
                updateResults('test-results', tableHtml, true);
                
            } catch (error) {
                updateDebug(`âŒ è·å–è¿æ¥é…ç½®å¤±è´¥: ${error.message}`);
                updateResults('test-results', `<h4>âŒ è·å–å¤±è´¥</h4><p>é”™è¯¯: ${error.message}</p>`, false);
            }
        }

        async function initializeDefaultData() {
            updateResults('test-results', '<div class="loading">æ­£åœ¨åˆå§‹åŒ–é»˜è®¤æ•°æ®...</div>');
            updateDebug('å¼€å§‹åˆå§‹åŒ–é»˜è®¤æ•°æ®');
            
            try {
                await invoke('initialize_default_test_plc_channels_cmd');
                updateDebug('âœ… é»˜è®¤æ•°æ®åˆå§‹åŒ–æˆåŠŸ');
                updateResults('test-results', '<h4>âœ… é»˜è®¤æ•°æ®åˆå§‹åŒ–æˆåŠŸ</h4><p>88ä¸ªæµ‹è¯•PLCé€šé“é…ç½®å·²åˆ›å»º</p>', true);
                
                // è‡ªåŠ¨è·å–æ•°æ®éªŒè¯
                setTimeout(() => {
                    testGetChannels();
                }, 1000);
                
            } catch (error) {
                updateDebug(`âŒ åˆå§‹åŒ–é»˜è®¤æ•°æ®å¤±è´¥: ${error.message}`);
                updateResults('test-results', `<h4>âŒ åˆå§‹åŒ–å¤±è´¥</h4><p>é”™è¯¯: ${error.message}</p>`, false);
            }
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = function() {
            updateDebug(`ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼ŒTauriç¯å¢ƒ: ${isInTauri ? 'æ˜¯' : 'å¦ï¼ˆä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼‰'}`);
            
            if (isInTauri) {
                updateDebug('ğŸ”— æ£€æµ‹åˆ°Tauriç¯å¢ƒï¼Œå°†ä½¿ç”¨çœŸå®åç«¯API');
                // è‡ªåŠ¨æµ‹è¯•è·å–æ•°æ®
                setTimeout(() => {
                    testGetChannels();
                }, 500);
            } else {
                updateDebug('ğŸ”§ æœªæ£€æµ‹åˆ°Tauriç¯å¢ƒï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®è¿›è¡Œæµ‹è¯•');
                // æ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®
                setTimeout(() => {
                    testGetChannels();
                }, 500);
            }
        };
    </script>
</body>
</html> 